<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Ercan Akyürek</title><link>https://ercanakyuerek.de/posts/</link><description>Recent content in Posts on Ercan Akyürek</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Thu, 27 Nov 2025 12:35:00 +0100</lastBuildDate><atom:link href="https://ercanakyuerek.de/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Writing a Roller Coaster Simulation – Evaluating Motion</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-3/</link><pubDate>Thu, 27 Nov 2025 12:35:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-3/</guid><description>&lt;h2 id="evaluating-motion">Evaluating Motion&lt;/h2>
&lt;p>Before we implement the function, there&amp;rsquo;s one small simplification we need to mention:
In this chapter we will always evaluate the motion every &lt;strong>16 ms (0.016 seconds)&lt;/strong>,
which corresponds to roughly &lt;strong>60 frames per second&lt;/strong>.&lt;/p>
&lt;p>Using a fixed time step makes the formulas easier to understand for this article.&lt;/p>
&lt;p>In real simulations or game engines, you usually don’t assume a constant value. Instead, you take the actual delta time from the game loop, so that the motion stays consistent even if the frame rate changes.&lt;/p></description><content type="html"><![CDATA[<h2 id="evaluating-motion">Evaluating Motion</h2>
<p>Before we implement the function, there&rsquo;s one small simplification we need to mention:
In this chapter we will always evaluate the motion every <strong>16 ms (0.016 seconds)</strong>,
which corresponds to roughly <strong>60 frames per second</strong>.</p>
<p>Using a fixed time step makes the formulas easier to understand for this article.</p>
<p>In real simulations or game engines, you usually don’t assume a constant value. Instead, you take the actual delta time from the game loop, so that the motion stays consistent even if the frame rate changes.</p>
<p>But for the sake of clarity in this chapter:
We assume that every update happens exactly every <strong>16 ms</strong>.
This keeps the examples simple and lets us focus on the physics first.</p>
<p>Now that we know how acceleration works and how gravity affects the coaster depending on the slope, we can finally build the first real part of our simulation. The idea is simple. Every small time step we calculate how much the coaster changes its speed and how much distance it travels.</p>
<p>We start with a minimal simulation state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">simulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">velocity</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">distanceTraveled</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>At the beginning the coaster does not move and has not travelled any distance.</p>
<h2 id="the-evaluatemotion-function">The evaluateMotion function</h2>
<p>Our simulation works by creating a new state based on the previous state.
Think of it like this:</p>
<blockquote>
<p>initial state → evaluate → new state → evaluate → new state → &hellip;</p>
</blockquote>
<p>To calculate the acceleration along the slope, we now implement the downhill-slope acceleration formula from <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-2/">Chapter 2</a>. This formula tells us how much of gravity actually acts in the direction of the slope:</p>
<blockquote>
<p>acceleration = gravity * sin(slopeAngle)</p>
</blockquote>
<p>So we end up basically with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">slopeAngle</span>, <span style="color:#a6e22e">gravity</span>, <span style="color:#a6e22e">deltaTime</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slopeAngle</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>slopeAngle controls how steep the slope is</li>
<li>deltaTime is how much time passed since the last calculation (we use 16 ms)</li>
</ul>
<h2 id="calculating-the-velocity">Calculating the velocity</h2>
<p>Acceleration is measured in <strong>m/s²</strong>.
That means:</p>
<blockquote>
<p><strong>m/s²</strong> tells us how much the velocity changes in one <strong>full second</strong>.</p>
</blockquote>
<p>So if acceleration is <strong>9.81 m/s²</strong>:</p>
<ul>
<li>after <strong>1 second</strong>, velocity increases by <strong>9.81 m/s</strong></li>
<li>so after <strong>0.016 seconds</strong>, velocity increases by <strong>9.81 × 0.016</strong><br>
Just multiply it with <strong>0.016</strong> :) that does the trick</li>
</ul>
<blockquote>
<p>velocity = acceleration × deltaTime</p>
</blockquote>
<p>We take the previous velocity and add the small increase for this frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>
</span></span></code></pre></div><h2 id="calculating-the-distance-traveled">Calculating the distance traveled</h2>
<p>Velocity is measured in <strong>m/s</strong>.
This means:</p>
<blockquote>
<p>velocity tells us how much <strong>distance</strong> is to travel in <strong>one full second</strong>.</p>
</blockquote>
<p>Again we only want the part that matches our <strong>0.016 seconds</strong>.</p>
<blockquote>
<p>distanceToTravel = velocity × deltaTime</p>
</blockquote>
<p>We take the previous distance traveled and add the small increase for this frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>
</span></span></code></pre></div><p>So we end up with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">slopeAngle</span>, <span style="color:#a6e22e">gravity</span>, <span style="color:#a6e22e">deltaTime</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slopeAngle</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span> }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is already a complete physics step without friction or air resistance.</p>
<h2 id="running-the-simulation">Running the simulation</h2>
<p>Now we run the simulation every 16 ms and log the values.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> { <span style="color:#a6e22e">velocity</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">distanceTraveled</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0</span> }
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">9.81</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">tickInterval</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.016</span>; <span style="color:#75715e">// 16ms
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">slopeAngle</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> (Math.<span style="color:#a6e22e">PI</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">180</span>); <span style="color:#75715e">// 10°, needs to be in radians
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">setInterval</span>(() =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">slopeAngle</span>, <span style="color:#a6e22e">gravity</span>, <span style="color:#a6e22e">tickInterval</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;velocity:&#34;</span>, <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>.<span style="color:#a6e22e">toFixed</span>(<span style="color:#ae81ff">3</span>), <span style="color:#e6db74">&#34;m/s&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>(<span style="color:#e6db74">&#34;distance:&#34;</span>, <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span>.<span style="color:#a6e22e">toFixed</span>(<span style="color:#ae81ff">3</span>), <span style="color:#e6db74">&#34;m&#34;</span>)
</span></span><span style="display:flex;"><span>}, <span style="color:#a6e22e">tickInterval</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1000</span>)
</span></span></code></pre></div><p>If you now watch your console log, you will see the distance increasing correctly based on the slope and the physics we evaluated. It is a simple loop but it already simulates motion in a physically meaningful way.</p>
<h2 id="next-chapter">Next Chapter</h2>
<p>In the next chapter we will build an interactive Three.js demo where we can adjust the slopeAngle and watch how an object moves along a plane. Nothing complicated, just a small visual setup so we can actually see what the simulation looks like in action.</p>
]]></content></item><item><title>Writing a Roller Coaster Simulation – Determining Acceleration</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-2/</link><pubDate>Wed, 26 Nov 2025 12:35:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-2/</guid><description>&lt;h2 id="how-do-we-determine-the-acceleration-of-the-coaster">How do we determine the acceleration of the coaster?&lt;/h2>
&lt;p>To simplify things, we ignore air resistance, rolling friction and any other additional forces. We also assume Earth’s gravity is &lt;strong>9.81 m/s²&lt;/strong>. This allows us to focus entirely on the fundamental idea:&lt;/p>
&lt;blockquote>
&lt;p>&lt;strong>Gravity is the primary source of acceleration.&lt;/strong>&lt;/p>
&lt;/blockquote>
&lt;p>On Earth, gravity provides a constant acceleration of &lt;strong>9.81 m/s²&lt;/strong>.&lt;/p>
&lt;p>What does this number actually mean?&lt;/p>
&lt;blockquote>
&lt;p>Every &lt;strong>second&lt;/strong>, an object&amp;rsquo;s speed increases by &lt;strong>9.81 m/s&lt;/strong>.&lt;/p></description><content type="html"><![CDATA[<h2 id="how-do-we-determine-the-acceleration-of-the-coaster">How do we determine the acceleration of the coaster?</h2>
<p>To simplify things, we ignore air resistance, rolling friction and any other additional forces. We also assume Earth’s gravity is <strong>9.81 m/s²</strong>. This allows us to focus entirely on the fundamental idea:</p>
<blockquote>
<p><strong>Gravity is the primary source of acceleration.</strong></p>
</blockquote>
<p>On Earth, gravity provides a constant acceleration of <strong>9.81 m/s²</strong>.</p>
<p>What does this number actually mean?</p>
<blockquote>
<p>Every <strong>second</strong>, an object&rsquo;s speed increases by <strong>9.81 m/s</strong>.</p>
</blockquote>
<p>Some quick examples:</p>
<ul>
<li>after <strong>1 second</strong> → 9.81 m/s</li>
<li>after <strong>2 seconds</strong> → 19.62 m/s</li>
<li>after <strong>3 seconds</strong> → 29.43 m/s</li>
</ul>
<p>In short: <strong>acceleration continuously increases an object&rsquo;s speed.</strong></p>
<hr>
<h2 id="acceleration-on-slopes">Acceleration on slopes</h2>
<p>Gravity is always pointing straight down.<br>
But on a slope, only a part of that force helps the coaster move along the track.</p>
<p>To compute that portion, we use the <strong>downhill-slope acceleration</strong>:</p>
<blockquote>
<p><strong>acceleration = g × sin(angle)</strong></p>
</blockquote>
<p>Where:</p>
<ul>
<li><strong>g</strong> – Earth’s gravity (9.81 m/s²)</li>
<li><strong>angle</strong> – the tilt of the track</li>
<li><strong>sin(angle)</strong> – how much of gravity points <em>along</em> the track</li>
</ul>
<h3 id="but-why">But why?</h3>
<p>For simplification, we only look at <strong>downward slopes</strong> at this point.<br>
Of course, in a real simulation we also have <strong>negative angles</strong> when the coaster travels uphill, but we will get to that later.</p>
<p>For these downhill angles, the relevant sine values lie between <strong>0 and 1</strong>:</p>
<ul>
<li><strong>sin = 0</strong> → no gravity along the track</li>
<li><strong>sin = 1</strong> → full gravity along the track</li>
</ul>
<h3 id="examples">Examples</h3>
<h4 id="vertical-drop-90"><strong>Vertical drop (90°)</strong></h4>
<p>Full gravity acts along the track, essentially free fall.</p>
<ul>
<li>sin(90°) = 1 (100% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>9.81 m/s²</strong></li>
</ul>
<hr>
<h4 id="45-slope"><strong>45° slope</strong></h4>
<p>You probably expected to get <strong>half of gravity</strong> here, right? Nope, it&rsquo;s not linear at all :D It’s a sine function.</p>
<ul>
<li>sin(45°) ≈ 0.707 (≈ 70% of <strong>gravity</strong>)</li>
<li>acceleration ≈ <strong>6.93 m/s²</strong></li>
</ul>
<hr>
<h4 id="flat-track-0"><strong>Flat track (0°)</strong></h4>
<p>No slope → no downhill force.</p>
<ul>
<li>sin(0°) = 0 (0% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>0 m/s²</strong></li>
</ul>
<hr>
<h2 id="why-this-matters-for-simulation">Why this matters for simulation</h2>
<p>As you can see, to simulate our coaster we only need to know:</p>
<blockquote>
<p><strong>the angle of the track at each point.</strong></p>
</blockquote>
<ul>
<li>0° → <strong>0 m/s²</strong>, no acceleration</li>
<li>45° → <strong>6.93 m/s²</strong>, about 70% of gravity</li>
<li>90° → <strong>9.81 m/s²</strong>, full gravity (free fall)</li>
</ul>
<p>And the crucial insight is:</p>
<blockquote>
<p><strong>This relationship is not linear, it&rsquo;s governed by sine.</strong></p>
</blockquote>
<p>This is why 45° does <em>not</em> give half of Earth&rsquo;s gravity, but roughly <strong>70%</strong>.</p>
<hr>
<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-3/">In the next chapter, we’ll write a small piece of code that evaluates the physics and moves a simple object along a linear plane.</a></p>
]]></content></item><item><title>Writing a Roller Coaster Simulation – Introduction and Motion Dynamics</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-1/</link><pubDate>Wed, 26 Nov 2025 12:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-1/</guid><description>&lt;p>You might have played around with JavaScript animations or small physics experiments before, but in this series we are going to take things a step further. We will build a simplified roller coaster simulation directly in the browser. The goal is not to create a full physics engine or a hyper-realistic coaster model, but to understand the core ideas behind motion, acceleration, track geometry and visual rendering.&lt;/p>
&lt;p>We will use technologies that are easy to access and quick to experiment with. Throughout the series, we will rely on &lt;strong>TypeScript&lt;/strong>, &lt;strong>React&lt;/strong> and &lt;strong>Three.js&lt;/strong>. This combination gives us a clean developer experience and allows us to turn mathematical concepts into visual, interactive 3D scenes with very little overhead.&lt;/p></description><content type="html"><![CDATA[<p>You might have played around with JavaScript animations or small physics experiments before, but in this series we are going to take things a step further. We will build a simplified roller coaster simulation directly in the browser. The goal is not to create a full physics engine or a hyper-realistic coaster model, but to understand the core ideas behind motion, acceleration, track geometry and visual rendering.</p>
<p>We will use technologies that are easy to access and quick to experiment with. Throughout the series, we will rely on <strong>TypeScript</strong>, <strong>React</strong> and <strong>Three.js</strong>. This combination gives us a clean developer experience and allows us to turn mathematical concepts into visual, interactive 3D scenes with very little overhead.</p>
<p>The idea behind this series is simple. Instead of reading theory first, we will learn by building something fun. Each chapter focuses on a single concept. By the end, you will understand how a small coaster car can move along a track, how the track itself is defined, and how everything is drawn in the browser.</p>
<h2 id="motion-dynamics">Motion Dynamics</h2>
<p>At the end of the day, simulating a roller coaster comes down to one simple question:</p>
<p><strong>How much distance should the coaster travel in each simulation step?</strong></p>
<p>To keep things simple, let’s assume our simulation updates roughly every <strong>16 ms</strong>, which is what you would get at about 60 FPS. So the question becomes:</p>
<p><strong>How far does the coaster need to travel within these 16 ms?</strong></p>
<p>To answer this, we follow a very straightforward chain of logic:</p>
<ul>
<li><strong>To know the distance to travel, we first need the velocity</strong></li>
<li><strong>To know the velocity, we first need the acceleration</strong></li>
</ul>
<p>So everything begins with acceleration.
Acceleration changes the velocity, <strong>velocity determines the distance to travel</strong>, and the distance to travel tells us where the coaster ends up in the next 16 ms.</p>
<p>This gives us a simple structure:</p>
<p>Acceleration → Velocity → Distance</p>
<p>Once we understand the acceleration acting on the coaster, the rest follows naturally.</p>
<p>In the next chapter, we will take the first real step of the simulation and answer the core question:</p>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/writing-a-roller-coaster-simulation-2/">How do we determine the acceleration of the coaster?</a></p>
]]></content></item><item><title>Roller Coaster Simulation - Improved spline interpolation</title><link>https://ercanakyuerek.de/posts/rollercoaster-simulation/improved-spline-interpolation/</link><pubDate>Tue, 07 Mar 2023 00:30:20 +0100</pubDate><guid>https://ercanakyuerek.de/posts/rollercoaster-simulation/improved-spline-interpolation/</guid><description>&lt;p>In the latest update, a number of bugs were discovered, particularly in the precision of floating point calculations when working with a web assembly module in a browser environment. It was found that the jitters mentioned earlier were actually caused by a bug in the roll interpolation process.&lt;/p>
&lt;p>To give a brief overview, track interpolation involves estimating the length of a NURBS track by interpolating with a large step size and evaluating nodes based on the estimated length, resulting in a dense enough interpolation. After this, the normals are calculated and normal angles are applied on the y and x directions but not on the z direction yet, which is essentially the roll. These normals are then applied to the previous matrix and the process continues. A C2 continuous cubic spline is then constructed, and the z angle, which is the result of applying normals in the x and y directions, is applied on each roll point on top of its roll value. The next step is to iterate through all nodes again and apply rotation on the z direction. Finally, to obtain the matrix at any point, we perform a binary search for the minimum and maximum node whose distance lies between the two and interpolate linearly.&lt;/p></description><content type="html"><![CDATA[<p>In the latest update, a number of bugs were discovered, particularly in the precision of floating point calculations when working with a web assembly module in a browser environment. It was found that the jitters mentioned earlier were actually caused by a bug in the roll interpolation process.</p>
<p>To give a brief overview, track interpolation involves estimating the length of a NURBS track by interpolating with a large step size and evaluating nodes based on the estimated length, resulting in a dense enough interpolation. After this, the normals are calculated and normal angles are applied on the y and x directions but not on the z direction yet, which is essentially the roll. These normals are then applied to the previous matrix and the process continues. A C2 continuous cubic spline is then constructed, and the z angle, which is the result of applying normals in the x and y directions, is applied on each roll point on top of its roll value. The next step is to iterate through all nodes again and apply rotation on the z direction. Finally, to obtain the matrix at any point, we perform a binary search for the minimum and maximum node whose distance lies between the two and interpolate linearly.</p>
<p>However, a problem arises when the roll is pre-applied, resulting in jitters due to precision issues. To solve this, the roll should not be applied on each node but only when requesting a matrix at a specific distance. Additionally, the performance was optimized by reducing the time for iterating through all nodes to only once.</p>
<h1 id="whats-next">What&rsquo;s Next?</h1>
<p>With a stable track interpolating method in place, work has started on coding multi-track support. Although it presents some challenges, they are not insurmountable. Once the multi-track support is completed, a basic block system will be developed to create a real simulation environment.</p>
<p>Lastly, the program has been updated to include another coaster from the NoLimits 2 Library inside the &ldquo;Storm Valley&rdquo; park.</p>

<iframe src="https://ercanakyuerek.de//roller-coaster-simulation/simulator-2.html" style="border: 0; width: 100%; height: 600px;"></iframe>
]]></content></item><item><title>Writing a Library in C++ and Using it in the Browser with the WASI SDK - JavaScript module</title><link>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-4/</link><pubDate>Mon, 27 Feb 2023 17:45:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-4/</guid><description>&lt;p>&lt;a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-3/">If you haven&amp;rsquo;t read the third article of this series, I highly recommend that you do so.&lt;/a>&lt;/p>
&lt;p>This is the point where we will develop our &lt;code>JavaScript&lt;/code> library that utilizes the functions exposed in the &lt;code>WebAssembly&lt;/code> module. I have created a simple template for this purpose. You may notice that we are defining some imports for &lt;code>WASI&lt;/code>, but they are all empty. Allow me to explain what &lt;code>WASI&lt;/code> is and what it aims to achieve. &lt;code>WASI&lt;/code> is an attempt to create specifications similar to the &lt;code>POSIX&lt;/code> standard, which can be implemented across different runtimes, such as browsers or regular machines, and provides access to system-specific functions, such as file systems. However, for our library, which only needs to perform calculations, we do not require a complex runtime environment. This is why our functions are empty. Some may argue that we should use the Emscripten SDK instead of the &lt;code>WASI SDK&lt;/code>, but I believe that the &lt;code>WASI SDK&lt;/code> is the future. It produces smaller binaries and has fewer complications compared to &lt;code>Emscripten&lt;/code>. There are official efforts to import standard &lt;code>WASI&lt;/code> functions for the &lt;code>browser&lt;/code>, but unfortunately, they do not seem to work unless a &lt;code>WebAssembly module&lt;/code> is instantiated within a &lt;code>worker&lt;/code>. If there are any changes in the future regarding this matter, I will update my articles accordingly. &lt;a href="https://github.com/wasmerio/wasmer-js">Here&lt;/a> is the mentioned attempt to bring a &lt;code>WASI runtime&lt;/code> to &lt;code>browsers&lt;/code>. If you can load a &lt;code>WASM file&lt;/code> outside the &lt;code>worker&lt;/code>, just email me your solution and I will include it here! &amp;#x1f604;&lt;/p></description><content type="html"><![CDATA[<p><a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-3/">If you haven&rsquo;t read the third article of this series, I highly recommend that you do so.</a></p>
<p>This is the point where we will develop our <code>JavaScript</code> library that utilizes the functions exposed in the <code>WebAssembly</code> module. I have created a simple template for this purpose. You may notice that we are defining some imports for <code>WASI</code>, but they are all empty. Allow me to explain what <code>WASI</code> is and what it aims to achieve. <code>WASI</code> is an attempt to create specifications similar to the <code>POSIX</code> standard, which can be implemented across different runtimes, such as browsers or regular machines, and provides access to system-specific functions, such as file systems. However, for our library, which only needs to perform calculations, we do not require a complex runtime environment. This is why our functions are empty. Some may argue that we should use the Emscripten SDK instead of the <code>WASI SDK</code>, but I believe that the <code>WASI SDK</code> is the future. It produces smaller binaries and has fewer complications compared to <code>Emscripten</code>. There are official efforts to import standard <code>WASI</code> functions for the <code>browser</code>, but unfortunately, they do not seem to work unless a <code>WebAssembly module</code> is instantiated within a <code>worker</code>. If there are any changes in the future regarding this matter, I will update my articles accordingly. <a href="https://github.com/wasmerio/wasmer-js">Here</a> is the mentioned attempt to bring a <code>WASI runtime</code> to <code>browsers</code>. If you can load a <code>WASM file</code> outside the <code>worker</code>, just email me your solution and I will include it here! &#x1f604;</p>
<h2 id="instantiate-a-module">Instantiate a module</h2>
<p>Let&rsquo;s create a small boilerplate code for this purpose in the <code>index.js</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glue</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./glue.wasm&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">libCalculation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">wasmFileResponsePromise</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">maximum</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">module</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">compileStreaming</span>(<span style="color:#a6e22e">wasmFileResponsePromise</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">module</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wasi_snapshot_preview1</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">environ_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">environ_sizes_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_close</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_fdstat_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_read</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_write</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">proc_exit</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_seek</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_fdstat_set_flags</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_prestat_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_prestat_dir_name</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">path_open</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memory</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... here comes our wrapped functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... going to export them here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">libCalculation</span>;
</span></span></code></pre></div><p>We will need to discuss memory later, particularly linear memory. For now, let&rsquo;s wrap some WebAssembly functions. We will start with an easy one, <code>getSplineLength</code>. We can get the function from the <code>instance.exports</code> and call it with the spline pointer. This function returns a float, so there is no need for any special handling here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSplineLength</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">splinePointer</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">getSplineLength</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">splinePointer</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s move on to a more complicated function, <code>getSplinePositionAtDistance</code>. We also need to get the function from the exports and call it with the <code>spline pointer</code> and a <code>distance</code>. However, we need to handle the <code>3D vector</code> pointer from the function&rsquo;s return in order to extract the float <code>x, y, and z</code> values from the <code>3D vector</code>.The <code>3D vector</code> includes three <code>float</code> values. That&rsquo;s why we use <code>Float32Array</code> instead of <code>Float64Array</code>, which would be used for doubles. The first argument is the memory itself, the second one is the <code>position</code> in the <code>memory</code> (a pointer is simply a number), and we want to extract <code>3x 32bit values</code>, which perfectly match <code>3x float for x, y, and z</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSplinePositionAtDistance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">splinePointer</span>, <span style="color:#a6e22e">distance</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">getSplinePositionAtDistance</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span>, <span style="color:#a6e22e">memory</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positionPointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">splinePointer</span>, <span style="color:#a6e22e">distance</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>, <span style="color:#a6e22e">positionPointer</span>, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we reached an interesting function, createSpline, which takes four parameters of type <code>3d vector</code>. In this case we can just allocate <code>4x3x32bit</code>, four control points, <code>x, y, z</code> for each point, each point is a float which are <code>32bit</code>, which makes <code>48 bytes</code> in total. So we first need to allocate <code>48 bytes</code>. For this, we can easily use our malloc function, which we exposed in the webassembly module. I know, this is NOT a perfect solution, and there are some limitations, when I come up with better solutions, there will be some changes. So, at javascript side, we need to allocate <code>48 bytes</code>, put all <code>p0 - p1</code> coordinates in to the memory and pass the memory pointer to the arguments. We also can allocate for each parameter, so we can all <code>4 times malloc</code> with <code>12 bytes</code> each malloc. I decided to do the latter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createSpline</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>, <span style="color:#a6e22e">p3</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">createSpline</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span>, <span style="color:#a6e22e">malloc</span>, <span style="color:#a6e22e">memory</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointers</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>, <span style="color:#a6e22e">p3</span>].<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">point</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>); <span style="color:#75715e">// (x, y, z) * 4 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">pointer</span>, <span style="color:#ae81ff">3</span>).<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">point</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pointer</span>;
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>export all function &#x1f604;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">createSpline</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getSplinePositionAtDistance</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getSplineLength</span>
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><h2 id="testing-our-library">Testing our library</h2>
<p>For testing purposes, you can create an <code>index.html</code> file and install the <code>http-serve</code> package by running the command <code>npm install http-serve --save-dev</code>. To start the server, run the command <code>node_modules/.bin/http-server .</code> and include the following content in the <code>index.html</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">libCalculation</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./index.js&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">init</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">createSpline</span>, <span style="color:#a6e22e">getSplineLength</span>, <span style="color:#a6e22e">getSplinePositionAtDistance</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">libCalculation</span>(<span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;glue.wasm&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">spline</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createSpline</span>([<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">splineLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSplineLength</span>(<span style="color:#a6e22e">spline</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSplinePositionAtDistance</span>(<span style="color:#a6e22e">spline</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>({ <span style="color:#a6e22e">splineLength</span>, <span style="color:#a6e22e">position</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div>
<iframe src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/libCalculation/example.html" class="embedded-iframe"></iframe>
<p>Please check the console for a spline with a length of <code>10.06</code>. The position we fetched should return a 3D vector with coordinates of <code>[-3, -3, 0]</code>.
Next to this text, you can view an advanced test that displays a spline. I have created a <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/static/wasi-sdk-writing-library-in-cpp/libCalculation">repository</a> that contains all the necessary files, including this advanced example that uses Three.js for rendering.</p>
<h2 id="conclusion">Conclusion</h2>
<p>That&rsquo;s all! It wasn&rsquo;t that difficult, was it? We haven&rsquo;t yet covered other complex types, such as passing strings to and from WebAssembly modules, or how to log. However, you should have a rough idea of how things work now. In future articles, I will explore data types, memory management, and binding in greater depth. To be honest, gluing code together is not enjoyable. It requires creating glue code on the C++ side and a wrapper JavaScript module that <code>serializes</code> and <code>unserializes</code> arguments and return values. Some solutions eliminate the need for writing both code pieces, but for now, this should help you get started, especially if you aim to build a small yet performance-critical library.</p>
]]></content></item><item><title>Writing a Library in C++ and Using it in the Browser with the WASI SDK - Implementing library functions</title><link>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-3/</link><pubDate>Fri, 24 Feb 2023 00:19:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-3/</guid><description>&lt;p>&lt;a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-2/">If you haven&amp;rsquo;t read the second article of this series, I highly recommend that you do so.&lt;/a>&lt;/p>
&lt;iframe src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/spline.html" class="embedded-iframe">&lt;/iframe>
&lt;p>In this article, we&amp;rsquo;ll be exploring a more interesting example where we&amp;rsquo;ll construct a bezier curve, evaluate nodes on it, and write a function that gives any position on the curve by a length parameter. To explain briefly, a bezier curve is represented by a parameter &lt;code>t&lt;/code>, which varies between 0 and 1 and determines the position of nodes on the curve. However, this &lt;code>t&lt;/code> value doesn&amp;rsquo;t produce uniform spacing, which is problematic when we want to evaluate a point on the curve based on its distance. To solve this, we can evaluate some nodes along the curve with known distances and then linearly interpolate new nodes between them to find the point we&amp;rsquo;re looking for.&lt;/p></description><content type="html"><![CDATA[<p><a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-2/">If you haven&rsquo;t read the second article of this series, I highly recommend that you do so.</a></p>

<iframe src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/spline.html" class="embedded-iframe"></iframe>
<p>In this article, we&rsquo;ll be exploring a more interesting example where we&rsquo;ll construct a bezier curve, evaluate nodes on it, and write a function that gives any position on the curve by a length parameter. To explain briefly, a bezier curve is represented by a parameter <code>t</code>, which varies between 0 and 1 and determines the position of nodes on the curve. However, this <code>t</code> value doesn&rsquo;t produce uniform spacing, which is problematic when we want to evaluate a point on the curve based on its distance. To solve this, we can evaluate some nodes along the curve with known distances and then linearly interpolate new nodes between them to find the point we&rsquo;re looking for.</p>
<p>While this is a specific example, it involves &ldquo;complex&rdquo; types such as custom structs and 3D vectors that will need to be accessed from a web browser. So it should serve as a useful case for testing our library &#x1f604;</p>
<h2 id="adding-a-third-party-library">Adding a third party library</h2>
<p>I mentioned 3D vectors, so there is a well-known library called <code>glm</code>. I know that this is an overkill library for our &ldquo;simple&rdquo; problem, but it serves the purpose of showing how to add other libraries to our project. Ideally, the 3rd party library also has a CMake ecosystem. Otherwise, we need to be creative, fortunately. <code>glm</code> provides CMake files. My approach is to add a git submodule into the root directory by calling:</p>
<pre tabindex="0"><code>git submodule add https://github.com/g-truc/glm.git
</code></pre><p>We must include the glm directory as an include in our root <code>CMakeList.txt</code>, as the glm library is a header-only library and does not need to be linked against anything:</p>
<pre tabindex="0"><code>include_directories(glm)
</code></pre><h2 id="spline-implementation">Spline implementation</h2>
<p>In summary, I have developed a solution for the problem discussed earlier, but I won&rsquo;t delve too deeply into the technical details. The primary function of my implementation, <code>bezier_fast</code>, computes the position on a bezier curve based on a given <code>t</code> parameter. Additionally, <code>estimate_length</code> is used to calculate the curve&rsquo;s length very quickly with a <code>low step size</code>. This estimation is necessary to determine how many nodes we should evaluate. With this method, we can create densely populated nodes depending on the curve&rsquo;s length. The evaluate function executes the procedure I just described. Naturally, we can always measure the distance between the evaluated position and the previous one to obtain the curve&rsquo;s total length, which we simply pass through the <code>get_length</code> function. Lastly, <code>get_position_at_distance</code> searches for the minimum node at a specified distance and linearly interpolates the position to the next node. We have successfully achieved the ability to evaluate uniformly spaced points on the curve.</p>
<p><code>src/spline.cc:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;spline.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/geometric.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> spline<span style="color:#f92672">::</span>evaluate() {
</span></span><span style="display:flex;"><span>    nodes.clear();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> numberOfNodes <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(estimate_length() <span style="color:#f92672">*</span> <span style="color:#ae81ff">20.0f</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>numberOfNodes) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> distance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> numberOfNodes; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) i <span style="color:#f92672">/</span> (<span style="color:#66d9ef">float</span>) (numberOfNodes <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 position <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        distance <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(position, lastPos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        nodes.push_back({
</span></span><span style="display:flex;"><span>            .position <span style="color:#f92672">=</span> position,
</span></span><span style="display:flex;"><span>            .distance <span style="color:#f92672">=</span> distance
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> position;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 spline<span style="color:#f92672">::</span>bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span><span style="color:#f92672">-</span>t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b0 <span style="color:#f92672">=</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b3 <span style="color:#f92672">=</span> t <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b0 <span style="color:#f92672">*</span> p0  <span style="color:#f92672">+</span> b1 <span style="color:#f92672">*</span> p1 <span style="color:#f92672">+</span> b2 <span style="color:#f92672">*</span> p2 <span style="color:#f92672">+</span> b3 <span style="color:#f92672">*</span> p3;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> spline<span style="color:#f92672">::</span>estimate_length() {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">15</span>; i<span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) (i) <span style="color:#f92672">/</span> <span style="color:#ae81ff">14.0f</span>;
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 pos <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(pos, lastPos);
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> pos;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> length;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 spline<span style="color:#f92672">::</span>get_position_at_distance(<span style="color:#66d9ef">float</span> distance) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nodes.size() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>vec3(<span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> nextNode <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>lower_bound(nodes.begin(), nodes.end(), distance, [](<span style="color:#66d9ef">auto</span> a, <span style="color:#66d9ef">double</span> value) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> a.distance <span style="color:#f92672">&lt;</span> value; });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> currentNode <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isFirst <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">==</span> nodes.begin();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isLast <span style="color:#f92672">=</span> currentNode <span style="color:#f92672">==</span> nodes.end();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isFirst) <span style="color:#66d9ef">return</span> nodes[<span style="color:#ae81ff">0</span>].position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isLast) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> t <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nextNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">&gt;</span> std<span style="color:#f92672">::</span>numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span><span style="color:#f92672">&gt;::</span>epsilon()) {
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>max(std<span style="color:#f92672">::</span>min((distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance) <span style="color:#f92672">/</span> (nextNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance), <span style="color:#ae81ff">1.0f</span>), <span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>mix(currentNode<span style="color:#f92672">-&gt;</span>position, nextNode<span style="color:#f92672">-&gt;</span>position, t);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> spline<span style="color:#f92672">::</span>get_length() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>nodes.empty()) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].distance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>src/spline.h:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#ifndef LIBCALCULATION_SPLINE_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIBCALCULATION_SPLINE_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/vec3.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">node</span> {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> distance;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">spline</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    spline(<span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp1, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp2, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp3, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp4) <span style="color:#f92672">:</span> cp1(cp1), cp2(cp2),
</span></span><span style="display:flex;"><span>                                                                                                     cp3(cp3),
</span></span><span style="display:flex;"><span>                                                                                                     cp4(cp4) {
</span></span><span style="display:flex;"><span>        evaluate();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 get_position_at_distance(<span style="color:#66d9ef">float</span> distance);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">get_length</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 cp1, cp2, cp3, cp4;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>node<span style="color:#f92672">&gt;</span> nodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> glm<span style="color:#f92672">::</span>vec3 bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">estimate_length</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">evaluate</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">//LIBCALCULATION_SPLINE_H
</span></span></span></code></pre></div><h2 id="gluing-the-pieces-of-our-library">Gluing the Pieces of our library</h2>
<p>We still cannot use the functions yet, so we need to create glue code to expose them to the outside world. Our goal is to use this spline library in our browser, for example, to draw a uniformly spaced Bezier curve. We will expose three functions: <code>createSpline</code>, <code>getSplineLength</code>, and <code>getSplinePositionAtDistance</code>. Some of these functions return complex types, such as a <code>3D vector</code>, which we will handle on the JavaScript side. There are many techniques to pass complex data from and to our WebAssembly module, which we will discuss in detail later. For now, let&rsquo;s focus on creating some glue code in <code>glue/glue.cc</code>.</p>
<h3 id="data-types">Data types</h3>
<p>As mentioned several times before, passing complex data types in and out can be challenging, but it can be managed. Passing 32 and 64 bit integers and decimal numbers is natively supported, so there is no need to worry about those. However, passing types such as a <code>3D vector</code> is a different matter. We need to allocate memory on the JavaScript side, assign the <code>3D vector</code> data (3x <code>floats</code>) to a free memory space, and pass the location (pointer) to the function calls. If we return complex data from the WebAssembly module, we will get a pointer and access the data in memory and &ldquo;demangle&rdquo; it (for example, using <code>Float64Array</code> with the pointer as offset and length of 3 to access x, y, z data). We will delve deeper into this later.</p>
<h3 id="createspline-function">createSpline function</h3>
<p>This is a straightforward process. We replicate the original constructor and expose this new function using the <code>attribute((export_name(&quot;createSpline&quot;)))</code> attribute to make it available to the outside world. As shown, we return a pointer, which will be a number on the JavaScript side and can be used to access memory data later. To ensure that we can access the data of the 3d vector in memory on the JavaScript side, it is crucial that the parameters of the vector are also pointers. This is because we allocate memory on the JavaScript side and assign our vector data to that memory location.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;createSpline&#34;</span>)))
</span></span><span style="display:flex;"><span>spline <span style="color:#f92672">*</span>createSpline(glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp1, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp2, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp3, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp4) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">spline</span>(<span style="color:#f92672">*</span>cp1, <span style="color:#f92672">*</span>cp2, <span style="color:#f92672">*</span>cp3, <span style="color:#f92672">*</span>cp4);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="getsplinelength-function">getSplineLength function</h3>
<p>This function returns a <code>float</code>, so no need to handle any extra complex data stuff on the JavaScript side:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;getSplineLength&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> getSplineLength(spline <span style="color:#f92672">*</span>s) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> s<span style="color:#f92672">-&gt;</span>get_length();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="getsplinepositionatdistance-function">getSplinePositionAtDistance function</h3>
<p>This function returns a pointer to a <code>3d vector</code>, which allows us to access its data in memory on the <code>JavaScript</code> side. Therefore, we need to allocate a new space for the returned <code>3d vector</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;getSplinePositionAtDistance&#34;</span>)))
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>getSplinePositionAtDistance(spline <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">float</span> distance) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> glm<span style="color:#f92672">::</span>vec3(s<span style="color:#f92672">-&gt;</span>get_position_at_distance(distance));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="malloc">malloc</h3>
<p>I understand that this may not be the most optimal approach for memory allocation, but it is currently working for my purposes. I may consider revising my implementation at a later time, but for now, we can utilize the <code>malloc</code> function from the <code>JavaScript</code> side. This is necessary for allocating memory to data that we want to pass to the <code>WebAssembly</code> functions, such as <code>3D vectors</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;malloc&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>allocateMemory(size_t size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">malloc</span>(size);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="build">Build</h2>
<p>At this point, you can run a build by executing <code>npm run build</code>. It should compile without any errors. In the next section, we will create a small <code>JavaScript</code> module that initializes the <code>WebAssembly</code> module, wraps the exposed functions, and handles incoming and outgoing data types. This <code>JavaScript</code> module can be used in your project just like any other <code>ES6 module</code>.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-4/">Now, let&rsquo;s create a small JavaScript module that will be responsible for creating a WebAssembly module, loading our Wasm file, defining some imports for WASI (which will mostly be empty), and creating functions for those that we exported in our C++ glue code.</a></p>
]]></content></item><item><title>Writing a Library in C++ and Using it in the Browser with the WASI SDK - CMake and build scripts</title><link>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-2/</link><pubDate>Thu, 23 Feb 2023 23:15:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-2/</guid><description>&lt;p>&lt;a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-1/">If you haven&amp;rsquo;t read the first article of this series, I highly recommend that you do so.&lt;/a>&lt;/p>
&lt;p>To simplify the building process, we can create a build script. We have already defined some scripts in our &lt;code>package.json&lt;/code> file. At this point, the &lt;code>build-wasm.js&lt;/code> file is still empty, so we can create a basic script that first deletes an existing &lt;code>build&lt;/code> folder, creates a new one, and runs &lt;code>cmake ..&lt;/code> inside it. We will be using a WASI-SDK docker image from &lt;code>ghcr.io/webassembly/wasi-sdk&lt;/code> to run cmake and eventually compile the project via &lt;code>make&lt;/code>.&lt;/p></description><content type="html"><![CDATA[<p><a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-1/">If you haven&rsquo;t read the first article of this series, I highly recommend that you do so.</a></p>
<p>To simplify the building process, we can create a build script. We have already defined some scripts in our <code>package.json</code> file. At this point, the <code>build-wasm.js</code> file is still empty, so we can create a basic script that first deletes an existing <code>build</code> folder, creates a new one, and runs <code>cmake ..</code> inside it. We will be using a WASI-SDK docker image from <code>ghcr.io/webassembly/wasi-sdk</code> to run cmake and eventually compile the project via <code>make</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">rm</span>, <span style="color:#a6e22e">mkdir</span>, <span style="color:#a6e22e">exec</span>, <span style="color:#a6e22e">cp</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;shelljs&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">join</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;path&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">compileOnly</span>, <span style="color:#a6e22e">run</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;args-parser&#34;</span>)(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">argv</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">paths</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;build&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueSource</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;build&#34;</span>, <span style="color:#e6db74">&#34;glue&#34;</span>, <span style="color:#e6db74">&#34;glue&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueDestination</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;glue.wasm&#34;</span>),
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">compileOnly</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#34;-rf&#34;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#34;-rf&#34;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk cmake -DCMAKE_BUILD_TYPE=Release ..&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk make -j 10&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueSource</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span></code></pre></div><p>We will provide CMake directives for automatically adding all <code>*.cc</code> files in the <code>glue</code> and <code>src</code> directories. If you prefer using the <code>.cpp</code> extension instead, feel free to modify the files accordingly. We will also ensure that we build a static library by using the <code>STATIC</code> keyword in the add_library function. Therefore, the content of the <code>src/CMakeLists.txt</code> file is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">STATIC</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#e6db74">calculation::calculation</span> <span style="color:#e6db74">ALIAS</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The <code>glue/CMakeLists.txt</code> file will slightly differ from the one in <code>src</code>. As mentioned earlier, <code>glue</code> will serve as the final WebAssembly &ldquo;application&rdquo; that statically links our <code>calculation</code> library and exposes manually exported functions. We&rsquo;ll need to handle complex data types such as <code>vectors</code> and <code>structs</code>, but we&rsquo;ll cover that in the next chapters. For now, it&rsquo;s important to understand that <code>glue</code> is essentially our end product that links to our <code>calculation</code> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#e6db74">glue</span> <span style="color:#e6db74">calculation::calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Now we need to bring everything together in the <code>CMakeList.txt</code> file in our root directory, which basically means adding the directories <code>glue</code> and <code>src</code>, setting some optimization flags for release mode, and disabling exceptions for WASI since exceptions are currently not supported by WASI-SDK. Here&rsquo;s what the file should look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>cmake_minimum_required (<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.9</span> <span style="color:#e6db74">FATAL_ERROR</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project (<span style="color:#e6db74">CALCULATION</span> <span style="color:#e6db74">LANGUAGES</span> <span style="color:#e6db74">CXX</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.1.0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">14</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_FLAGS_RELEASE</span> <span style="color:#e6db74">&#34;-O3&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Disable exceptions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if (<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;WASI&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">REGEX</span> <span style="color:#e6db74">REPLACE</span> <span style="color:#e6db74">&#34;-fexceptions&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#f92672">${</span>CMAKE_CXX_FLAGS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#e6db74">&#34;${CMAKE_CXX_FLAGS} -fno-exceptions&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include_directories(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>To test our setup, we need to add a main function to the file <code>glue/glue.cc</code>. The files <code>spline.cc</code> and <code>spline.h</code> can remain empty for now as they are not necessary to test our setup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {}
</span></span></code></pre></div><p><img alt="final structure" src="/wasi-sdk-writing-library-in-cpp/final_structure.png"></p>
<p>Finally, we can run our build script and see what happens &#x1f604;. To run the build script, simply execute <code>npm run build</code>. After it finishes executing, there should be a newly created file in the root directory named <code>glue.wasm</code>, which confirms that our setup is correct. However, this file does not have any functionality at the moment, <a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-3/">but that will change in the next chapter.</a></p>
]]></content></item><item><title>Writing a Library in C++ and Using it in the Browser with the WASI SDK - Folder structure</title><link>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-1/</link><pubDate>Thu, 23 Feb 2023 22:00:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-1/</guid><description>&lt;p>You may have already heard that it&amp;rsquo;s possible to write certain parts of your web application using languages like C++ or Rust and compile them into WebAssembly. WebAssembly is a binary format that allows code to be executed on the web and is designed to be efficient, secure, and portable. There are use cases where WebAssembly can be particularly beneficial, such as performing complex and resource-intensive computations for real-time applications or mathematical operations.&lt;/p></description><content type="html"><![CDATA[<p>You may have already heard that it&rsquo;s possible to write certain parts of your web application using languages like C++ or Rust and compile them into WebAssembly. WebAssembly is a binary format that allows code to be executed on the web and is designed to be efficient, secure, and portable. There are use cases where WebAssembly can be particularly beneficial, such as performing complex and resource-intensive computations for real-time applications or mathematical operations.</p>
<p>As of the time of writing this article in 2023, there are available bindings for Rust programming language. However, when it comes to <code>C++</code>, I was not able to find any mature solution except for the <a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/WebIDL-Binder.html">WebIDL Binder for Emscripten</a>. Unfortunately, my experience with it did not produce satisfactory results. Perhaps in the future, I will explore other binding solutions and update this series of articles. For now, we will have to manually glue our code. This involves creating bindings to enable the exchange of complex data between WebAssembly modules and exposing functions.</p>
<h2 id="using-webassembly-as-a-regular-javascript-module">Using WebAssembly as a Regular JavaScript Module</h2>
<p>This is a crucial aspect that I wish to explore. I want to write parts of my application in C++ and use them as regular modules in JavaScript. As previously mentioned, there is no NPM infrastructure available for compiling or generating bindings that can produce JavaScript files that export modules with exposed C++ functions. In this series, we will construct a minimalist infrastructure that emulates familiar module structures.</p>
<h2 id="building-an-example-library-for-computing-bezier-curves">Building an Example Library for Computing Bezier Curves</h2>
<p>For this article, we will create a very minimalistic library for computing bezier curves. We will set up this project in a way that the library can be used in a regular C++ application, as well as in a web application.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Please ensure that you have installed both <code>Node.js</code> and <code>Docker</code> on your computer. We will utilize the WASI-SDK Docker image for constructing the WebAssembly library.</p>
<h2 id="project-structure">Project structure</h2>
<p>First, let&rsquo;s create a folder named <code>libComputation</code> and run <code>npm init</code> inside the folder, following the input instructions. After initializing an npm project, replicate this folder structure and create the following files:</p>
<pre tabindex="0"><code class="language-ls" data-lang="ls">libComputation
    glue
        CMakeLists.txt
        glue.cc
    src
        CMakeLists.txt
        spline.cc
        spline.h
    CMakeLists.txt
    build-wasm.js
    index.js
</code></pre><p>As you can see, this resembles a regular CMake project with WebAssembly compilation additions.
We will use <code>build-wasm.js</code> for compilation purposes, and for that, we need to install some npm
modules for creating directories and parsing arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install shelljs args-parser --save-dev
</span></span></code></pre></div><p>Now, add the following build scripts in the <code>package.json</code> file, which we will use for different use cases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scripts&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;build&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;compile&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js --compileOnly&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see, there is a folder named <code>glue</code>. In this subdirectory,
we will define all exports and bindings to the WebAssembly Module,
so that all files inside the <code>src</code> folder will be free from WASI artifacts.
We have intentionally split both directories because our goal is to use the libraries in regular
desktop applications as well, where <code>WASI SDK</code> is not used to build the library.
This approach ensures high flexibility when using the library in both the browser and desktop
environments.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/wasi-sdk-writing-library-in-cpp-2/">In the next part, we will create the build script and set up the CMake files.</a></p>
]]></content></item><item><title>Roller Coaster Simulation - First results</title><link>https://ercanakyuerek.de/posts/rollercoaster-simulation/first-results/</link><pubDate>Thu, 23 Feb 2023 16:28:20 +0100</pubDate><guid>https://ercanakyuerek.de/posts/rollercoaster-simulation/first-results/</guid><description>&lt;p>I am in the process of developing an open source roller coaster simulator that is designed to achieve a high degree of compatibility with NoLimits 2. To this end, I have adopted the same track generation and roll interpolation techniques employed by NoLimits 2. Although there are some bugs associated with loading NoLimits2 Parks at present, I anticipate that these issues will be resolved in due course, as I continue to refine the nl2park loader.&lt;/p></description><content type="html"><![CDATA[<p>I am in the process of developing an open source roller coaster simulator that is designed to achieve a high degree of compatibility with NoLimits 2. To this end, I have adopted the same track generation and roll interpolation techniques employed by NoLimits 2. Although there are some bugs associated with loading NoLimits2 Parks at present, I anticipate that these issues will be resolved in due course, as I continue to refine the nl2park loader.</p>
<p>At this point in time, the simulator does not support a block system or multi-track functionality. However, I am actively working on implementing these features. It is worth noting that the simulator runs in a browser, and has been written in c++ and compiled to WebAssembly. Consequently, a lightweight version of the software is available for use in web browsers, while the desktop version is built using Unreal Engine 5.</p>
<p>To give you a better idea of the current implementation of the simulator, I have created an interactive example for you to try. You can switch between two coasters from the NoLimits2 library, change the camera perspective, and live adjust gravity and friction. Please note that since the user interface library I am using has no capabilities to allow more than two decimal points, there are no adjustment options for air resistance. Additionally, the track itself is not yet connected, and the sections only provide simple acceleration and deceleration on sections without a block system.</p>

<iframe src="https://ercanakyuerek.de//roller-coaster-simulation/simulator-1.html" style="border: 0; width: 100%; height: 600px;"></iframe>
]]></content></item></channel></rss>
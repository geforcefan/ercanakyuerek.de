<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Ercan Akyürek</title><link>https://ercanakyuerek.de/posts/</link><description>Recent content in Posts on Ercan Akyürek</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sat, 06 Dec 2025 13:30:00 +0100</lastBuildDate><atom:link href="https://ercanakyuerek.de/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Friction and Air Resistance</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/5-friction-and-air-resistance/</link><pubDate>Sat, 06 Dec 2025 12:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/5-friction-and-air-resistance/</guid><description>&lt;p&gt;This chapter will be quite short and introduces two small but important parts of a more realistic roller coaster simulation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;friction&lt;/li&gt;
&lt;li&gt;air resistance&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Until now our coaster moved in a world without any energy loss. That works for understanding the basics but real coasters slow down over time. Wheels create friction, air pushes against the train, and both effects reduce the acceleration the train can achieve.&lt;/p&gt;
&lt;p&gt;We will not create a complex physics model. Instead we introduce two simple parameters, very similar to what you may know from &lt;strong&gt;NoLimits Roller Coaster&lt;/strong&gt;.&lt;br&gt;
Our physics simulation should behave almost identically, apart from a few edge cases.&lt;/p&gt;</description><content type="html"><![CDATA[<p>This chapter will be quite short and introduces two small but important parts of a more realistic roller coaster simulation:</p>
<ul>
<li>friction</li>
<li>air resistance</li>
</ul>
<p>Until now our coaster moved in a world without any energy loss. That works for understanding the basics but real coasters slow down over time. Wheels create friction, air pushes against the train, and both effects reduce the acceleration the train can achieve.</p>
<p>We will not create a complex physics model. Instead we introduce two simple parameters, very similar to what you may know from <strong>NoLimits Roller Coaster</strong>.<br>
Our physics simulation should behave almost identically, apart from a few edge cases.</p>
<p>Since both <strong>friction</strong> and <strong>air resistance</strong> represent energy loss, we simply subtract them from the acceleration we calculated from gravity. This is almost correct, but there is one detail to handle when the train moves backward.
More on that in the section <strong>When riding backward, what happens?</strong>.</p>
<h2 id="friction">Friction</h2>
<p>Friction is the permanent resistance between the train and the track. We apply it directly to the acceleration. The idea is very simple:
multiply the friction constant with gravity and subtract it from the current acceleration.</p>
<p>A typical friction value in is about <strong>0.03 m/m</strong> (height loss per meter).</p>
$$friction \cdot gravity$$<h2 id="air-resistance">Air Resistance</h2>
<p>Air resistance works differently. It <strong>increases</strong> with <strong>velocity</strong>. The faster the train moves, the more the air pushes back against it.</p>
<p>A typical air resistance value is around <strong>0.0001 m/s²</strong>.
We follow the same idea and use this value as the base for our simplified model. The <strong>resistance</strong> grows with <strong>velocity²</strong>, so we multiply it with <strong>velocity²</strong> and the air resistance constant:</p>
$$airResistance \cdot velocity^2$$<p>This removes more energy when the train moves fast and almost none when it moves slowly.</p>
<h1 id="when-riding-backward-what-happens">When riding backward, what happens?</h1>
<p>There is one small detail we have to handle.
If the train moves <strong>backward</strong>, the velocity becomes negative. This also means our energy loss must flip direction. Otherwise we would accidentally add energy instead of removing it.</p>
<p>To put it simply:</p>
<ul>
<li>when riding <strong>forward</strong>, friction and air resistance <strong>subtract</strong> energy</li>
<li>when riding <strong>backward</strong>, they must still subtract energy, but from the <strong>opposite</strong> direction</li>
</ul>
<p>So we need a small multiplier that tells us whether the train is moving forward or backward:</p>
<ul>
<li>If the velocity is <strong>negative</strong>, the factor becomes <strong>-1</strong></li>
<li>If the velocity is <strong>positive</strong>, the factor is <strong>1</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span></code></pre></div><p>We can now apply this factor to the total energy loss</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">airResistance</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">friction</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gravity</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">velocityDirection</span>;
</span></span></code></pre></div><p>This flips the resistance forces to the correct direction depending on the current motion.
That is the whole trick.</p>
<p>Now subtract energy loss from acceleration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">energyLoss</span>;
</span></span></code></pre></div><h2 id="updated-evaluatemotion-function">Updated evaluateMotion function</h2>
<p>Putting everything together, the full motion evaluation now looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirection</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">friction</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">airResistance</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gravity</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">airResistance</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">friction</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gravity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">velocityDirection</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">energyLoss</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">acceleration</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>We still compute the gravity acceleration first. After that we subtract the energy losses from friction and air resistance. Even though this is a very simple model, the difference becomes immediately visible. The train will no longer accelerate forever or keep moving at impossible speeds.</p>
<h2 id="demo-with-friction-and-air-resistance">Demo with friction and air resistance</h2>
<p>Just like in the previous chapter, here is a small interactive demo. This time it includes both friction and air resistance so you can see how the coaster behaves when energy loss is part of the simulation.</p>
<ul>
<li>The <strong>orange</strong> dot represents a train with friction and air resistance applied.</li>
<li>The <strong>white</strong> dot shows the same motion without any energy loss.</li>
</ul>
<p>Feel free to move the control points to experiment with the track shape and see how both trains react differently.</p>









<div class="embedded-iframe ">

  
  <a href="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/friction-and-air-resistance.html" class="openInNewTab" style="width: 100%" target="_blank">Click here to open in a new tab</a>
  

  <iframe
    src="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/friction-and-air-resistance.html"
    width="100%"
    height="300px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
<h2 id="what-comes-next">What comes next?</h2>
<p>In the next chapter we will make a few changes to the track itself, preparing everything for an agnostic evaluation of physics.
No matter what the underlying geometry is in the end, <strong>splines, imported tracks, FVD-based shapes or anything else, the evaluation should always work the same</strong>.
The key step is replacing the two functions <code>getPositionAtDistance</code> and <code>getForwardDirectionAtDistance</code>
with a single <code>getMatrixAtDistance</code> function. Working with <strong>matrices</strong> is more convenient, because we can extract everything we need from them.
I will also introduce a <strong>curve node</strong> that stores a full matrix for a given distance along the track.
Any geometry system can “fill” these <strong>curve nodes</strong>, whether that system is based on splines, imported CSV data, FVD geometries or something entirely different.
While writing this, I realize it is probably best to introduce the concept first with a simple linear track. Stay tuned.</p>
<h1 id="demo-code">Demo code</h1>
















<p>
    <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/scripts/src//posts/writing-a-roller-coaster-simulation/FrictionAndAirResistanceScene.tsx" target="_blank" rel="noopener noreferrer">
        Click here to view the code on GitHub (opens in a new tab)
    </a>
</p>

<pre><code class="language-tsx">import React, { useEffect, useState } from &#39;react&#39;;
import { useFrame } from &#39;@react-three/fiber&#39;;
import { useControls } from &#39;leva&#39;;
import { MathUtils, Vector3 } from &#39;three&#39;;

import { ControlPoint } from &#39;../../components/ControlPoint&#39;;
import { DragControlPoints } from &#39;../../components/DragControlPoints&#39;;
import Line from &#39;../../components/Line&#39;;
import { getForwardDirectionAtDistance, getPositionAtDistance, length } from &#39;../../helper/linear&#39;;
import {
  evaluateMotionByForwardDirection,
  evaluateMotionByForwardDirectionWithFriction,
} from &#39;../../helper/physics&#39;;
import useColors from &#39;../../hooks/useColors&#39;;
import OrthographicScene from &#39;../../scenes/OrthographicScene&#39;;

const FrictionAndAirResistance = () =&gt; {
  const colors = useColors();

  // Control points
  const [points, setPoints] = useState([new Vector3(-11.5, 3.2, 0), new Vector3(1.4, -2.8, 0)]);

  const [simulationState, setSimulationState] = useControls(() =&gt; ({
    velocity: 0,
    distanceTraveled: 0,
    friction: {
      value: 0.03,
      pad: 5,
    },
    airResistance: {
      value: 0.0001,
      pad: 6,
    },
    acceleration: {
      value: 0,
      pad: 5,
    },
    gravity: {
      value: 9.81665,
      pad: 5,
    },
  }));

  const [simulationStateWithoutFriction, setSimulationStateWithoutFriction] = useState(() =&gt; ({
    velocity: 0,
    distanceTraveled: 0,
    acceleration: 0,
  }));

  // Main motion evaluation per frame
  useFrame((state, deltaTime) =&gt; {
    // evaluate with friction and air resistance
    setSimulationState(
      evaluateMotionByForwardDirectionWithFriction(
        simulationState,
        getForwardDirectionAtDistance(points[0], points[1], simulationState.distanceTraveled),
        simulationState.friction,
        simulationState.airResistance,
        simulationState.gravity,
        deltaTime,
      ),
    );

    // evaluate without energy loss
    setSimulationStateWithoutFriction(
      evaluateMotionByForwardDirection(
        simulationStateWithoutFriction,
        getForwardDirectionAtDistance(
          points[0],
          points[1],
          simulationStateWithoutFriction.distanceTraveled,
        ),
        simulationState.gravity,
        deltaTime,
      ),
    );
  });

  // Reset simulation state if train overshoots track
  useEffect(() =&gt; {
    if (
      simulationState.distanceTraveled &gt; length(points[0], points[1]) ||
      simulationState.distanceTraveled &lt; 0
    ) {
      setSimulationState({
        velocity: 0,
        distanceTraveled: 0,
        acceleration: 0,
      });

      setSimulationStateWithoutFriction({
        velocity: 0,
        distanceTraveled: 0,
        acceleration: 0,
      });
    }
  }, [
    simulationState.distanceTraveled,
    points,
    setSimulationState,
    setSimulationStateWithoutFriction,
  ]);

  const trainPosition = getPositionAtDistance(
    points[0],
    points[1],
    MathUtils.clamp(simulationState.distanceTraveled, 0, length(points[0], points[1])),
  );

  const trainPositionWithoutFriction = getPositionAtDistance(
    points[0],
    points[1],
    MathUtils.clamp(
      simulationStateWithoutFriction.distanceTraveled,
      0,
      length(points[0], points[1]),
    ),
  );

  return (
    &lt;&gt;
      &lt;DragControlPoints axisLock=&#34;z&#34; points={points} setPoints={setPoints} /&gt;
      &lt;Line points={points} color={colors.secondary} /&gt;

      &lt;ControlPoint position={trainPosition} color={colors.highlight} /&gt;
      &lt;ControlPoint position={trainPositionWithoutFriction} /&gt;
    &lt;/&gt;
  );
};

export const FrictionAndAirResistanceScene = () =&gt; {
  return (
    &lt;OrthographicScene&gt;
      &lt;FrictionAndAirResistance /&gt;
    &lt;/OrthographicScene&gt;
  );
};
</code></pre>

]]></content></item><item><title>Linear Roller Coaster Track</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/4-linear-roller-coaster-track/</link><pubDate>Sat, 06 Dec 2025 11:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/4-linear-roller-coaster-track/</guid><description>&lt;p&gt;To visualize motion properly, we need something for our little object to move along. And that means we need a track.&lt;/p&gt;
&lt;p&gt;In this article, we focus on an extremely simplified roller coaster track. And when I say extremely simplified, I really mean it: it&amp;rsquo;s just a plane. A straight line. A first-order curve. Basically the easiest form of track you can possibly build without accidentally creating a real coaster.&lt;/p&gt;
&lt;p&gt;From the last chapter, we know how motion evaluation works. The evaluation function receives an acceleration value and returns a new simulation state containing the updated velocity and the total distance traveled:&lt;/p&gt;</description><content type="html"><![CDATA[<p>To visualize motion properly, we need something for our little object to move along. And that means we need a track.</p>
<p>In this article, we focus on an extremely simplified roller coaster track. And when I say extremely simplified, I really mean it: it&rsquo;s just a plane. A straight line. A first-order curve. Basically the easiest form of track you can possibly build without accidentally creating a real coaster.</p>
<p>From the last chapter, we know how motion evaluation works. The evaluation function receives an acceleration value and returns a new simulation state containing the updated velocity and the total distance traveled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">acceleration</span>, <span style="color:#a6e22e">deltaTime</span>);
</span></span></code></pre></div><p>It returns something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;velocity&#34;</span>: <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;distanceTraveled&#34;</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now that we introduce a track, things become a bit more interesting. The old <code>evaluateMotion</code> function worked with a fixed slope and gravity using this formula:</p>
$$acceleration = gravity \cdot \sin(slopeAngle)$$<p>But we want to move toward real coaster geometry later, where slopes change every centimeter. So we replace the <code>acceleration</code> parameter and introduce two new parameters:</p>
<ul>
<li><strong>forwardDirection</strong>, a vector pointing forward along the track at the given distance</li>
<li><strong>gravity</strong>, the classic 9.81 m/s² thing</li>
</ul>
<p>We won&rsquo;t use <code>gravity * Math.sin(slopeAngle)</code> anymore, because once we have a forward direction, there is a cleaner way.</p>
<blockquote>
<p>We simply define a gravity direction vector.</p></blockquote>
<p>Gravity always points downward to Earth, basically along the negative y-axis:</p>
$$\vec{gravityDir} = \begin{bmatrix} 0 \\ -9.81 \end{bmatrix}$$<p>Now what do we do with <code>forwardDirection</code> and <code>gravityDirection</code>?
We take their dot product. That’s it. Really. That’s the whole trick:</p>
$$acceleration = \vec{forwardDir} \times \vec{gravityDir}$$<p>This one line replaces the entire downhill-slope acceleration formula thing:</p>
$$acceleration = gravity * sin(slopeAngle)$$<p>In code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector2</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>));
</span></span></code></pre></div><p>And our updated evaluateMotion function becomes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirection</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gravity</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>));
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">acceleration</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="answering-important-questions">Answering important questions</h2>
<p>Once the motion step gives us a <strong>distance traveled</strong>, we need to convert this number into something the renderer can actually work with.</p>
<p>Even the easiest possible track must answer <strong>two important questions</strong> for physics and visualization:</p>
<blockquote>
<p>Where is the 2D or 3D position at a given distance along the curve?</p></blockquote>
<p>Whether the track is straight or twisting like a crazy pretzel, the logic is the same.</p>
<ul>
<li>After traveling <strong>1 meter</strong>, we need the <strong>position at 1 meter</strong>.</li>
<li>After <strong>5 meters</strong>, we need the <strong>position at 5 meters</strong>.</li>
</ul>
<p>So we need a function that returns the position at any distance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">getPositionAtDistance</span>(<span style="color:#a6e22e">distance</span>);
</span></span></code></pre></div><p>We also need the forward direction at that distance, because the evaluation function requires it as an input, as we introduced just a few sentences above. So we must answer:</p>
<blockquote>
<p>What is the forward direction at a given distance along a curve?</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">getForwardDirectionAtDistance</span>(<span style="color:#a6e22e">distance</span>);
</span></span></code></pre></div><p>Both functions work purely on the curve geometry.</p>
<h2 id="getpositionatdistance-on-linear-curves">getPositionAtDistance on Linear “Curves”</h2>
<p>For linear curves, this is as easy as it gets. Later, we will switch to proper splines for real coaster geometry.</p>
<p>A linear curve has two control points: <code>cp1</code> and <code>cp2</code>, both simple 2D vectors. We use THREE.js for convenience.</p>
<h3 id="how-do-we-get-the-2d-position-at-a-distance">How do we get the 2D position at a distance?</h3>
<p>We linearly interpolate between the two points:</p>
$$ \vec{pos} = \vec{cp1} + (\vec{cp2} - \vec{cp1}) \cdot t $$<p>Where <strong>t</strong> is the fraction of the segment we’ve traveled:</p>
<ul>
<li>0 → cp1</li>
<li>1 → cp2</li>
<li>0.5 → halfway</li>
</ul>
<p><code>t</code> is computed by dividing the traveled distance by the segment length:</p>
$$ t = \frac{distance}{length} $$<p>Distance between control points:</p>
$$ length = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2} $$<p>Putting it all together:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getPositionAtDistance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">distance</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sqrt</span>((<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">x</span>) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">y</span>) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">distance</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span>: <span style="color:#66d9ef">cp1.x</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">x</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">y</span>: <span style="color:#66d9ef">cp1.y</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">y</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Or using <strong>THREE.js</strong> to save yourself some sanity and avoid reinventing the wheel over and over again. I explained this part without THREE.js as well, but you may just forget it, the articles get way too big if I try to explain every concept of vectors and math in detail. For now we simply know: THREE.js is our friend:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getPositionAtDistance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">distance</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">cp2</span>, <span style="color:#a6e22e">distance</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">cp2</span>));
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="how-to-calculate-forward-direction-along-the-curve">How to Calculate Forward Direction Along the Curve</h2>
<p>Since this is a linear curve, the forward direction is constant everywhere. It doesn’t get easier than this.</p>
<p>Mathematically:</p>
$$ \vec{forwardDir} = \frac{\vec{cp2} - \vec{cp1}}{\lVert \vec{cp2} - \vec{cp1} \rVert} $$<p>Translated into code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getForwardDirectionAtDistance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">distance</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">sub</span>(<span style="color:#a6e22e">cp1</span>).<span style="color:#a6e22e">normalize</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><h2 id="small-note">Small note</h2>
<p>Later the forward vector will be replaced by a <strong>4×4 matrix</strong>, which includes position, forward, right and up vectors all at once. That matrix will become our single source of truth, which makes it possible to reduce everything to just one method called <code>getMatrixAtDistance</code>. I know, yet again a change, but that’s future you’s problem. Ignore it for now.</p>
<p>Going forward, we will use <strong>9.81665 m/s²</strong> as the gravitational acceleration, since this is also the value used by <strong>NoLimits Roller Coaster</strong> and <strong>openFVD++</strong>.</p>
<h2 id="adding-everything-up">Adding Everything Up</h2>
<p>Time for a small demo. I built a basic setup: a visible line segment with draggable control points so you can adjust the slope in real time. On the side, a small panel displays the live simulation state.</p>
<p>I switched the vectors to 3D instead of 2D, but only because it makes things more convenient in THREE.js. The actual calculations from this article are exactly the same.</p>









<div class="embedded-iframe ">

  
  <a href="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/linear-roller-coaster-track.html" class="openInNewTab" style="width: 100%" target="_blank">Click here to open in a new tab</a>
  

  <iframe
    src="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/linear-roller-coaster-track.html"
    width="100%"
    height="300px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
<p>I’ve polished things a bit and moved the physics and linear interpolation logic into their own files instead of keeping everything as spaghetti code. The complete source code is available in my GitHub repo, feel free to explore and play around with it.</p>
<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/5-friction-and-air-resistance/">In the next chapter</a> we will introduce friction and air resistance. You’ll be able to play with the parameters in a demo and compare both physics evaluations, with and without energy loss.</p>
<h1 id="demo-code">Demo code</h1>
















<p>
    <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/scripts/src//posts/writing-a-roller-coaster-simulation/LinearRollerCoasterTrackScene.tsx" target="_blank" rel="noopener noreferrer">
        Click here to view the code on GitHub (opens in a new tab)
    </a>
</p>

<pre><code class="language-tsx">import React, { useEffect, useState } from &#39;react&#39;;
import { useFrame } from &#39;@react-three/fiber&#39;;
import { useControls } from &#39;leva&#39;;
import { Vector3 } from &#39;three&#39;;

import { ControlPoint } from &#39;../../components/ControlPoint&#39;;
import { DragControlPoints } from &#39;../../components/DragControlPoints&#39;;
import Line from &#39;../../components/Line&#39;;
import { getForwardDirectionAtDistance, getPositionAtDistance, length } from &#39;../../helper/linear&#39;;
import { evaluateMotionByForwardDirection } from &#39;../../helper/physics&#39;;
import useColors from &#39;../../hooks/useColors&#39;;
import OrthographicScene from &#39;../../scenes/OrthographicScene&#39;;

const LinearRollerCoasterTrack = () =&gt; {
  const colors = useColors();

  // Control points
  const [points, setPoints] = useState([new Vector3(-11.5, 3.2, 0), new Vector3(1.4, -2.8, 0)]);

  const [simulationState, setSimulationState] = useControls(() =&gt; ({
    velocity: 0,
    distanceTraveled: 0,
    acceleration: {
      value: 0,
      pad: 5,
    },
    gravity: {
      value: 9.81665,
      pad: 5,
    },
  }));

  // Main motion evaluation per frame
  useFrame((state, deltaTime) =&gt; {
    setSimulationState(
      evaluateMotionByForwardDirection(
        simulationState,
        getForwardDirectionAtDistance(points[0], points[1], simulationState.distanceTraveled),
        simulationState.gravity,
        deltaTime,
      ),
    );
  });

  // Reset simulation state if train overshoots track
  useEffect(() =&gt; {
    if (
      simulationState.distanceTraveled &gt; length(points[0], points[1]) ||
      simulationState.distanceTraveled &lt; 0
    ) {
      setSimulationState({
        velocity: 0,
        distanceTraveled: 0,
        acceleration: 0,
      });
    }
  }, [simulationState.distanceTraveled, setSimulationState, points]);

  const trainPosition = getPositionAtDistance(
    points[0],
    points[1],
    simulationState.distanceTraveled,
  );

  return (
    &lt;&gt;
      &lt;DragControlPoints axisLock=&#34;z&#34; points={points} setPoints={setPoints} /&gt;
      &lt;Line points={points} color={colors.secondary} /&gt;
      &lt;ControlPoint position={trainPosition} color={colors.highlight} /&gt;
    &lt;/&gt;
  );
};

export const LinearRollerCoasterTrackScene = () =&gt; {
  return (
    &lt;OrthographicScene&gt;
      &lt;LinearRollerCoasterTrack /&gt;
    &lt;/OrthographicScene&gt;
  );
};
</code></pre>

]]></content></item><item><title>Evaluating Motion</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/3-evaluating-motion/</link><pubDate>Sat, 06 Dec 2025 10:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/3-evaluating-motion/</guid><description>&lt;p&gt;Before we implement the function, there&amp;rsquo;s one small simplification we need to mention:
In this chapter we will always evaluate the motion every &lt;strong&gt;16 ms (0.016 seconds)&lt;/strong&gt;,
which corresponds to roughly &lt;strong&gt;60 frames per second&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Using a fixed time step makes the formulas easier to understand for this article.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: In real simulations or game engines, you usually don’t assume a constant time value. Instead, you take the actual delta time from the game loop, so that the motion stays consistent even if the frame rate changes. &lt;strong&gt;More on that later&lt;/strong&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Before we implement the function, there&rsquo;s one small simplification we need to mention:
In this chapter we will always evaluate the motion every <strong>16 ms (0.016 seconds)</strong>,
which corresponds to roughly <strong>60 frames per second</strong>.</p>
<p>Using a fixed time step makes the formulas easier to understand for this article.</p>
<blockquote>
<p><strong>Note</strong>: In real simulations or game engines, you usually don’t assume a constant time value. Instead, you take the actual delta time from the game loop, so that the motion stays consistent even if the frame rate changes. <strong>More on that later</strong>.</p></blockquote>
<p>But for the sake of clarity in this chapter:
We assume that every update happens exactly every <strong>16 ms</strong>.
This keeps the examples simple and lets us focus on the physics first.</p>
<p>Now that we know how acceleration works and how gravity affects the coaster depending on the slope, we can finally build the first real part of our simulation. The idea is simple. Every small time step we calculate how much the coaster changes its speed and how much distance it travels.</p>
<p>We start with a minimal simulation state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">simulationState</span>: <span style="color:#66d9ef">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>In the beginning, the coaster does not move and has not traveled any distance.</p>
<h2 id="the-evaluatemotion-function">The evaluateMotion function</h2>
<p>Our simulation works by creating a new state based on the previous state.
Think of it like this:</p>
<blockquote>
<p>initial state → evaluate → new state → evaluate → new state → &hellip;</p></blockquote>
<p>To calculate the acceleration along the slope, we now implement the downhill-slope acceleration formula from <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/2-gravity/">Chapter 2</a>. This formula tells us how much of gravity actually acts in the direction of the slope:</p>
$$acceleration = gravity * sin(slopeAngle)$$<p>So we end up basically with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slopeAngle</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>, <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><ul>
<li>slopeAngle controls how steep the slope is</li>
<li>deltaTime is how much time passed since the last calculation (we use 16 ms)</li>
</ul>
<h2 id="calculating-the-velocity">Calculating the velocity</h2>
<p>Acceleration is measured in <strong>m/s²</strong>.
That means:</p>
<blockquote>
<p><strong>m/s²</strong> tells us how much the velocity changes in one <strong>full second</strong>.</p></blockquote>
<p>So if acceleration is <strong>9.81 m/s²</strong>:</p>
<ul>
<li>after <strong>1 second</strong>, velocity increases by <strong>9.81 m/s</strong></li>
<li>so after <strong>0.016 seconds</strong>, velocity increases by \(9.81 * 0.016\)
Just multiply it with <strong>0.016</strong> :) that does the trick</li>
</ul>
$$velocity = acceleration * deltaTime$$<p>We take the previous velocity and add the small increase for this frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span></code></pre></div><h2 id="calculating-the-distance-traveled">Calculating the distance traveled</h2>
<p>Velocity is measured in <strong>m/s</strong>.
This means:</p>
<blockquote>
<p>velocity tells us how much <strong>distance</strong> is to travel in <strong>one full second</strong>.</p></blockquote>
<p>Again we only want the part that matches our <strong>0.016 seconds</strong>.</p>
$$distanceToTravel = velocity \cdot deltaTime$$<p>We take the previous distance traveled and add the small increase for this frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span></code></pre></div><p>So we end up with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>This is already a complete physics step without friction or air resistance.</p>
<h2 id="interactive-demo">Interactive demo</h2>
<p>Just like in the last chapter, we again have an interactive demo. This time, we’ve implemented a simple motion-evaluation method that applies basic physics. In this demo you can play around with the slope and already see a physical motion emerging.</p>
<blockquote>
<p><strong>Important note:</strong> Earlier in this article I said we would evaluate everything every <strong>16 ms</strong>, right? Well… that was kind of a lie, at least for this demo.<br>
Since we’re using <strong>THREE.js</strong>, we <em>can</em> make use of the <code>useFrame</code> hook, which gives us the <strong>delta time of the previous frame</strong>, and we benefit from using it. This is the proper way to handle updates, instead of forcing a fixed 16 ms step, which I briefly covered in the introduction of this chapter.</p></blockquote>









<div class="embedded-iframe ">

  
  <a href="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/evaluating-motion.html" class="openInNewTab" style="width: 100%" target="_blank">Click here to open in a new tab</a>
  

  <iframe
    src="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/evaluating-motion.html"
    width="100%"
    height="320px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/4-linear-roller-coaster-track/">In the next chapter</a> we’ll add a basic roller coaster track, just a straight, linear segment. This is a preparation for the real coaster curvatures we’ll build later.</p>
<h1 id="demo-code">Demo code</h1>
















<p>
    <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/scripts/src//posts/writing-a-roller-coaster-simulation/EvaluatingMotionScene.tsx" target="_blank" rel="noopener noreferrer">
        Click here to view the code on GitHub (opens in a new tab)
    </a>
</p>

<pre><code class="language-tsx">import React, { useEffect } from &#39;react&#39;;
import { useFrame } from &#39;@react-three/fiber&#39;;
import { useControls } from &#39;leva&#39;;
import { MathUtils, Vector3 } from &#39;three&#39;;

import { Arrow } from &#39;../../components/Arrow&#39;;
import { ControlPoint } from &#39;../../components/ControlPoint&#39;;
import Line from &#39;../../components/Line&#39;;
import { evaluateMotionByAcceleration } from &#39;../../helper/physics&#39;;
import useColors from &#39;../../hooks/useColors&#39;;
import OrthographicScene from &#39;../../scenes/OrthographicScene&#39;;

const EvaluatingMotion = () =&gt; {
  const colors = useColors();

  const [{ slope, gravity, sinSlope, trackLength, ...simulationState }, setSimulationState] =
    useControls(() =&gt; ({
      slope: {
        value: 0,
        step: 5,
        min: -180,
        max: 180,
      },
      trackLength: {
        value: 8,
        step: 1,
        min: 0,
        max: 20,
      },
      gravity: {
        value: 9.81665,
        pad: 5,
      },
      sinSlope: {
        disabled: true,
        label: &#39;sin(slope)&#39;,
        pad: 5,
        value: 0,
      },
      velocity: 0,
      distanceTraveled: 0,
      acceleration: {
        value: 0,
        pad: 5,
      },
    }));

  useEffect(() =&gt; {
    const sinSlope = Math.sin(MathUtils.degToRad(slope));
    const acceleration = gravity * sinSlope;

    setSimulationState({ acceleration, sinSlope });
  }, [slope, gravity, setSimulationState]);

  // Main motion evaluation per frame
  useFrame((state, deltaTime) =&gt; {
    setSimulationState(
      evaluateMotionByAcceleration(simulationState, simulationState.acceleration, deltaTime),
    );
  });

  // Reset simulation state if train overshoots track
  useEffect(() =&gt; {
    if (simulationState.distanceTraveled &lt; 0 || simulationState.distanceTraveled &gt; trackLength) {
      setSimulationState({
        velocity: 0,
        distanceTraveled: 0,
      });
    }
  }, [simulationState.distanceTraveled, trackLength, setSimulationState]);

  return (
    &lt;&gt;
      &lt;group position={[-5, 0, 0]} rotation={[0, 0, MathUtils.degToRad(slope)]}&gt;
        &lt;Arrow
          position={[-trackLength / 2, 0, 0]}
          rotation={[0, 0, Math.PI / 2]}
          color={colors.secondary}
        /&gt;

        &lt;ControlPoint
          position={new Vector3(trackLength / 2 - simulationState.distanceTraveled, 0, 0)}
        /&gt;

        &lt;Line
          points={[new Vector3(-trackLength / 2, 0, 0), new Vector3(trackLength / 2, 0, 0)]}
          color={colors.secondary}
        /&gt;
      &lt;/group&gt;
    &lt;/&gt;
  );
};

export const EvaluatingMotionScene = () =&gt; {
  return (
    &lt;OrthographicScene&gt;
      &lt;EvaluatingMotion /&gt;
    &lt;/OrthographicScene&gt;
  );
};
</code></pre>

]]></content></item><item><title>Gravity</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/2-gravity/</link><pubDate>Sat, 06 Dec 2025 09:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/2-gravity/</guid><description>&lt;h2 id="how-do-we-determine-the-acceleration-of-the-coaster"&gt;How do we determine the acceleration of the coaster?&lt;/h2&gt;
&lt;p&gt;To simplify things, we ignore air resistance, rolling friction and any other additional forces. We also assume Earth’s gravity is &lt;strong&gt;9.81 m/s²&lt;/strong&gt;. This allows us to focus entirely on the fundamental idea:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Gravity is the primary source of acceleration.&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;On Earth, gravity provides a constant acceleration of roughly &lt;strong&gt;9.81 m/s²&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;What does this number actually mean?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Every &lt;strong&gt;second&lt;/strong&gt;, an object&amp;rsquo;s speed increases by &lt;strong&gt;9.81 m/s&lt;/strong&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="how-do-we-determine-the-acceleration-of-the-coaster">How do we determine the acceleration of the coaster?</h2>
<p>To simplify things, we ignore air resistance, rolling friction and any other additional forces. We also assume Earth’s gravity is <strong>9.81 m/s²</strong>. This allows us to focus entirely on the fundamental idea:</p>
<blockquote>
<p><strong>Gravity is the primary source of acceleration.</strong></p></blockquote>
<p>On Earth, gravity provides a constant acceleration of roughly <strong>9.81 m/s²</strong>.</p>
<p>What does this number actually mean?</p>
<blockquote>
<p>Every <strong>second</strong>, an object&rsquo;s speed increases by <strong>9.81 m/s</strong>.</p></blockquote>
<p>Some quick examples:</p>
<ul>
<li>after <strong>1 second</strong> → 9.81 m/s</li>
<li>after <strong>2 seconds</strong> → 19.62 m/s</li>
<li>after <strong>3 seconds</strong> → 29.43 m/s</li>
</ul>
<p>In short: <strong>acceleration continuously increases an object&rsquo;s speed.</strong></p>
<hr>
<h2 id="acceleration-on-slopes">Acceleration on slopes</h2>
<p>Gravity is always pointing straight down.<br>
But on a slope, only a part of that force helps the coaster move along the track.</p>
<p>To compute that portion, we use the <strong>downhill-slope acceleration</strong>:</p>
$$acceleration = gravity \cdot sin(angle)$$<p>Where:</p>
<ul>
<li><strong>gravity</strong>: Earth’s gravity (9.81 m/s²)</li>
<li><strong>angle</strong>: the tilt of the track</li>
<li><strong>sin(angle)</strong>: how much of gravity points <strong>along</strong> the track</li>
</ul>
<h3 id="but-why">But why?</h3>
<p>For simplification, we only look at <strong>downward slopes</strong> at this point.<br>
Of course, in a real simulation we also have <strong>negative angles</strong> when the coaster travels uphill, but we will get to that later.</p>
<p>For these downhill angles, the relevant sine values lie between <strong>0 and 1</strong>:</p>
<ul>
<li><strong>sin = 0</strong> → no gravity along the track</li>
<li><strong>sin = 1</strong> → full gravity along the track</li>
</ul>
<h3 id="examples">Examples</h3>
<h4 id="vertical-drop-90"><strong>Vertical drop (90°)</strong></h4>
<p>Full gravity acts along the track, essentially free fall.</p>
<ul>
<li>sin(90°) = 1 (100% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>9.81 m/s²</strong></li>
</ul>
<hr>
<h4 id="45-slope"><strong>45° slope</strong></h4>
<p>You probably expected to get <strong>half of gravity</strong> here, right? Nope, it&rsquo;s not linear at all :D It’s a sine function.</p>
<ul>
<li>sin(45°) ≈ 0.707 (≈ 70% of <strong>gravity</strong>)</li>
<li>acceleration ≈ <strong>6.93 m/s²</strong></li>
</ul>
<hr>
<h4 id="flat-track-0"><strong>Flat track (0°)</strong></h4>
<p>No slope → no downhill force.</p>
<ul>
<li>sin(0°) = 0 (0% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>0 m/s²</strong></li>
</ul>
<hr>
<h2 id="why-this-matters-for-simulation">Why this matters for simulation</h2>
<p>As you can see, to simulate our coaster we only need to know:</p>
<blockquote>
<p><strong>the angle of the track at each point.</strong></p></blockquote>
<ul>
<li>0° → <strong>0 m/s²</strong>, no acceleration</li>
<li>45° → <strong>6.93 m/s²</strong>, about 70% of gravity</li>
<li>90° → <strong>9.81 m/s²</strong>, full gravity (free fall)</li>
</ul>
<p>And the crucial insight is:</p>
<blockquote>
<p><strong>This relationship is not linear, it&rsquo;s governed by sine.</strong></p></blockquote>
<p>This is why 45° does <em>not</em> give half of Earth&rsquo;s gravity, but roughly <strong>70%</strong>.</p>
<h2 id="interactive-example">Interactive Example</h2>
<p>When it comes to calculating the acceleration component along the slope, the formula ultimately reduces to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slope</span>);
</span></span></code></pre></div><blockquote>
<p>Keep in mind that <code>Math.sin</code> accepts <strong>radians</strong>, not <strong>degrees</strong>.</p>
<p>A <strong>radian</strong> is simply another way of measuring angles, where angles are expressed as multiples of <strong>π</strong>.</p>
<p>The range from <strong>−π to π</strong> corresponds to <strong>−180° to 180°</strong>.</p>
<p>In code, we almost always work with <strong>radians</strong>, because most math functions expect them. Degrees are typically used only for user input, since they are more intuitive.</p>
<p>When converting between the two, use:</p>
$$\text{radians} = \text{degrees} \cdot \frac{\pi}{180}$$<p>
</p>
$$\text{degrees} = \text{radians} \cdot \frac{180}{\pi}$$</blockquote>
<p>You can play around with <strong>different slopes</strong> and see how they affect the percentage of <strong>gravity applied</strong> to the coaster.
Having a visual representation of written concepts really helps me reach that <strong>I got it</strong> moment,
so it might help you as well.</p>









<div class="embedded-iframe ">

  
  <a href="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/gravity.html" class="openInNewTab" style="width: 100%" target="_blank">Click here to open in a new tab</a>
  

  <iframe
    src="https://ercanakyuerek.de//writing-a-roller-coaster-simulation/gravity.html"
    width="100%"
    height="300"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/3-evaluating-motion/">In the next chapter</a>, we’ll add motion evaluation and move a simple object along a linear plane.</p>
<h1 id="demo-code">Demo code</h1>
















<p>
    <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/scripts/src//posts/writing-a-roller-coaster-simulation/GravityScene.tsx" target="_blank" rel="noopener noreferrer">
        Click here to view the code on GitHub (opens in a new tab)
    </a>
</p>

<pre><code class="language-tsx">import React, { useEffect } from &#39;react&#39;;
import { useControls } from &#39;leva&#39;;
import { MathUtils, Vector3 } from &#39;three&#39;;

import { Arrow } from &#39;../../components/Arrow&#39;;
import Line from &#39;../../components/Line&#39;;
import useColors from &#39;../../hooks/useColors&#39;;
import OrthographicScene from &#39;../../scenes/OrthographicScene&#39;;

const Gravity = () =&gt; {
  const colors = useColors();
  const lineLength = 8;

  const [{ slope, gravity }, setState] = useControls(() =&gt; ({
    slope: {
      value: 0,
      step: 5,
      min: -180,
      max: 180,
    },
    gravity: {
      value: 9.81665,
      pad: 5,
    },
    sinSlope: {
      disabled: true,
      label: &#39;sin(slope)&#39;,
      pad: 5,
      value: 0,
    },
    acceleration: {
      disabled: true,
      value: 0,
      pad: 5,
    },
  }));

  useEffect(() =&gt; {
    const sinSlope = Math.sin(MathUtils.degToRad(slope));
    const acceleration = gravity * sinSlope;

    setState({ acceleration, sinSlope });
  }, [slope, gravity, setState]);

  return (
    &lt;&gt;
      &lt;group position={[-5, 0, 0]} rotation={[0, 0, MathUtils.degToRad(slope)]}&gt;
        &lt;Arrow
          position={[-lineLength / 2, 0, 0]}
          rotation={[0, 0, Math.PI / 2]}
          color={colors.secondary}
        /&gt;

        &lt;Line
          points={[new Vector3(-lineLength / 2, 0, 0), new Vector3(lineLength / 2, 0, 0)]}
          color={colors.secondary}
        /&gt;
      &lt;/group&gt;
    &lt;/&gt;
  );
};

export const GravityScene = () =&gt; {
  return (
    &lt;OrthographicScene&gt;
      &lt;Gravity /&gt;
    &lt;/OrthographicScene&gt;
  );
};
</code></pre>

]]></content></item><item><title>Introduction and Motion Dynamics</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/1-introduction-and-motion-dynamics/</link><pubDate>Sat, 06 Dec 2025 08:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/1-introduction-and-motion-dynamics/</guid><description>&lt;p&gt;You might have played around with JavaScript animations or small physics experiments before, but in this series we are going to take things a step further. We will build a simplified roller coaster simulation directly in the browser.&lt;/p&gt;
&lt;p&gt;My goal here isn’t to build some engineering-grade physics engine. I just want to recreate the kind of coaster &lt;strong&gt;physics&lt;/strong&gt; we all know from things like &lt;strong&gt;NoLimits Roller Coaster or other coasters in games&lt;/strong&gt;.
Nothing overly scientific, just the kind of system that behaves the way we intuitively expect.
In the end, the physics model will end up pretty close to what &lt;strong&gt;NoLimits Roller Coaster&lt;/strong&gt; does anyway, just without all the heavy engineering baggage.&lt;/p&gt;</description><content type="html"><![CDATA[<p>You might have played around with JavaScript animations or small physics experiments before, but in this series we are going to take things a step further. We will build a simplified roller coaster simulation directly in the browser.</p>
<p>My goal here isn’t to build some engineering-grade physics engine. I just want to recreate the kind of coaster <strong>physics</strong> we all know from things like <strong>NoLimits Roller Coaster or other coasters in games</strong>.
Nothing overly scientific, just the kind of system that behaves the way we intuitively expect.
In the end, the physics model will end up pretty close to what <strong>NoLimits Roller Coaster</strong> does anyway, just without all the heavy engineering baggage.</p>
<p>We will use technologies that are easy to access and quick to experiment with. Throughout the series, we will rely on <strong>TypeScript</strong>, <strong>React</strong> and <strong>THREE.js</strong>. This combination gives us a clean developer experience and allows us to turn mathematical concepts into visual, interactive 3D scenes with very little overhead.</p>
<p>The idea behind this series is simple. Instead of reading theory first, we will learn by building something fun. Each chapter focuses on a single concept. By the end, you will understand how a small coaster car can move along a track, how the track itself is defined, and how everything is drawn in the browser.</p>
<h2 id="setting-up-the-project">Setting up the project</h2>
<p>Before we start, I’ll assume you already have <strong>Node.js</strong> installed. If not, go ahead and download it first.</p>
<p>Also, a quick heads-up: if some of the scripts or tools I’m covering here don’t work on Windows, I’m sorry. There are ways to get a similar environment on <strong>Windows</strong>, for example, using <strong>WSL</strong>, but I’m not a <strong>Windows</strong> user, so I can’t really help there. I’m focusing on <strong>Linux</strong> and <strong>macOS</strong>, where the toolchains are very similar.</p>
<p>We’ll keep things simple. You can set up your stack, however, you like, but for this series I’ll just use <strong>Create React App</strong> with <strong>TypeScript</strong> and won’t bother with any extra tooling. The goal here is to explain the concepts, not to demonstrate how to engineer a perfectly structured project. That’s a whole different topic.</p>
<p>If you want to overengineer it, go for it. But for now, something as basic as this is completely fine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npx create-react-app roller-coaster-simulation --template typescript
</span></span></code></pre></div><p>Next, install a few useful dependencies. This is all we need for now. If I end up using another package later in the series and forgot to list it here, feel free to install it when you get to that part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm i leva three lodash @react-three/drei @react-three/fiber @types/three @types/lodash
</span></span></code></pre></div><blockquote>
<p><strong>Important note:</strong> In every article, I’ll show example code and link to the corresponding <strong>GitHub files</strong>. These files live inside my website’s blog repository, which contains a large <strong>shared script collection for all articles</strong>. This means the structure in the repo <strong>will differ</strong> from the snippets shown in the articles. For example, my <code>physics.ts</code> file contains multiple evaluation functions used across different posts, since we build things step by step from article to article. All iterations end up in the same file. So don’t worry if the repo looks more consolidated or structured differently than the examples shown here.</p></blockquote>
<blockquote>
<p><strong>Another important note</strong>: The example code in the articles <strong>will</strong> contain components that <strong>I don’t explicitly show or explain in the text</strong>. If you run into something unfamiliar, please check the GitHub repository and follow the imports to see how those components are implemented. <strong>Most of them are small helpers for things like drawing lines, rendering arrows, setting up scenes, and other utilities that would only distract from the main topic in the article itself</strong>.</p></blockquote>
<h2 id="motion-dynamics">Motion Dynamics</h2>
<p>At the end of the day, simulating a roller coaster comes down to one simple question:</p>
<p><strong>How much distance should the coaster travel in each simulation step?</strong></p>
<p>To keep things simple, let’s assume our simulation updates roughly every <strong>16 ms</strong>, which is what you would get at about 60 FPS. So the question becomes:</p>
<p><strong>How far does the coaster need to travel within these 16 ms?</strong></p>
<p>To answer this, we follow a very straightforward chain of logic:</p>
<ul>
<li><strong>To know the distance to travel, we first need the velocity</strong></li>
<li><strong>To know the velocity, we first need the acceleration</strong></li>
</ul>
<p>So everything begins with acceleration.
Acceleration changes the velocity, <strong>velocity determines the distance to travel</strong>, and the distance to travel tells us where the coaster ends up in the next 16 ms.</p>
<p>This gives us a simple structure:</p>
<blockquote>
<p>Acceleration → Velocity → Distance</p></blockquote>
<p>Once we understand the acceleration acting on the coaster, the rest follows naturally.</p>
<p>In the next chapter, we will take the first real step of the simulation and answer the core question: <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/2-gravity/">How do we determine the acceleration of the coaster?</a></p>
]]></content></item><item><title>First results and improved spline interpolation</title><link>https://ercanakyuerek.de/posts/rollercoaster-simulation/improved-spline-interpolation/</link><pubDate>Tue, 07 Mar 2023 00:30:20 +0100</pubDate><guid>https://ercanakyuerek.de/posts/rollercoaster-simulation/improved-spline-interpolation/</guid><description>&lt;p&gt;In the latest update I tracked down a couple of bugs that caused all those tiny jitters I
mentioned earlier. At first I thought they were just floating-point problems coming from
the WebAssembly module in the browser, but the real issue turned out to be the
&lt;strong&gt;roll interpolation&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Let me give you a quick overview of what’s going on. When we interpolate a NURBS track,
we first estimate the total track length using a pretty rough step size. Based on that
estimation, we generate a dense enough set of nodes. After that, we compute normals for
e very node and apply the normal angles on the &lt;strong&gt;x&lt;/strong&gt; and &lt;strong&gt;y&lt;/strong&gt; axes, the &lt;strong&gt;z&lt;/strong&gt; axis (the roll)
comes later. These normals get applied to the previous matrix, so the whole orientation
flows along the track. Once that’s done, we generate a &lt;strong&gt;C2-continuous cubic spline&lt;/strong&gt;, and
the z-rotation that results from applying the x/y normals is added to the roll value at
each roll point.&lt;/p&gt;</description><content type="html"><![CDATA[<p>In the latest update I tracked down a couple of bugs that caused all those tiny jitters I
mentioned earlier. At first I thought they were just floating-point problems coming from
the WebAssembly module in the browser, but the real issue turned out to be the
<strong>roll interpolation</strong>.</p>
<p>Let me give you a quick overview of what’s going on. When we interpolate a NURBS track,
we first estimate the total track length using a pretty rough step size. Based on that
estimation, we generate a dense enough set of nodes. After that, we compute normals for
e very node and apply the normal angles on the <strong>x</strong> and <strong>y</strong> axes, the <strong>z</strong> axis (the roll)
comes later. These normals get applied to the previous matrix, so the whole orientation
flows along the track. Once that’s done, we generate a <strong>C2-continuous cubic spline</strong>, and
the z-rotation that results from applying the x/y normals is added to the roll value at
each roll point.</p>
<p>The next step is to run through all nodes again and apply the actual roll (the z rotation).
And finally, when we want the transformation matrix at some distance along the track,
we simply binary-search for the two surrounding nodes and linearly interpolate between them.</p>
<p>This all works, but one thing caused trouble:<br>
I originally <strong>pre-applied the roll on every node</strong>, and that introduced precision errors
which showed up as visible jitter. The fix was pretty simple:
<strong>don’t bake the roll into every node</strong>. Instead, keep it separate and apply the roll
only when someone asks for a matrix at a specific distance. That completely removes the jitter.</p>
<p>On top of that, I cleaned up the interpolation loop so we only iterate through
the nodes <strong>once</strong>, which gave a nice performance boost.</p>
<h2 id="whats-next">What&rsquo;s Next?</h2>
<p>Now that the interpolation system is finally stable, I’ve
started working on <strong>multi-track support</strong>. It’s a bit tricky, but nothing too dramatic.
Once that’s in place, the next step will be to build a <strong>basic block system</strong>, which will
finally bring us closer to a real, fully working roller coaster simulation.</p>









<div class="embedded-iframe ">

  
  <a href="https://ercanakyuerek.de//roller-coaster-simulation/simulator-1.html" class="openInNewTab" style="width: 100%" target="_blank">Click here to open in a new tab</a>
  

  <iframe
    src="https://ercanakyuerek.de//roller-coaster-simulation/simulator-1.html"
    width="100%"
    height="600px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
]]></content></item><item><title>JavaScript module</title><link>https://ercanakyuerek.de/posts/wasi/4-javascript-module/</link><pubDate>Mon, 27 Feb 2023 17:45:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/4-javascript-module/</guid><description>&lt;p&gt;This is the point where we will develop our &lt;code&gt;JavaScript&lt;/code&gt; library that utilizes the functions exposed in the &lt;code&gt;WebAssembly&lt;/code&gt; module. I have created a simple template for this purpose. You may notice that we are defining some imports for &lt;code&gt;WASI&lt;/code&gt;, but they are all empty. Allow me to explain what &lt;code&gt;WASI&lt;/code&gt; is and what it aims to achieve. &lt;code&gt;WASI&lt;/code&gt; is an attempt to create specifications similar to the &lt;code&gt;POSIX&lt;/code&gt; standard, which can be implemented across different runtimes, such as browsers or regular machines, and provides access to system-specific functions, such as file systems. However, for our library, which only needs to perform calculations, we do not require a complex runtime environment. This is why our functions are empty. Some may argue that we should use the Emscripten SDK instead of the &lt;code&gt;WASI SDK&lt;/code&gt;, but I believe that the &lt;code&gt;WASI SDK&lt;/code&gt; is the future. It produces smaller binaries and has fewer complications compared to &lt;code&gt;Emscripten&lt;/code&gt;. There are official efforts to import standard &lt;code&gt;WASI&lt;/code&gt; functions for the &lt;code&gt;browser&lt;/code&gt;, but unfortunately, they do not seem to work unless a &lt;code&gt;WebAssembly module&lt;/code&gt; is instantiated within a &lt;code&gt;worker&lt;/code&gt;. If there are any changes in the future regarding this matter, I will update my articles accordingly. &lt;a href="https://github.com/wasmerio/wasmer-js"&gt;Here&lt;/a&gt; is the mentioned attempt to bring a &lt;code&gt;WASI runtime&lt;/code&gt; to &lt;code&gt;browsers&lt;/code&gt;. If you can load a &lt;code&gt;WASM file&lt;/code&gt; outside the &lt;code&gt;worker&lt;/code&gt;, just email me your solution and I will include it here! &amp;#x1f604;&lt;/p&gt;</description><content type="html"><![CDATA[<p>This is the point where we will develop our <code>JavaScript</code> library that utilizes the functions exposed in the <code>WebAssembly</code> module. I have created a simple template for this purpose. You may notice that we are defining some imports for <code>WASI</code>, but they are all empty. Allow me to explain what <code>WASI</code> is and what it aims to achieve. <code>WASI</code> is an attempt to create specifications similar to the <code>POSIX</code> standard, which can be implemented across different runtimes, such as browsers or regular machines, and provides access to system-specific functions, such as file systems. However, for our library, which only needs to perform calculations, we do not require a complex runtime environment. This is why our functions are empty. Some may argue that we should use the Emscripten SDK instead of the <code>WASI SDK</code>, but I believe that the <code>WASI SDK</code> is the future. It produces smaller binaries and has fewer complications compared to <code>Emscripten</code>. There are official efforts to import standard <code>WASI</code> functions for the <code>browser</code>, but unfortunately, they do not seem to work unless a <code>WebAssembly module</code> is instantiated within a <code>worker</code>. If there are any changes in the future regarding this matter, I will update my articles accordingly. <a href="https://github.com/wasmerio/wasmer-js">Here</a> is the mentioned attempt to bring a <code>WASI runtime</code> to <code>browsers</code>. If you can load a <code>WASM file</code> outside the <code>worker</code>, just email me your solution and I will include it here! &#x1f604;</p>
<h2 id="instantiate-a-module">Instantiate a module</h2>
<p>Let&rsquo;s create a small boilerplate code for this purpose in the <code>index.js</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glue</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#34;./glue.wasm&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">libCalculation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> (<span style="color:#a6e22e">wasmFileResponsePromise</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">Memory</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">initial</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">maximum</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10000</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">module</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">compileStreaming</span>(<span style="color:#a6e22e">wasmFileResponsePromise</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">module</span>, {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">wasi_snapshot_preview1</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">environ_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">environ_sizes_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_close</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_fdstat_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_read</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_write</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">proc_exit</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_seek</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_fdstat_set_flags</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_prestat_get</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">fd_prestat_dir_name</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">path_open</span><span style="color:#f92672">:</span> () =&gt; {},
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memory</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ... here comes our wrapped functions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// ... going to export them here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    };
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">default</span> <span style="color:#a6e22e">libCalculation</span>;
</span></span></code></pre></div><p>We will need to discuss memory later, particularly linear memory. For now, let&rsquo;s wrap some WebAssembly functions. We will start with an easy one, <code>getSplineLength</code>. We can get the function from the <code>instance.exports</code> and call it with the spline pointer. This function returns a float, so there is no need for any special handling here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSplineLength</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">splinePointer</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">getSplineLength</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">splinePointer</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Let&rsquo;s move on to a more complicated function, <code>getSplinePositionAtDistance</code>. We also need to get the function from the exports and call it with the <code>spline pointer</code> and a <code>distance</code>. However, we need to handle the <code>3D vector</code> pointer from the function&rsquo;s return in order to extract the float <code>x, y, and z</code> values from the <code>3D vector</code>.The <code>3D vector</code> includes three <code>float</code> values. That&rsquo;s why we use <code>Float32Array</code> instead of <code>Float64Array</code>, which would be used for doubles. The first argument is the memory itself, the second one is the <code>position</code> in the <code>memory</code> (a pointer is simply a number), and we want to extract <code>3x 32bit values</code>, which perfectly match <code>3x float for x, y, and z</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">getSplinePositionAtDistance</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">splinePointer</span>, <span style="color:#a6e22e">distance</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">getSplinePositionAtDistance</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span>, <span style="color:#a6e22e">memory</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positionPointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">splinePointer</span>, <span style="color:#a6e22e">distance</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>, <span style="color:#a6e22e">positionPointer</span>, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we reached an interesting function, createSpline, which takes four parameters of type <code>3d vector</code>. In this case we can just allocate <code>4x3x32bit</code>, four control points, <code>x, y, z</code> for each point, each point is a float which are <code>32bit</code>, which makes <code>48 bytes</code> in total. So we first need to allocate <code>48 bytes</code>. For this, we can easily use our malloc function, which we exposed in the webassembly module. I know, this is NOT a perfect solution, and there are some limitations, when I come up with better solutions, there will be some changes. So, at javascript side, we need to allocate <code>48 bytes</code>, put all <code>p0 - p1</code> coordinates in to the memory and pass the memory pointer to the arguments. We also can allocate for each parameter, so we can all <code>4 times malloc</code> with <code>12 bytes</code> each malloc. I decided to do the latter.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">createSpline</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>, <span style="color:#a6e22e">p3</span>) =&gt; {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">createSpline</span> <span style="color:#f92672">:</span> <span style="color:#a6e22e">func</span>, <span style="color:#a6e22e">malloc</span>, <span style="color:#a6e22e">memory</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointers</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>, <span style="color:#a6e22e">p3</span>].<span style="color:#a6e22e">map</span>(<span style="color:#a6e22e">point</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>); <span style="color:#75715e">// (x, y, z) * 4 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">pointer</span>, <span style="color:#ae81ff">3</span>).<span style="color:#a6e22e">set</span>(<span style="color:#a6e22e">point</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pointer</span>;
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>export all function &#x1f604;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">createSpline</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getSplinePositionAtDistance</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">getSplineLength</span>
</span></span><span style="display:flex;"><span>    };
</span></span></code></pre></div><h2 id="testing-our-library">Testing our library</h2>
<p>For testing purposes, you can create an <code>index.html</code> file and install the <code>http-serve</code> package by running the command <code>npm install http-serve --save-dev</code>. To start the server, run the command <code>node_modules/.bin/http-server .</code> and include the following content in the <code>index.html</code> file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">type</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;module&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">import</span> <span style="color:#a6e22e">libCalculation</span> <span style="color:#a6e22e">from</span> <span style="color:#e6db74">&#39;./index.js&#39;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">init</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">async</span> () =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">createSpline</span>, <span style="color:#a6e22e">getSplineLength</span>, <span style="color:#a6e22e">getSplinePositionAtDistance</span> } <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">libCalculation</span>(<span style="color:#a6e22e">fetch</span>(<span style="color:#e6db74">&#34;glue.wasm&#34;</span>));
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">spline</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">createSpline</span>([<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>]);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">splineLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSplineLength</span>(<span style="color:#a6e22e">spline</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">getSplinePositionAtDistance</span>(<span style="color:#a6e22e">spline</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">log</span>({ <span style="color:#a6e22e">splineLength</span>, <span style="color:#a6e22e">position</span> });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">init</span>();
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div>








<div class="embedded-iframe ">

  

  <iframe
    src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/libCalculation/example.html"
    width="100%"
    height="300px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
</div>
<p>Please check the console for a spline with a length of <code>10.06</code>. The position we fetched should return a 3D vector with coordinates of <code>[-3, -3, 0]</code>.
Next to this text, you can view an advanced test that displays a spline. I have created a <a href="https://github.com/geforcefan/ercanakyuerek.de/tree/main/static/wasi-sdk-writing-library-in-cpp/libCalculation">repository</a> that contains all the necessary files, including this advanced example that uses THREE.js for rendering.</p>
<h2 id="conclusion">Conclusion</h2>
<p>That&rsquo;s all! It wasn&rsquo;t that difficult, was it? We haven&rsquo;t yet covered other complex types, such as passing strings to and from WebAssembly modules, or how to log. However, you should have a rough idea of how things work now. In future articles, I will explore data types, memory management, and binding in greater depth. To be honest, gluing code together is not enjoyable. It requires creating glue code on the C++ side and a wrapper JavaScript module that <code>serializes</code> and <code>unserializes</code> arguments and return values. Some solutions eliminate the need for writing both code pieces, but for now, this should help you get started, especially if you aim to build a small yet performance-critical library.</p>
]]></content></item><item><title>Implementing library functions</title><link>https://ercanakyuerek.de/posts/wasi/3-implementing-library-functions/</link><pubDate>Fri, 24 Feb 2023 00:19:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/3-implementing-library-functions/</guid><description>&lt;div class="embedded-iframe float-right"&gt;
&lt;iframe
src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/spline.html"
width="225px"
height="225px"
style="border: 0"
class="iframe"
&gt;&lt;/iframe&gt;
&lt;div class="description" style="width: 225px"&gt;Transition from parameter-based non-uniform to uniform node spacing. The control points are draggable.&lt;/div&gt;
&lt;/div&gt;
&lt;p&gt;In this article, we&amp;rsquo;ll be exploring a more interesting example where we&amp;rsquo;ll construct a Bézier curve, evaluate nodes on it, and write a function that gives any position on the curve by a length parameter. To explain briefly, a Bézier curve is represented by a parameter &lt;code&gt;t&lt;/code&gt;, which varies between 0 and 1 and determines the position of nodes on the curve. However, this &lt;code&gt;t&lt;/code&gt; value doesn&amp;rsquo;t produce uniform spacing, which is problematic when we want to evaluate a point on the curve based on its distance. To solve this, we can evaluate some nodes along the curve with known distances and then linearly interpolate new nodes between them to find the point we&amp;rsquo;re looking for.&lt;/p&gt;</description><content type="html"><![CDATA[








<div class="embedded-iframe float-right">

  

  <iframe
    src="https://ercanakyuerek.de//wasi-sdk-writing-library-in-cpp/spline.html"
    width="225px"
    height="225px"
    style="border: 0"
    class="iframe"
  ></iframe>

  
  <div class="description" style="width: 225px">Transition from parameter-based non-uniform to uniform node spacing. The control points are draggable.</div>
  
</div>
<p>In this article, we&rsquo;ll be exploring a more interesting example where we&rsquo;ll construct a Bézier curve, evaluate nodes on it, and write a function that gives any position on the curve by a length parameter. To explain briefly, a Bézier curve is represented by a parameter <code>t</code>, which varies between 0 and 1 and determines the position of nodes on the curve. However, this <code>t</code> value doesn&rsquo;t produce uniform spacing, which is problematic when we want to evaluate a point on the curve based on its distance. To solve this, we can evaluate some nodes along the curve with known distances and then linearly interpolate new nodes between them to find the point we&rsquo;re looking for.</p>
<p>While this is a specific example, it involves &ldquo;complex&rdquo; types such as custom structs and 3D vectors that will need to be accessed from a web browser. So it should serve as a useful case for testing our library &#x1f604;</p>
<h2 id="adding-a-third-party-library">Adding a third party library</h2>
<p>I mentioned 3D vectors, so there is a well-known library called <code>glm</code>. I know that this is an overkill library for our &ldquo;simple&rdquo; problem, but it serves the purpose of showing how to add other libraries to our project. Ideally, the 3rd party library also has a CMake ecosystem. Otherwise, we need to be creative, fortunately. <code>glm</code> provides CMake files. My approach is to add a git submodule into the root directory by calling:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git submodule add https://github.com/g-truc/glm.git
</span></span></code></pre></div><p>We must include the glm directory as an include in our root <code>CMakeList.txt</code>, as the glm library is a header-only library and does not need to be linked against anything:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>include_directories(<span style="color:#e6db74">glm</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="spline-implementation">Spline implementation</h2>
<p>In summary, I have developed a solution for the problem discussed earlier, but I won&rsquo;t delve too deeply into the technical details. The primary function of my implementation, <code>bezier_fast</code>, computes the position on a bezier curve based on a given <code>t</code> parameter. Additionally, <code>estimate_length</code> is used to calculate the curve&rsquo;s length very quickly with a <code>low step size</code>. This estimation is necessary to determine how many nodes we should evaluate. With this method, we can create densely populated nodes depending on the curve&rsquo;s length. The evaluate function executes the procedure I just described. Naturally, we can always measure the distance between the evaluated position and the previous one to obtain the curve&rsquo;s total length, which we simply pass through the <code>get_length</code> function. Lastly, <code>get_position_at_distance</code> searches for the minimum node at a specified distance and linearly interpolates the position to the next node. We have successfully achieved the ability to evaluate uniformly spaced points on the curve.</p>
<p><code>src/spline.cc:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;spline.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/geometric.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> spline<span style="color:#f92672">::</span>evaluate() {
</span></span><span style="display:flex;"><span>    nodes.clear();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> numberOfNodes <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(estimate_length() <span style="color:#f92672">*</span> <span style="color:#ae81ff">20.0f</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>numberOfNodes) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> distance <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> numberOfNodes; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) i <span style="color:#f92672">/</span> (<span style="color:#66d9ef">float</span>) (numberOfNodes <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 position <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        distance <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(position, lastPos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        nodes.push_back({
</span></span><span style="display:flex;"><span>            .position <span style="color:#f92672">=</span> position,
</span></span><span style="display:flex;"><span>            .distance <span style="color:#f92672">=</span> distance
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> position;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 spline<span style="color:#f92672">::</span>bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span><span style="color:#f92672">-</span>t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b0 <span style="color:#f92672">=</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b3 <span style="color:#f92672">=</span> t <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b0 <span style="color:#f92672">*</span> p0  <span style="color:#f92672">+</span> b1 <span style="color:#f92672">*</span> p1 <span style="color:#f92672">+</span> b2 <span style="color:#f92672">*</span> p2 <span style="color:#f92672">+</span> b3 <span style="color:#f92672">*</span> p3;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> spline<span style="color:#f92672">::</span>estimate_length() {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">15</span>; i<span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) (i) <span style="color:#f92672">/</span> <span style="color:#ae81ff">14.0f</span>;
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 pos <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        length <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(pos, lastPos);
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> pos;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> length;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 spline<span style="color:#f92672">::</span>get_position_at_distance(<span style="color:#66d9ef">float</span> distance) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nodes.size() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>vec3(<span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> nextNode <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>lower_bound(nodes.begin(), nodes.end(), distance, [](<span style="color:#66d9ef">auto</span> a, <span style="color:#66d9ef">double</span> value) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> a.distance <span style="color:#f92672">&lt;</span> value; });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> currentNode <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isFirst <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">==</span> nodes.begin();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isLast <span style="color:#f92672">=</span> currentNode <span style="color:#f92672">==</span> nodes.end();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isFirst) <span style="color:#66d9ef">return</span> nodes[<span style="color:#ae81ff">0</span>].position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isLast) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> t <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nextNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">&gt;</span> std<span style="color:#f92672">::</span>numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span><span style="color:#f92672">&gt;::</span>epsilon()) {
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>max(std<span style="color:#f92672">::</span>min((distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance) <span style="color:#f92672">/</span> (nextNode<span style="color:#f92672">-&gt;</span>distance <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>distance), <span style="color:#ae81ff">1.0f</span>), <span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>mix(currentNode<span style="color:#f92672">-&gt;</span>position, nextNode<span style="color:#f92672">-&gt;</span>position, t);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> spline<span style="color:#f92672">::</span>get_length() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>nodes.empty()) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].distance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>src/spline.h:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#ifndef LIBCALCULATION_SPLINE_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIBCALCULATION_SPLINE_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/vec3.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">node</span> {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> distance;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">spline</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    spline(<span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp1, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp2, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp3, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp4) <span style="color:#f92672">:</span> cp1(cp1), cp2(cp2),
</span></span><span style="display:flex;"><span>                                                                                                     cp3(cp3),
</span></span><span style="display:flex;"><span>                                                                                                     cp4(cp4) {
</span></span><span style="display:flex;"><span>        evaluate();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 get_position_at_distance(<span style="color:#66d9ef">float</span> distance);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">get_length</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 cp1, cp2, cp3, cp4;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>node<span style="color:#f92672">&gt;</span> nodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> glm<span style="color:#f92672">::</span>vec3 bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">estimate_length</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">evaluate</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">//LIBCALCULATION_SPLINE_H
</span></span></span></code></pre></div><h2 id="gluing-the-pieces-of-our-library">Gluing the Pieces of our library</h2>
<p>We still cannot use the functions yet, so we need to create glue code to expose them to the outside world. Our goal is to use this spline library in our browser, for example, to draw a uniformly spaced Bezier curve. We will expose three functions: <code>createSpline</code>, <code>getSplineLength</code>, and <code>getSplinePositionAtDistance</code>. Some of these functions return complex types, such as a <code>3D vector</code>, which we will handle on the JavaScript side. There are many techniques to pass complex data from and to our WebAssembly module, which we will discuss in detail later. For now, let&rsquo;s focus on creating some glue code in <code>glue/glue.cc</code>.</p>
<h3 id="data-types">Data types</h3>
<p>As mentioned several times before, passing complex data types in and out can be challenging, but it can be managed. Passing 32 and 64 bit integers and decimal numbers is natively supported, so there is no need to worry about those. However, passing types such as a <code>3D vector</code> is a different matter. We need to allocate memory on the JavaScript side, assign the <code>3D vector</code> data (3x <code>floats</code>) to a free memory space, and pass the location (pointer) to the function calls. If we return complex data from the WebAssembly module, we will get a pointer and access the data in memory and &ldquo;demangle&rdquo; it (for example, using <code>Float64Array</code> with the pointer as offset and length of 3 to access x, y, z data). We will delve deeper into this later.</p>
<h3 id="createspline-function">createSpline function</h3>
<p>This is a straightforward process. We replicate the original constructor and expose this new function using the <code>attribute((export_name(&quot;createSpline&quot;)))</code> attribute to make it available to the outside world. As shown, we return a pointer, which will be a number on the JavaScript side and can be used to access memory data later. To ensure that we can access the data of the 3d vector in memory on the JavaScript side, it is crucial that the parameters of the vector are also pointers. This is because we allocate memory on the JavaScript side and assign our vector data to that memory location.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;createSpline&#34;</span>)))
</span></span><span style="display:flex;"><span>spline <span style="color:#f92672">*</span>createSpline(glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp1, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp2, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp3, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp4) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">spline</span>(<span style="color:#f92672">*</span>cp1, <span style="color:#f92672">*</span>cp2, <span style="color:#f92672">*</span>cp3, <span style="color:#f92672">*</span>cp4);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="getsplinelength-function">getSplineLength function</h3>
<p>This function returns a <code>float</code>, so no need to handle any extra complex data stuff on the JavaScript side:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;getSplineLength&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> getSplineLength(spline <span style="color:#f92672">*</span>s) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> s<span style="color:#f92672">-&gt;</span>get_length();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="getsplinepositionatdistance-function">getSplinePositionAtDistance function</h3>
<p>This function returns a pointer to a <code>3d vector</code>, which allows us to access its data in memory on the <code>JavaScript</code> side. Therefore, we need to allocate a new space for the returned <code>3d vector</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;getSplinePositionAtDistance&#34;</span>)))
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>getSplinePositionAtDistance(spline <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">float</span> distance) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> glm<span style="color:#f92672">::</span>vec3(s<span style="color:#f92672">-&gt;</span>get_position_at_distance(distance));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="malloc">malloc</h3>
<p>I understand that this may not be the most optimal approach for memory allocation, but it is currently working for my purposes. I may consider revising my implementation at a later time, but for now, we can utilize the <code>malloc</code> function from the <code>JavaScript</code> side. This is necessary for allocating memory to data that we want to pass to the <code>WebAssembly</code> functions, such as <code>3D vectors</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;malloc&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>allocateMemory(size_t size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">malloc</span>(size);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="build">Build</h2>
<p>At this point, you can run a build by executing <code>npm run build</code>. It should compile without any errors. In the next section, we will create a small <code>JavaScript</code> module that initializes the <code>WebAssembly</code> module, wraps the exposed functions, and handles incoming and outgoing data types. This <code>JavaScript</code> module can be used in your project just like any other <code>ES6 module</code>.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/4-javascript-module/">Now, let&rsquo;s create a small JavaScript module that will be responsible for creating a WebAssembly module, loading our Wasm file, defining some imports for WASI (which will mostly be empty), and creating functions for those that we exported in our C++ glue code.</a></p>
]]></content></item><item><title>CMake and build scripts</title><link>https://ercanakyuerek.de/posts/wasi/2-cmake-and-build-scripts/</link><pubDate>Thu, 23 Feb 2023 23:15:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/2-cmake-and-build-scripts/</guid><description>&lt;p&gt;To simplify the building process, we can create a build script. We have already defined some scripts in our &lt;code&gt;package.json&lt;/code&gt; file. At this point, the &lt;code&gt;build-wasm.js&lt;/code&gt; file is still empty, so we can create a basic script that first deletes an existing &lt;code&gt;build&lt;/code&gt; folder, creates a new one, and runs &lt;code&gt;cmake ..&lt;/code&gt; inside it. We will be using a WASI-SDK docker image from &lt;code&gt;ghcr.io/webassembly/wasi-sdk&lt;/code&gt; to run cmake and eventually compile the project via &lt;code&gt;make&lt;/code&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<p>To simplify the building process, we can create a build script. We have already defined some scripts in our <code>package.json</code> file. At this point, the <code>build-wasm.js</code> file is still empty, so we can create a basic script that first deletes an existing <code>build</code> folder, creates a new one, and runs <code>cmake ..</code> inside it. We will be using a WASI-SDK docker image from <code>ghcr.io/webassembly/wasi-sdk</code> to run cmake and eventually compile the project via <code>make</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">rm</span>, <span style="color:#a6e22e">mkdir</span>, <span style="color:#a6e22e">exec</span>, <span style="color:#a6e22e">cp</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;shelljs&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">join</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;path&#34;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">compileOnly</span>, <span style="color:#a6e22e">run</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;args-parser&#34;</span>)(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">argv</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">paths</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;build&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueSource</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;build&#34;</span>, <span style="color:#e6db74">&#34;glue&#34;</span>, <span style="color:#e6db74">&#34;glue&#34;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueDestination</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#34;glue.wasm&#34;</span>),
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">compileOnly</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#34;-rf&#34;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#34;-rf&#34;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk cmake -DCMAKE_BUILD_TYPE=Release ..&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk make -j 10&#34;</span>
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueSource</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span></code></pre></div><p>We will provide CMake directives for automatically adding all <code>*.cc</code> files in the <code>glue</code> and <code>src</code> directories. If you prefer using the <code>.cpp</code> extension instead, feel free to modify the files accordingly. We will also ensure that we build a static library by using the <code>STATIC</code> keyword in the add_library function. Therefore, the content of the <code>src/CMakeLists.txt</code> file is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">STATIC</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#e6db74">calculation::calculation</span> <span style="color:#e6db74">ALIAS</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The <code>glue/CMakeLists.txt</code> file will slightly differ from the one in <code>src</code>. As mentioned earlier, <code>glue</code> will serve as the final WebAssembly &ldquo;application&rdquo; that statically links our <code>calculation</code> library and exposes manually exported functions. We&rsquo;ll need to handle complex data types such as <code>vectors</code> and <code>structs</code>, but we&rsquo;ll cover that in the next chapters. For now, it&rsquo;s important to understand that <code>glue</code> is essentially our end product that links to our <code>calculation</code> library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#e6db74">glue</span> <span style="color:#e6db74">calculation::calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Now we need to bring everything together in the <code>CMakeList.txt</code> file in our root directory, which basically means adding the directories <code>glue</code> and <code>src</code>, setting some optimization flags for release mode, and disabling exceptions for WASI since exceptions are currently not supported by WASI-SDK. Here&rsquo;s what the file should look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>cmake_minimum_required (<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.9</span> <span style="color:#e6db74">FATAL_ERROR</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project (<span style="color:#e6db74">CALCULATION</span> <span style="color:#e6db74">LANGUAGES</span> <span style="color:#e6db74">CXX</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.1.0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">14</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_FLAGS_RELEASE</span> <span style="color:#e6db74">&#34;-O3&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Disable exceptions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if (<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;WASI&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">REGEX</span> <span style="color:#e6db74">REPLACE</span> <span style="color:#e6db74">&#34;-fexceptions&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#f92672">${</span>CMAKE_CXX_FLAGS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#e6db74">&#34;${CMAKE_CXX_FLAGS} -fno-exceptions&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include_directories(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>To test our setup, we need to add a main function to the file <code>glue/glue.cc</code>. The files <code>spline.cc</code> and <code>spline.h</code> can remain empty for now as they are not necessary to test our setup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {}
</span></span></code></pre></div><p><img src="/wasi-sdk-writing-library-in-cpp/final_structure.png" alt="final structure"></p>
<p>Finally, we can run our build script and see what happens &#x1f604;. To run the build script, simply execute <code>npm run build</code>. After it finishes executing, there should be a newly created file in the root directory named <code>glue.wasm</code>, which confirms that our setup is correct. However, this file does not have any functionality at the moment, <a href="https://ercanakyuerek.de/posts/wasi/3-implementing-library-functions/">but that will change in the next chapter.</a></p>
]]></content></item><item><title>Folder structure</title><link>https://ercanakyuerek.de/posts/wasi/1-folder-structure/</link><pubDate>Thu, 23 Feb 2023 22:00:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/1-folder-structure/</guid><description>&lt;p&gt;You may have already heard that it&amp;rsquo;s possible to write certain parts of your web application using languages like C++ or Rust and compile them into WebAssembly. WebAssembly is a binary format that allows code to be executed on the web and is designed to be efficient, secure, and portable. There are use cases where WebAssembly can be particularly beneficial, such as performing complex and resource-intensive computations for real-time applications or mathematical operations.&lt;/p&gt;</description><content type="html"><![CDATA[<p>You may have already heard that it&rsquo;s possible to write certain parts of your web application using languages like C++ or Rust and compile them into WebAssembly. WebAssembly is a binary format that allows code to be executed on the web and is designed to be efficient, secure, and portable. There are use cases where WebAssembly can be particularly beneficial, such as performing complex and resource-intensive computations for real-time applications or mathematical operations.</p>
<p>As of the time of writing this article in 2023, there are available bindings for Rust programming language. However, when it comes to <code>C++</code>, I was not able to find any mature solution except for the <a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/WebIDL-Binder.html">WebIDL Binder for Emscripten</a>. Unfortunately, my experience with it did not produce satisfactory results. Perhaps in the future, I will explore other binding solutions and update this series of articles. For now, we will have to manually glue our code. This involves creating bindings to enable the exchange of complex data between WebAssembly modules and exposing functions.</p>
<h2 id="using-webassembly-as-a-regular-javascript-module">Using WebAssembly as a Regular JavaScript Module</h2>
<p>This is a crucial aspect that I wish to explore. I want to write parts of my application in C++ and use them as regular modules in JavaScript. As previously mentioned, there is no NPM infrastructure available for compiling or generating bindings that can produce JavaScript files that export modules with exposed C++ functions. In this series, we will construct a minimalist infrastructure that emulates familiar module structures.</p>
<h2 id="building-an-example-library-for-computing-bezier-curves">Building an Example Library for Computing Bezier Curves</h2>
<p>For this article, we will create a very minimalistic library for computing bezier curves. We will set up this project in a way that the library can be used in a regular C++ application, as well as in a web application.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Please ensure that you have installed both <code>Node.js</code> and <code>Docker</code> on your computer. We will utilize the WASI-SDK Docker image for constructing the WebAssembly library.</p>
<h2 id="project-structure">Project structure</h2>
<p>First, let&rsquo;s create a folder named <code>libComputation</code> and run <code>npm init</code> inside the folder, following the input instructions. After initializing an npm project, replicate this folder structure and create the following files:</p>
<pre tabindex="0"><code class="language-ls" data-lang="ls">libComputation
    glue
        CMakeLists.txt
        glue.cc
    src
        CMakeLists.txt
        spline.cc
        spline.h
    CMakeLists.txt
    build-wasm.js
    index.js
</code></pre><p>As you can see, this resembles a regular CMake project with WebAssembly compilation additions.
We will use <code>build-wasm.js</code> for compilation purposes, and for that, we need to install some npm
modules for creating directories and parsing arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install shelljs args-parser --save-dev
</span></span></code></pre></div><p>Now, add the following build scripts in the <code>package.json</code> file, which we will use for different use cases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scripts&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;build&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;compile&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js --compileOnly&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see, there is a folder named <code>glue</code>. In this subdirectory,
we will define all exports and bindings to the WebAssembly Module,
so that all files inside the <code>src</code> folder will be free from WASI artifacts.
We have intentionally split both directories because our goal is to use the libraries in regular
desktop applications as well, where <code>WASI SDK</code> is not used to build the library.
This approach ensures high flexibility when using the library in both the browser and desktop
environments.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/2-cmake-and-build-scripts/">In the next part, we will create the build script and set up the CMake files.</a></p>
]]></content></item></channel></rss>
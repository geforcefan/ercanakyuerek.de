<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on Ercan Akyürek</title><link>https://ercanakyuerek.de/posts/</link><description>Recent content in Posts on Ercan Akyürek</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Sun, 18 Jan 2026 14:30:00 +0100</lastBuildDate><atom:link href="https://ercanakyuerek.de/posts/index.xml" rel="self" type="application/rss+xml"/><item><title>Uniform Rational B-Spline curve [WIP]</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/b-spline-curve/</link><pubDate>Sun, 18 Jan 2026 14:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/b-spline-curve/</guid><description>&lt;p&gt;This chapter is still &lt;strong&gt;work in progress&lt;/strong&gt;. The text is not finished yet.&lt;/p&gt;
&lt;p&gt;That said, it felt useful to already show the result.&lt;/p&gt;
&lt;p&gt;The interactive demo below is backed by a &lt;strong&gt;Uniform Rational B-Spline curve&lt;/strong&gt; and already renders a full &lt;strong&gt;3D track mesh&lt;/strong&gt; in real time. There is no heavy optimization involved at this stage. The geometry is generated directly from the curve and updated live as the control points change.&lt;/p&gt;</description><content type="html"><![CDATA[<p>This chapter is still <strong>work in progress</strong>. The text is not finished yet.</p>
<p>That said, it felt useful to already show the result.</p>
<p>The interactive demo below is backed by a <strong>Uniform Rational B-Spline curve</strong> and already renders a full <strong>3D track mesh</strong> in real time. There is no heavy optimization involved at this stage. The geometry is generated directly from the curve and updated live as the control points change.</p>
<p>The goal here is simply to show that <strong>real-time track generation</strong> is possible with this approach using <strong>web technologies</strong>. Even without optimizations, the system is fast enough to experiment, iterate, and visualize track shapes interactively.</p>
<p>The following chapters will fill in the missing pieces step by step. For now, consider this a preview of where the system is heading.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-e7f3db90ee73790050cfce7df869559a"
    width="100%"
    height="580px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-e7f3db90ee73790050cfce7df869559a').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/b-spline-curve\/BSplineCurveDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

]]></content></item><item><title>NURBS, Roll, Physics in Action</title><link>https://ercanakyuerek.de/posts/roller-coaster-simulation/nurbs-roll-physics-in-action/</link><pubDate>Sun, 04 Jan 2026 21:00:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/roller-coaster-simulation/nurbs-roll-physics-in-action/</guid><description>&lt;p&gt;Parallel to writing this series about building a &lt;a href="https://ercanakyuerek.de/tags/writing-a-roller-coaster-simulation/"&gt;roller coaster
simulator in the
browser&lt;/a&gt;, the
system itself has continued to evolve.&lt;/p&gt;
&lt;p&gt;At this point, the simulator already supports &lt;strong&gt;NURBS tracks&lt;/strong&gt;,
&lt;strong&gt;roll interpolation&lt;/strong&gt;, and a complete &lt;strong&gt;physics simulation&lt;/strong&gt; running
together. What started as isolated experiments in earlier chapters is
now a connected system. The ideas described in the articles are no
longer sketches. They are running code.&lt;/p&gt;
&lt;p&gt;This post is not a deep technical explanation. It is a snapshot of the
current state of the simulator.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Parallel to writing this series about building a <a href="https://ercanakyuerek.de/tags/writing-a-roller-coaster-simulation/">roller coaster
simulator in the
browser</a>, the
system itself has continued to evolve.</p>
<p>At this point, the simulator already supports <strong>NURBS tracks</strong>,
<strong>roll interpolation</strong>, and a complete <strong>physics simulation</strong> running
together. What started as isolated experiments in earlier chapters is
now a connected system. The ideas described in the articles are no
longer sketches. They are running code.</p>
<p>This post is not a deep technical explanation. It is a snapshot of the
current state of the simulator.</p>
<p>The track is generated from <strong>NURBS curves</strong>, orientation along the
curve is handled with <strong>roll interpolation</strong>, and a basic <strong>3D track
model</strong> is built directly from the curve data. Everything is evaluated
and rendered in real time, without any heavy optimization or offline
processing.</p>
<p>The goal here is simply to show how these pieces behave when combined:
curve interpolation, orientation, and physics acting on the same
representation of the track.</p>
<h1 id="interactive-demo">Interactive demo</h1>
<p>As always, the full code is available below.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-523ef72a875b2d5d34203503b026ed56"
    width="100%"
    height="650px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-523ef72a875b2d5d34203503b026ed56').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/roller-coaster-simulation\/nurbs-roll-physics-in-action\/NurbsRollPhysicsInActionDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h1 id="code">Code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/roller-coaster-simulation/nurbs-roll-physics-in-action/NurbsRollPhysicsInActionDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Stats</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">toLocalTransformed</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/curve&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">fromURL</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../helper/nl2park/nl2park&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">curveFromCustomTrack</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../helper/nolimits&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">CurveTrackMesh</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/CurveTrackMesh&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">PerspectiveScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/PerspectiveScene&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">TrainWithPhysics</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/TrainWithPhysics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">Park</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./Example.nl2park&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exampleCoaster</span> <span style="color:#f92672">=</span> (<span style="color:#66d9ef">await</span> <span style="color:#a6e22e">fromURL</span>(<span style="color:#a6e22e">Park</span>)).<span style="color:#a6e22e">coaster</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exampleTrack</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">exampleCoaster</span><span style="color:#f92672">?</span>.<span style="color:#a6e22e">tracks</span>[<span style="color:#ae81ff">2</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">exampleTrackCurve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toLocalTransformed</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curveFromCustomTrack</span>(<span style="color:#a6e22e">exampleTrack</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1.2</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">NurbsRollPhysicsInActionDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">PerspectiveScene</span>&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Stats</span> /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">CurveTrackMesh</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">exampleTrackCurve</span>} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">TrainWithPhysics</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">exampleTrackCurve</span>}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">sections</span><span style="color:#f92672">=</span>{[
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0.5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.81665</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fromArcLength</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">toArcLength</span>: <span style="color:#66d9ef">15.38</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">maxVelocity</span>: <span style="color:#66d9ef">8</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.6</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0.5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.81665</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fromArcLength</span>: <span style="color:#66d9ef">15.38</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">toArcLength</span>: <span style="color:#66d9ef">18.92</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">maxVelocity</span>: <span style="color:#66d9ef">9.654</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.6</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0.5</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.81665</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fromArcLength</span>: <span style="color:#66d9ef">44.43</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">toArcLength</span>: <span style="color:#66d9ef">60.16</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">maxVelocity</span>: <span style="color:#66d9ef">12.872</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.6</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0.8</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.81665</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fromArcLength</span>: <span style="color:#66d9ef">60.16</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">toArcLength</span>: <span style="color:#66d9ef">113.83</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">maxVelocity</span>: <span style="color:#66d9ef">85.277</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.6</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">acceleration</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">9.81665</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">fromArcLength</span>: <span style="color:#66d9ef">715.1</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">toArcLength</span>: <span style="color:#66d9ef">735.54</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">minVelocity</span>: <span style="color:#66d9ef">12.872</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">3.6</span>,
</span></span><span style="display:flex;"><span>            },
</span></span><span style="display:flex;"><span>          ]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">init</span><span style="color:#f92672">=</span>{{
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">13</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">friction</span>: <span style="color:#66d9ef">0.026</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">airResistance</span>: <span style="color:#66d9ef">2e</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>          }}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">activateCamera</span><span style="color:#f92672">=</span>{<span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">resetWhenReachedLimit</span><span style="color:#f92672">=</span>{<span style="color:#66d9ef">false</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">PerspectiveScene</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Curve orientation</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-orientation/</link><pubDate>Sun, 04 Jan 2026 14:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-orientation/</guid><description>&lt;p&gt;In earlier chapters, we already computed basic orientations along the
track, and for a while that worked reasonably well. The trouble starts
when we rely too much on a simple &lt;code&gt;lookAt&lt;/code&gt; from &lt;strong&gt;THREE.js&lt;/strong&gt; together
with a &lt;strong&gt;fixed-up direction&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The missing piece here is &lt;strong&gt;roll&lt;/strong&gt;, also known as rotation around the
&lt;strong&gt;forward direction&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Whenever we use &lt;code&gt;lookAt&lt;/code&gt;, we must provide an &lt;strong&gt;up vector&lt;/strong&gt;. So far,
this has always been &lt;code&gt;Vector3(0, 1, 0)&lt;/code&gt;. This is fine for &lt;strong&gt;gentle
slopes&lt;/strong&gt;, but it starts to fall apart when the track approaches angles
close to &lt;strong&gt;90 degrees&lt;/strong&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<p>In earlier chapters, we already computed basic orientations along the
track, and for a while that worked reasonably well. The trouble starts
when we rely too much on a simple <code>lookAt</code> from <strong>THREE.js</strong> together
with a <strong>fixed-up direction</strong>.</p>
<p>The missing piece here is <strong>roll</strong>, also known as rotation around the
<strong>forward direction</strong>.</p>
<p>Whenever we use <code>lookAt</code>, we must provide an <strong>up vector</strong>. So far,
this has always been <code>Vector3(0, 1, 0)</code>. This is fine for <strong>gentle
slopes</strong>, but it starts to fall apart when the track approaches angles
close to <strong>90 degrees</strong>.</p>
<p>At that point, the <strong>curve direction</strong> points almost straight up. The
<strong>up vector</strong> also points up. Now both vectors look into the sky, and
the resulting <strong>matrix</strong> becomes unstable.</p>
<p>When the track points straight up, <strong>roll</strong> is no longer uniquely
defined. Rotating around that direction does not change where the
track is pointing, so <code>lookAt</code> has no stable orientation to choose
from.</p>
<p>Mathematically, this happens because <code>lookAt</code> constructs an
orientation using <strong>cross-products</strong>. When the <strong>forward direction</strong>
becomes parallel, or nearly parallel, to the <strong>up vector</strong>, the
cross-product between them approaches zero. Once that happens, the
remaining axes of the <strong>matrix</strong> cannot be built reliably anymore.</p>
<p>The visible result is <strong>sudden flips</strong>, <strong>jitter</strong>, or <strong>strange
twisting</strong> along the track, especially around slopes <strong>close to 90
degrees</strong>.</p>
<h1 id="incremental-orientation">Incremental orientation</h1>
<p>To fix this, we need a slightly different approach. Instead of
computing each orientation in isolation, we build it
<strong>incrementally</strong>. We start from the transformation <strong>matrix</strong> of the
<strong>previous node</strong> and apply a small rotation that follows the <strong>curve
direction</strong>.</p>
<p>In other words, we still align the orientation with the curve, but we
do it <strong>relative to the previous node’s orientation</strong>, instead of
rebuilding everything from scratch.</p>
<p>This way, the <strong>up direction</strong> is not reset at every step. It slowly
rotates along the curve, preserving the existing <strong>roll</strong> instead of
fighting against it.</p>
<p>This technique is commonly called <strong>parallel transport</strong>, because the
orientation is transported along the curve with <strong>as little rotation
as possible</strong>.</p>
<p>Think of it like this: we add rotation step by step while respecting
the <strong>previous orientation</strong>.</p>
<p>The following interactive demo lets us switch between a <strong>fixed-up
lookAt orientation</strong> and an <strong>incremental orientation based on the
previous node</strong>. This helps visualize the problem.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-93de01e745818151aabb13834707e3b4"
    width="100%"
    height="700px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 100%">
    <strong>fixed-up lookAt orientation</strong>: Roll becomes unstable near 90° slopes. <strong>Incremental rotation</strong>: Stable roll and smooth orientation along the curve.
  </div>
  

  <script>
    document.getElementById('react-root-93de01e745818151aabb13834707e3b4').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/curve-orientation\/LookAtExampleScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h2 id="parallel-transport">Parallel transport</h2>
<p>Now we can look at how to actually solve the <strong>fixed-up <code>lookAt</code>
problem</strong>.</p>
<p>We already know the key idea: instead of rebuilding the orientation at
every node, we rotate <strong>incrementally</strong>, relative to the <strong>previous
node</strong>.</p>
<p>For each <strong>curve node step</strong>, we compute a <strong>transported frame</strong> and
return a new transformation <strong>matrix</strong>.</p>
<p>The steps are:</p>
<ul>
<li>Compute the <strong>direction</strong> towards the <strong>next curve node</strong> from the
<strong>current position</strong>.</li>
<li>Extract the <strong>current rotation</strong> from the transformation <strong>matrix</strong>.</li>
<li>Transform the direction using the <strong>current local rotation</strong> so it
is expressed relative to the <strong>orientation of the current node</strong>.</li>
<li>Apply <strong>yaw and pitch</strong> derived from the <strong>relative direction</strong> to
the transformation <strong>matrix</strong>. The <strong>relative direction itself</strong>
represents the <strong>increment</strong>.</li>
</ul>
<p>The result is a function that <strong>parallel-transports</strong> a transformation
<strong>matrix</strong> and returns a new, transported transformation <strong>matrix</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">parallelTransportTransformation</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">Matrix4</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">nextPosition</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toPosition</span>(<span style="color:#a6e22e">transformation</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">direction</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">position</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">sub</span>(<span style="color:#a6e22e">nextPosition</span>).<span style="color:#a6e22e">normalize</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rotationMatrix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toRotationMatrix</span>(<span style="color:#a6e22e">transformation</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">localRotation</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>().<span style="color:#a6e22e">copy</span>(<span style="color:#a6e22e">rotationMatrix</span>).<span style="color:#a6e22e">invert</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">relativeDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">direction</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">clone</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">applyMatrix4</span>(<span style="color:#a6e22e">localRotation</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">relativeDirectionLength</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector2</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">relativeDirection</span>.<span style="color:#a6e22e">x</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">relativeDirection</span>.<span style="color:#a6e22e">z</span>,
</span></span><span style="display:flex;"><span>  ).<span style="color:#a6e22e">length</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rotationY</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>().<span style="color:#a6e22e">makeRotationY</span>(
</span></span><span style="display:flex;"><span>    Math.<span style="color:#a6e22e">atan2</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">relativeDirection</span>.<span style="color:#a6e22e">x</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">relativeDirection</span>.<span style="color:#a6e22e">z</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rotationX</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>().<span style="color:#a6e22e">makeRotationX</span>(
</span></span><span style="display:flex;"><span>    Math.<span style="color:#a6e22e">atan2</span>(<span style="color:#a6e22e">relativeDirection</span>.<span style="color:#a6e22e">y</span>, <span style="color:#a6e22e">relativeDirectionLength</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rotationMatrix</span>.<span style="color:#a6e22e">multiply</span>(<span style="color:#a6e22e">rotationY</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rotationMatrix</span>.<span style="color:#a6e22e">multiply</span>(<span style="color:#a6e22e">rotationX</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">rotationMatrix</span>.<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">position</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>We also need a small helper that extracts a <strong>rotation matrix</strong> from a
transformation <strong>matrix</strong>. This assumes there is <strong>no scale</strong>
involved. Since we never use scale for <strong>curve transformation
matrices</strong>, this simplification is acceptable and keeps things simple.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toRotationMatrix</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">Matrix4</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">transformation</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">setPosition</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h2 id="constructing-a-curve-properly">Constructing a curve properly</h2>
<p>Now that we can <strong>parallel-transport</strong> a transformation <strong>matrix</strong>, we
need to actually use it.</p>
<p>In earlier chapters, we built curves using a <strong>temporary helper</strong> that
simply connected points without caring about <strong>orientation</strong>. Now is
the point where we finally remove it.</p>
<p>We introduce two new methods:</p>
<ul>
<li><code>insertTransformationMatrix</code>, which inserts a transformation
<strong>matrix</strong> into the curve and <strong>calculates arc length</strong> and updates
<strong>segment offsets</strong>.</li>
<li><code>insertPosition</code>, which inserts a <strong>position</strong> and computes the
correct <strong>orientation</strong> using <strong>parallel transport</strong>.</li>
</ul>
<p>We start with <code>insertTransformationMatrix</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">insertTransformationMatrix</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>: <span style="color:#66d9ef">Curve</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">Matrix4</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">last</span>(<span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">lastNode</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceToLastNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">distance</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">transformation</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">distanceToLastNode</span> <span style="color:#f92672">&lt;</span> Number.<span style="color:#a6e22e">EPSILON</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">distanceToLastNode</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">segmentOffsets</span>[<span style="color:#a6e22e">segmentIndex</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">arcLength</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transformation</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">segmentIndex</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>What happens here is fairly straightforward:</p>
<ul>
<li>We look up the <strong>last node’s position</strong> and compute the <strong>distance</strong>
to the new <strong>matrix</strong>.</li>
<li>We add that distance to the node’s <strong>arc length</strong>.</li>
<li>If the distance is <strong>zero</strong>, we skip inserting the node.</li>
<li>We compute the <strong>segment index</strong> and update the <strong>segment offset
list</strong> accordingly.</li>
</ul>
<blockquote>
<p><strong>Note:</strong> <strong>Segment offsets</strong> are a fast lookup structure for
segment lengths. For example, offsets like <code>[0, 20, 30]</code> tell us
that <strong>segment 1</strong> spans arc lengths from <strong>20 to 30</strong>. This will
become useful later.</p></blockquote>
<p>Next, we implement <code>insertPosition</code>, which handles the <strong>parallel
transport logic</strong>. The approach is as follows:</p>
<ul>
<li>The <strong>first point</strong> is added with an <strong>empty transformation matrix</strong>
that only contains a <strong>position</strong>.</li>
<li>Once we have at least one node, we treat the <strong>last node</strong> as the
<strong>left side</strong> and the new position as the <strong>right side</strong>.</li>
<li>If the <strong>distance</strong> between them is <strong>zero</strong>, we skip the insertion.</li>
<li>We parallel-transport the <strong>left transformation matrix</strong> toward the
<strong>right position</strong>.</li>
<li>The <strong>very first node</strong> needs to be transported <strong>twice</strong> to
initialize its <strong>orientation</strong>.</li>
<li>The <strong>last node</strong> always keeps the same <strong>orientation</strong> as its
predecessor, since there is <strong>no next point</strong> to define a direction.</li>
</ul>
<p>This is easier to understand once you look at the implementation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">insertPosition</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>: <span style="color:#66d9ef">Curve</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">position</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">last</span>(<span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">lastNode</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">insertTransformationMatrix</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">curve</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>().<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">position</span>),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">position</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">toPosition</span>(<span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span>)) <span style="color:#f92672">&lt;</span>
</span></span><span style="display:flex;"><span>    Number.<span style="color:#a6e22e">EPSILON</span>
</span></span><span style="display:flex;"><span>  )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">===</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parallelTransportTransformation</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">position</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">parallelTransportTransformation</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">position</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">insertTransformationMatrix</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curve</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lastNode</span>.<span style="color:#a6e22e">transformation</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">position</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">segmentIndex</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>With that in place, we can now update <code>bezierSplineCurve</code>. In earlier
chapters, this function relied on a temporary <code>fromPoints</code> helper with
<strong>no proper orientation</strong>. We can now replace that with repeated calls
to <code>insertPosition</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezierSplineCurve</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">points</span>: <span style="color:#66d9ef">Vector3</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resolution</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">curve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">emptyCurve</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uniformSample</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">estimateTotalArcLength</span>(<span style="color:#a6e22e">points</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">resolution</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">insertPosition</span>(<span style="color:#a6e22e">curve</span>, <span style="color:#a6e22e">deCasteljau</span>(<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">t</span>));
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">curve</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h1 id="what-comes-next">What comes next?</h1>
<p>At this point, we finally have a <strong>stable orientation</strong> along the
curve, without <strong>jitter</strong> near <strong>steep slopes</strong>. It would be tempting
to go straight into a proper <strong>roll interpolation</strong>, but before doing
that, we want to take a step back.</p>
<p>The next step will be the introduction of <strong>NURBS curves</strong>, which
allow much more freedom than <strong>Bézier curves</strong> and make
experimentation far more interesting.</p>
<p>The theory behind this, like <strong>continuity</strong>, <strong>knot vectors</strong>, and
<strong>curve order</strong>, can get confusing quickly. For now, we keep the
implementation <strong>practical</strong> and leave most of the theory for a
separate <strong>spline-focused series</strong>.</p>
<p>If you want an introduction in the meantime, the video
<a href="https://www.youtube.com/watch?v=jvPPXbo87ds">The Continuity of Splines</a>
by <a href="https://www.youtube.com/@acegikmo">Ferya Holmèr</a> is <strong>gold</strong>. It
is <strong>perfect</strong> and covers almost everything you need to understand
<strong>splines in general</strong>.</p>
<h1 id="interactive-demo">Interactive demo</h1>
<p>This chapter ends with a small interactive example. You can move the
control points of a <strong>Bézier curve</strong> and observe how the
<strong>orientation</strong> behaves. There should be <strong>no sudden flips or jitter</strong>
near <strong>90 degree slopes</strong>.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-42da9877d5cdc4f84dd8a456ca4f5194"
    width="100%"
    height="650px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-42da9877d5cdc4f84dd8a456ca4f5194').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/curve-orientation\/CurveOrientationDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/curve-orientation/CurveOrientationDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useMemo</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">bezierSplineCurve</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/bezier&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">CurveTrackMesh</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/CurveTrackMesh&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">TrainWithPhysics</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/TrainWithPhysics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">CurveOrientationDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">12</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">curve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useMemo</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">bezierSplineCurve</span>(<span style="color:#a6e22e">points</span>), [<span style="color:#a6e22e">points</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">group</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#f92672">-</span><span style="color:#ae81ff">11</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>]}&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Line</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">segments</span><span style="color:#f92672">=</span>{<span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">DragControlPoints</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">CurveTrackMesh</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>} /&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">TrainWithPhysics</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>} <span style="color:#a6e22e">init</span><span style="color:#f92672">=</span>{{ <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">17</span> }} /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">group</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">group</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>]}&gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Ground</span> /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">group</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Bézier curve</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/bezier-curve/</link><pubDate>Thu, 25 Dec 2025 14:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/bezier-curve/</guid><description>&lt;div class="embedded float-right"&gt;
&lt;iframe
id="react-root-1f1ce64a81658a7ba5710e3c01ecf860"
width="225px"
height="285px"
class="frame"
&gt;&lt;/iframe&gt;
&lt;div class="description" style="width: 225px"&gt;
An interactive example of a Bézier curve, drag the controls around to see changes in shape
&lt;/div&gt;
&lt;script&gt;
document.getElementById('react-root-1f1ce64a81658a7ba5710e3c01ecf860').srcdoc = `
&lt;!DOCTYPE html&gt;
&lt;html lang="en" data-theme="dark"&gt;
&lt;head&gt;
&lt;base href="${location.origin}/"&gt;
&lt;/head&gt;
&lt;body class="content-component"&gt;
&lt;div id="root" class="full-screen"&gt;&lt;/div&gt;
\x3Cscript type="module"&gt;
import { renderContentComponentByPath } from '/scripts/render-content-component.js';
renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/bezier-curve\/BezierCurveExampleScene.tsx');
&lt;\/script&gt;
&lt;/body&gt;
&lt;/html&gt;
`;
&lt;/script&gt;
&lt;/div&gt;
&lt;p&gt;So, now it is finally time to build an actual &lt;strong&gt;Bézier curve&lt;/strong&gt; instead
of only linear segments.&lt;/p&gt;
&lt;p&gt;I do not think Bézier curves are particularly well suited for
hand-building real roller coaster tracks. But they are simple to
implement, easy to visualize, and most importantly, they finally give
us &lt;em&gt;real curvature&lt;/em&gt; instead of straight lines everywhere. And
honestly, we have been staring at straight lines long enough.&lt;/p&gt;</description><content type="html"><![CDATA[      

<div class="embedded float-right">
  <iframe
    id="react-root-1f1ce64a81658a7ba5710e3c01ecf860"
    width="225px"
    height="285px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 225px">
    An interactive example of a Bézier curve, drag the controls around to see changes in shape
  </div>
  

  <script>
    document.getElementById('react-root-1f1ce64a81658a7ba5710e3c01ecf860').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/bezier-curve\/BezierCurveExampleScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>So, now it is finally time to build an actual <strong>Bézier curve</strong> instead
of only linear segments.</p>
<p>I do not think Bézier curves are particularly well suited for
hand-building real roller coaster tracks. But they are simple to
implement, easy to visualize, and most importantly, they finally give
us <em>real curvature</em> instead of straight lines everywhere. And
honestly, we have been staring at straight lines long enough.</p>
<p>The nice part is that we already did the hard work earlier. Since we
introduced an agnostic way to describe curves using <strong>curve nodes</strong>,
all we need to do now is generate nodes that follow a Bézier curve and
feed them into the simulation.</p>
<p>The physics simulation does not care where the shape comes from. It
does not know whether the curve is <strong>linear</strong>, <strong>Bézier</strong>, <strong>NURBS</strong>,
<strong>FVD</strong>, or built from <strong>geometric shapes</strong>. It really does not care.
It just consumes curve nodes and keeps going. That was the whole point
of the abstraction.</p>
<p>This time, I will first show you a demo with a Bézier curve, just to
spoil the ending a bit:</p>
      

<div class="embedded ">
  <iframe
    id="react-root-758360138bf416ff3787820f292de2d0"
    width="100%"
    height="480px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-758360138bf416ff3787820f292de2d0').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/bezier-curve\/BezierCurveDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h1 id="multiple-algorithms">Multiple algorithms</h1>
<p>A Bézier curve can be evaluated in different ways. In practice, there
are multiple algorithms to compute points on the curve.</p>
<p>A very common choice is the <strong>de Casteljau</strong> algorithm. It is known
for its excellent numerical stability, but more importantly for us, it
is much easier to reason about. You can almost see the curve being
constructed step by step.</p>
<p>There are other options. Evaluating a Bézier curve via <strong>Bernstein
polynomials</strong> is usually a bit faster and better suited when you want
to evaluate many points per frame. The tradeoff is slightly worse
numerical stability and, more importantly here, a less intuitive
mental model.</p>
<p>We choose <strong>de Casteljau</strong> on purpose. Not because it is the fastest
option, but because it makes it much clearer how a Bézier curve is
actually constructed. For readability and understanding, this matters
more right now than raw performance. We can always optimize later,
once the idea is clear.</p>
<blockquote>
<p><strong>Important:</strong> I will <strong>not</strong> go deep into the theory of Bézier
curves, NURBS, or splines in general. That topic is a rabbit hole
with no clear exit. Seriously. You will run into C0, C1, and C2
continuity, knot vectors, basis functions, and many strong opinions.</p>
<p>If you want to dive into that world, go for it. It is interesting,
but also confusing in equal parts. We will eventually implement
NURBS in this series as well, but without getting lost in the math.
For now, we keep things simple and practical. Your future self will
thank you.</p></blockquote>
<h1 id="bézier-evaluation-via-de-casteljau">Bézier evaluation via de Casteljau</h1>
<p>I will explain very quickly how the <strong>de Casteljau</strong> algorithm works.</p>
<p>Assume we have <strong>4 control points</strong> and we want to know the
<strong>position</strong> for a parameter <code>t</code> in the range <code>[0, 1]</code>. What we
actually do is nothing more than repeated <strong>linear interpolation</strong>.</p>
      

<div class="embedded float-right">
  <iframe
    id="react-root-b8cfec26f49d50a364a688e686f01443"
    width="355px"
    height="560px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 355px">
    Each animation loop shows one iteration of linear interpolations in the de Casteljau algorithm. After all three iterations described in the article, the Bézier curve is drawn.
  </div>
  

  <script>
    document.getElementById('react-root-b8cfec26f49d50a364a688e686f01443').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/bezier-curve\/DeCasteljauVisualizationScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>First, we interpolate between the control points:</p>
<ul>
<li><code>a</code> = interpolate between <code>p0</code> and <code>p1</code></li>
<li><code>b</code> = interpolate between <code>p1</code> and <code>p2</code></li>
<li><code>c</code> = interpolate between <code>p2</code> and <code>p3</code></li>
</ul>
<p>At this point, we have three new points lying on those straight lines.</p>
<p>Next, we connect these points. What happens? We now get two new
straight lines, called <code>d</code> and <code>e</code>. And yes, we interpolate again:</p>
<ul>
<li><code>d</code> = interpolate between <code>a</code> and <code>b</code></li>
<li><code>e</code> = interpolate between <code>b</code> and <code>c</code></li>
</ul>
<p>Now we are left with two points. We connect them once more, which
gives us a new line <code>f</code>, and interpolate again:</p>
<ul>
<li><code>f</code> = interpolate between <code>d</code> and <code>e</code></li>
</ul>
<p>Now there is only <strong>one point left</strong> and nothing left to connect. That
point is what we return. It is the evaluated position on the Bézier
curve.</p>
<p>So in the end, the algorithm is really just linear interpolation over
and over again until only a single point remains.</p>
<p>In code, this would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">2</span>].<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">3</span>], <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">d</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">b</span>, <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">f</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">d</span>.<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">e</span>, <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>;
</span></span></code></pre></div><p>As you can see, the function itself is just a bunch of linear
interpolations chained together. Nothing fancy.</p>
<p>Of course, this version is limited to exactly <strong>4 control points</strong>. If
we had <strong>3 control points</strong>, the exact same logic would apply. Instead
of three lines <code>a</code>, <code>b</code>, and <code>c</code>, we would only have two lines, <code>a</code>
and <code>b</code>, and in the next iteration we would simply interpolate between
those two. Same idea, fewer steps.</p>
<p>So instead of writing out every single <code>lerp</code> by hand for a fixed
number of control points, we can just use loops and make the algorithm
work for <strong>any number of control points</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">v</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">clone</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">k</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">k</span><span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">k</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>Note</strong>: In practice, it usually makes sense to stop at <strong>four</strong>
control points, because everything beyond that tends to get unstable
pretty quickly. But the function itself does not limit stupidity.
That part is still up to us 🙂</p></blockquote>
<p>So we end up with a general version that works for any number of
control points. Add a small guard at the beginning and we are ready to
use it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">deCasteljau</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">points</span>: <span style="color:#66d9ef">Vector3</span>[], <span style="color:#a6e22e">t</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error(<span style="color:#e6db74">`Expected control points, got </span><span style="color:#e6db74">${</span><span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span><span style="color:#e6db74">}</span><span style="color:#e6db74">`</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">p</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">v</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">clone</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">k</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">k</span><span style="color:#f92672">--</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">k</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">p</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h2 id="how-many-curve-nodes-do-we-need">How many curve nodes do we need?</h2>
<p>Now that we can evaluate a Bézier curve for a parameter <code>t</code> in the
range <code>[0, 1]</code>, the next question is: how many <strong>curve nodes</strong> do we
actually want to generate along that curve?</p>
<p>More nodes mean better precision. Fewer nodes mean better performance.
We do not need perfect precision here, so we need to find a reasonable
<strong>sweet spot</strong>.</p>
      

<div class="embedded float-right">
  <iframe
    id="react-root-450b0242f53b19c7585b3c2279a5923b"
    width="355px"
    height="485px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 355px">
    Interactive visualization of curve length estimation using uniformly sampled points. Try different sample counts and Bézier shapes to see when the estimate becomes good enough. This is how I settled on 8 points as a reasonable sweet spot.
  </div>
  

  <script>
    document.getElementById('react-root-450b0242f53b19c7585b3c2279a5923b').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/bezier-curve\/EstimateLengthScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>In practice, this is what I usually do:</p>
<ul>
<li>First, estimate the arc length of the Bézier curve by uniformly
evaluating a small number of points on it. I normally pick <strong>8
points</strong> and sum up the distances between them.</li>
<li>Then, use this estimated length to compute the number of curve nodes
by multiplying it with a <strong>resolution</strong> value. I usually use
something like <code>20</code>.</li>
<li><strong>Example</strong>: a roughly <strong>20 meter</strong> long curve multiplied by a
resolution of <code>20</code> gives us <strong>400 nodes</strong>.</li>
<li>We then evaluate the Bézier curve at those 400 positions and
construct curve nodes from them.</li>
<li>It will make sense to clamp the number of nodes in the <strong>editor</strong> in
the future, where <strong>performance matters while dragging control
points around</strong>. In the simulation, this is much less critical.</li>
</ul>
<p>To make this easier, we start with a small helper that lets us
<strong>uniformly sample</strong> a range with a given resolution. It gives us both
the actual value and a normalized<code>t</code> in <code>[0, 1]</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">uniformSample</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">to</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resolution</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">t</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">void</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">to</span> <span style="color:#f92672">-</span> <span style="color:#66d9ef">from</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">numberOfNodes</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">max</span>(Math.<span style="color:#a6e22e">floor</span>(<span style="color:#a6e22e">length</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">resolution</span>), <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">numberOfNodes</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">/</span> (<span style="color:#a6e22e">numberOfNodes</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">at</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">from</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fn</span>(<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>If this feels a bit abstract, here is a concrete example.</p>
<p>Assume we want to sample from <code>1</code> to <code>6</code> with a resolution of <code>1</code>.
That means we will get <strong>5 evenly distributed values</strong>:</p>
<ul>
<li>actual values: <code>[1, 2.25, 3.5, 4.75, 6]</code></li>
<li>normalized values: <code>[0, 0.25, 0.5, 0.75, 1]</code></li>
</ul>
<h2 id="estimating-the-bézier-curve-length">Estimating the Bézier curve length</h2>
<p>Now that we have <code>uniformSample</code>, estimating the curve length is
straightforward.</p>
<p>We simply pick <strong>8 evenly distributed values</strong> in the range <code>[0, 8]</code>
and evaluate the Bézier curve at those normalized values:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uniformSampleMap</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1</span>, (<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deCasteljau</span>(<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">t</span>),
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>At this point, <code>positions</code> contains 8 points along the Bézier curve.</p>
<p>From here, it is extremely easy to iterate over these points and sum
up the distances between positions to get an <strong>estimated total arc
length</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>  .<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>  .<span style="color:#a6e22e">reduce</span>(
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">arcLength</span>, <span style="color:#a6e22e">position</span>, <span style="color:#a6e22e">i</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">position</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">positions</span>[<span style="color:#a6e22e">i</span>]),
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>  );
</span></span></code></pre></div><p>Now we end up with this estimate function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">estimateTotalArcLength</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">points</span>: <span style="color:#66d9ef">Vector3</span>[]) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positions</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">uniformSampleMap</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1</span>, (<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">deCasteljau</span>(<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">t</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">positions</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">reduce</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">arcLength</span>, <span style="color:#a6e22e">position</span>, <span style="color:#a6e22e">i</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">position</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">positions</span>[<span style="color:#a6e22e">i</span>]),
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Here is the <code>uniformSampleMap</code> function. It is a small convenience
helper that wraps <code>uniformSample</code> and makes mapping the result easier,
instead of having to do it manually each time. It will show up here
and there in later chapters.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">uniformSampleMap</span> <span style="color:#f92672">=</span> &lt;<span style="color:#f92672">T</span>&gt;(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">from</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">to</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resolution</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mapFn</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>, <span style="color:#a6e22e">t</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">T</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">out</span>: <span style="color:#66d9ef">T</span>[] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uniformSample</span>(<span style="color:#66d9ef">from</span>, <span style="color:#a6e22e">to</span>, <span style="color:#a6e22e">resolution</span>, (<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">out</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">mapFn</span>(<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">out</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h1 id="constructing-a-bézier-curve">Constructing a Bézier curve</h1>
<p>This part is almost stupidly simple, so I will just paste the code and
explain it briefly.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezierSplineCurve</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">points</span>: <span style="color:#66d9ef">Vector3</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">resolution</span>: <span style="color:#66d9ef">number</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positions</span>: <span style="color:#66d9ef">Vector3</span>[] <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">uniformSample</span>(<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">estimateLength</span>(<span style="color:#a6e22e">points</span>), <span style="color:#a6e22e">resolution</span>, (<span style="color:#a6e22e">at</span>, <span style="color:#a6e22e">t</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">positions</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">deCasteljau</span>(<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">t</span>));
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fromPoints</span>(<span style="color:#a6e22e">positions</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><blockquote>
<p><strong>Note:</strong> In the repository, <code>bezierSplineCurve</code> has a slightly
different implementation that calls utility functions for proper
curve orientation calculation. Do not worry about this for now. We
will cover it in the next chapters.</p></blockquote>
<p>What happens here is straightforward:</p>
<ul>
<li>We sample from <code>0</code> to the <strong>estimated length</strong> of the Bézier curve.</li>
<li>We use a default resolution of <code>20</code>.</li>
<li>For each sample, we evaluate the curve using the <strong>de Casteljau</strong>
algorithm with <code>t</code> in the range <code>[0, 1]</code>.</li>
<li>The resulting positions are then turned into a curve using
<code>fromPoints</code>, which we implemented earlier.</li>
</ul>
<p>There is nothing more going on here. We sample the curve, evaluate it,
and turn the result into curve nodes.</p>
<h2 id="whats-next">What’s next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-orientation/">In the next article</a>, we will eventually and finally fix our curve node
orientation problems and create a good <code>fromPoints</code> function that
calculates the orientation in a way that nothing breaks on looping or
slopes close to 90°.</p>
<p>Right now, our <code>fromPoints</code> is a temporary junk implementation with
hard transitions on the edges. That was fine while we only had linear
segments, but now we actually have curvature, so the problems are much
easier to see.</p>
<blockquote>
<p><strong>Note</strong>: In the demo, I already intentionally use the correct way
of inserting positions (by using <code>fromUniformSampledPositions</code>
instead of <code>fromPoints</code> from the last chapter) on the curve with
proper curve node orientation calculation, so the demo does not
jitter. Do not be confused by this. I am basically taking things a
bit ahead of time here.</p></blockquote>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/bezier-curve/BezierCurveDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useMemo</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">bezierSplineCurve</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/bezier&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">CurveTrackMesh</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/CurveTrackMesh&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">TrainWithPhysics</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/TrainWithPhysics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">BezierCurveDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">11.3</span>, <span style="color:#ae81ff">3.9</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">6.6</span>, <span style="color:#ae81ff">2.7</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">5.8</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3.8</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.4</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">curve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useMemo</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">bezierSplineCurve</span>(<span style="color:#a6e22e">points</span>), [<span style="color:#a6e22e">points</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">segments</span><span style="color:#f92672">=</span>{<span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">axisLock</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">CurveTrackMesh</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">TrainWithPhysics</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Curve Nodes</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-nodes/</link><pubDate>Sun, 21 Dec 2025 14:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-nodes/</guid><description>&lt;p&gt;In this chapter, we try to make our lives a bit easier by using a more
flexible way to describe &lt;strong&gt;curves&lt;/strong&gt; in general.&lt;/p&gt;
&lt;p&gt;This article is a bit longer than usual. The topic is hard to split
into smaller pieces without losing context, so we keep everything in
one place. I will try to keep things as simple as possible, but yes,
there is a bit going on here.&lt;/p&gt;
&lt;p&gt;Up to this point, everything was built around a very basic &lt;strong&gt;linear
track&lt;/strong&gt; with two control points. Functions like
&lt;code&gt;transformationAtArcLength&lt;/code&gt; only had to deal with a single segment.
That worked fine for learning and experimenting, but it starts to feel
limiting very quickly. A real roller coaster does not consist of
exactly one straight line.&lt;/p&gt;</description><content type="html"><![CDATA[<p>In this chapter, we try to make our lives a bit easier by using a more
flexible way to describe <strong>curves</strong> in general.</p>
<p>This article is a bit longer than usual. The topic is hard to split
into smaller pieces without losing context, so we keep everything in
one place. I will try to keep things as simple as possible, but yes,
there is a bit going on here.</p>
<p>Up to this point, everything was built around a very basic <strong>linear
track</strong> with two control points. Functions like
<code>transformationAtArcLength</code> only had to deal with a single segment.
That worked fine for learning and experimenting, but it starts to feel
limiting very quickly. A real roller coaster does not consist of
exactly one straight line.</p>
<p>For now, we do not jump straight to <strong>NURBS</strong> or anything fancy. That
will come later. We just want more segments. To do that, we need a way
to describe curves that is not tied to a specific curve type, whether
that is linear tracks, splines, geometric sections.</p>
<p>The solution is a very basic concept called <strong>curve nodes</strong>. A curve
node stores where it is in <strong>space</strong>, its <strong>orientation</strong> as a <strong>4x4
transformation matrix</strong>, and the <strong>arc length</strong> at which it appears
along the curve. Nothing more than that.</p>
<h1 id="curve-node">Curve Node</h1>
<p>Before we write any code, we need to understand the idea first.</p>
<p>Imagine a linear track defined by four points. In that case, we also
have four nodes. Nothing surprising so far. If we want to know the
<strong>position</strong> at a certain distance along the track, we search for the
two nodes between which that distance lies. One node on the left, one
on the right. Everything in between is just interpolation.</p>
<p>This can be hard to visualize just by reading, so the example below
shows four points and a slider. You can also move the control points
to see what happens when the requested distance overshoots a segment.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-69aaa4922e43b48f44228d9dae8bfe09"
    width="100%"
    height="260px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 100%">
    As you move the slider, you request a distance along the track. You can immediately see between which two nodes that distance is sandwiched.
  </div>
  

  <script>
    document.getElementById('react-root-69aaa4922e43b48f44228d9dae8bfe09').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/curve-nodes\/BinarySearchDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h1 id="find-nodes-sandwiching-the-requested-distance">Find nodes sandwiching the requested distance</h1>
<p>In the example above, we look for the two nodes that sandwich the
requested distance and then linearly interpolate the <strong>position</strong>
between them.</p>
<p>You may notice that, in principle, we can build almost any curve
geometry this way. <strong>NURBS</strong>, for example, are basically just straight
lines following a curve with many, many nodes. Compared to the simple
example above, they are much denser, but the idea is exactly the same.
More nodes, same logic.</p>
<p><strong>Curve nodes</strong> form a clean and agnostic <strong>interface</strong> between the
physics simulation and the actual curve geometry. The simulation does
not really care how the curve was created. It just asks for matrices
and keeps going.</p>
<p>With that in mind, we can start by defining what a <strong>curve node</strong>
looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CurveNode</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">Matrix4</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">arcLength</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>That is it. A <strong>transformation matrix</strong>, its <strong>distance</strong>, and the
<strong>segment number</strong> along the curve. The segment number will not matter
much for now, but it will become important later.</p>
<p>Of course, nodes do not exist on their own. They have to belong to
something, and that something is the <strong>curve</strong> itself. To make this
explicit, we also introduce a <strong>Curve</strong> type that groups the nodes
together.</p>
<p>The <strong>Curve</strong> type looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Curve</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">nodes</span>: <span style="color:#66d9ef">CurveNode</span>[];
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">segmentOffsets</span>: <span style="color:#66d9ef">number</span>[];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<blockquote>
<p><strong>Note:</strong> The curve also stores <strong>segment offsets</strong>, which are
accumulated <strong>arc lengths</strong> of the segments. They are not important
right now. For the moment, we only deal with a single segment, so
this will just be <code>[0, totalArcLength]</code>. We will come back to this
later.</p></blockquote>
<p>To go along with this, we add a small helper that simply creates an
empty curve:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">emptyCurve</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">nodes</span>: <span style="color:#66d9ef">CurveNode</span>[] <span style="color:#f92672">=</span> [],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">segmentOffsets</span>: <span style="color:#66d9ef">number</span>[] <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">Curve</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">nodes</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">segmentOffsets</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Next, we need a way to find the two nodes that sandwich any requested
distance along the curve. There are many algorithms for this, but a
simple binary search works very well here. It is fast, easy to
implement, and more than good enough for what we need right now.</p>
<p>The only real requirement is that the nodes are sorted by <code>arcLength</code>,
which we will make sure of.</p>
<p>If you want, you can read more about
<a href="https://en.wikipedia.org/wiki/Binary_search">binary search</a>. To be
honest, you do not need to understand every detail here.</p>
<p>We use a lower-bound variant of binary search, which looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lowerBound</span> <span style="color:#f92672">=</span> &lt;<span style="color:#f92672">T</span>&gt;(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">array</span>: <span style="color:#66d9ef">T</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">accessor</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">item</span>: <span style="color:#66d9ef">T</span>, <span style="color:#a6e22e">index</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#66d9ef">number</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">first</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> (<span style="color:#a6e22e">len</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">half</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">floor</span>(<span style="color:#a6e22e">len</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">middle</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">first</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">half</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">accessor</span>(<span style="color:#a6e22e">array</span>[<span style="color:#a6e22e">middle</span>], <span style="color:#a6e22e">middle</span>) <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">value</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">first</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">middle</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">len</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">half</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">len</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">half</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">first</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Now we use this binary search to find the node indices between which a
requested distance along the curve lies. For that, we write a small
helper:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">findBoundingIndices</span> <span style="color:#f92672">=</span> &lt;<span style="color:#f92672">T</span>&gt;(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">array</span>: <span style="color:#66d9ef">T</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">accessor</span><span style="color:#f92672">:</span> (<span style="color:#a6e22e">item</span>: <span style="color:#66d9ef">T</span>, <span style="color:#a6e22e">index</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lowerNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lowerBound</span>(<span style="color:#a6e22e">array</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">accessor</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rightNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lowerNodeIndex</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">leftNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rightNodeIndex</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">leftNodeIndex</span>, <span style="color:#a6e22e">rightNodeIndex</span>];
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>This function needs a bit of explanation.</p>
<p>First, a small sanity check. Searching for a distance <strong>between</strong>
nodes only makes sense if we actually have at least two nodes.
Anything else would be suspicious:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span>;
</span></span></code></pre></div><p>After that, we do the binary search. The lower-bound search gives us
the index of the first node whose distance is <strong>greater than or
equal</strong> to the value we ask for.</p>
<p>A small concrete example helps here. Assume we have these node
distances:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plain" data-lang="plain"><span style="display:flex;"><span>[0, 10, 20, 30, 40]
</span></span></code></pre></div><p>If we request a distance:</p>
<ul>
<li><strong>10</strong> → we get index <code>1</code>, because <code>10</code> exists exactly at index <code>1</code></li>
<li><strong>0</strong> → we get index <code>0</code>, because the first node already matches</li>
<li><strong>15</strong> → we get index <code>2</code>, because <code>20</code> is the first value greater
than <code>15</code></li>
<li><strong>45</strong> → we get index <code>5</code>, which is past the last node. That is why
clamping exists.</li>
</ul>
<p>In all cases, the returned index represents the <strong>right</strong> node of the
sandwich:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lowerNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">lowerBound</span>(<span style="color:#a6e22e">array</span>, <span style="color:#a6e22e">value</span>, <span style="color:#a6e22e">accessor</span>);
</span></span></code></pre></div><p>Since the <strong>left node index</strong> is always the <strong>right node index minus
one</strong>, we need to be careful with bounds.</p>
<p>We clamp the <strong>right node index</strong> to the range <code>1</code> to
<code>array.length - 1</code>, because a <strong>right</strong> node cannot be the <strong>first</strong>
node of the curve.</p>
<p>This guarantees that the <strong>left node index</strong> is always valid, and that
the <strong>right node index</strong> never goes past the end of the array:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">rightNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lowerNodeIndex</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">array</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">leftNodeIndex</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">rightNodeIndex</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span></code></pre></div><p>Finally, we return the two indices that sandwich the requested
distance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> [<span style="color:#a6e22e">leftNodeIndex</span>, <span style="color:#a6e22e">rightNodeIndex</span>];
</span></span></code></pre></div><p>This is exactly what you were already seeing in the interactive
example at the beginning of the chapter, just written down in code
form.</p>
<h1 id="interpolate-between-curve-nodes">Interpolate between curve nodes</h1>
<p>Now we move on to the more interesting part: <strong>interpolation between
the left and right curve nodes</strong>.</p>
<p>To find the <strong>left and right nodes</strong>, we use the <strong>binary search
helper</strong> we just built:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nodes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">findBoundingIndices</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>,
</span></span><span style="display:flex;"><span>  (<span style="color:#a6e22e">node</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">nodes</span>) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>();
</span></span></code></pre></div><blockquote>
<p><strong>Note:</strong> Returning an empty matrix here is just a lazy safety
check. Architecture wise this may or may not be great, but that is
not the point right now. We will clean this up later. Or not.
Depends on future us.</p></blockquote>
<p>Once we have the indices, we fetch the actual nodes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>[<span style="color:#a6e22e">nodes</span>[<span style="color:#ae81ff">0</span>]];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>[<span style="color:#a6e22e">nodes</span>[<span style="color:#ae81ff">1</span>]];
</span></span></code></pre></div><p>Lets now prepare for interpolation between the found nodes. Assume we
have the following node distances: <code>[0, 10, 30, 50, 60]</code></p>
<p>If we request <code>20</code>, it is clearly sandwiched between <code>10</code> and <code>30</code>. No
surprises there. For linear interpolation, we need to know <em>how far</em>
<code>20</code> lies between those two values.</p>
<p>We do this step by step. Nothing fancy:</p>
<ul>
<li>Distance between <strong>left</strong> and <strong>right</strong> node: <code>30 - 10 = 20</code></li>
<li>Distance from <strong>left</strong> node to requested distance: <code>20 - 10 = 10</code></li>
<li><code>10 / 20 = 0.5</code>, so we are <strong>50%</strong> between the two nodes</li>
</ul>
<p>For safety, we clamp this value between <code>0</code> and <code>1</code>, because values
outside that range are rarely what we want.</p>
<blockquote>
<p><strong>Note:</strong> If the distance between left and right node is <code>0</code>, we
would divide by zero. That usually ends badly. In that case, there
is nothing to interpolate anyway, so we just return one of the
matrices and move on with our lives.</p></blockquote>
<p>In code, this looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">right</span>.<span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">arcLength</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> Number.<span style="color:#a6e22e">EPSILON</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>((<span style="color:#a6e22e">at</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">arcLength</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>, <span style="color:#ae81ff">0.0</span>, <span style="color:#ae81ff">1.0</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ...interpolation between left and right node goes here
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>We need a small utility function that interpolates between two
matrices.</p>
<p>Unfortunately, there is no built-in helper for this in <strong>THREE.js</strong>.
<strong>THREE.js</strong> does have helpers to interpolate <strong>vectors</strong> and
<strong>quaternions</strong> though, which is exactly what we need here.</p>
<p>A transformation matrix contains position and rotation. We extract
those parts, interpolate them separately, and then build a new
transformation matrix again. <strong>Position</strong> is interpolated
<strong>linearly</strong>. <strong>Rotation</strong> is interpolated using <strong>spherical linear
interpolation</strong> on <strong>quaternions</strong>.</p>
<p>If you already know what <strong>quaternions</strong> are, great. If not, also
fine. This is not important at this point. I will write dedicated
articles about <strong>vectors, matrices, euler and quaternions</strong> later.</p>
<p>The helper looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lerp</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">matrixA</span>: <span style="color:#66d9ef">Matrix4</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">matrixB</span>: <span style="color:#66d9ef">Matrix4</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">t</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fromQuaternion</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Quaternion</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toQuaternion</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Quaternion</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fromPosition</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toPosition</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">scale</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">matrixA</span>.<span style="color:#a6e22e">decompose</span>(<span style="color:#a6e22e">fromPosition</span>, <span style="color:#a6e22e">fromQuaternion</span>, <span style="color:#a6e22e">scale</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">matrixB</span>.<span style="color:#a6e22e">decompose</span>(<span style="color:#a6e22e">toPosition</span>, <span style="color:#a6e22e">toQuaternion</span>, <span style="color:#a6e22e">scale</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>().<span style="color:#a6e22e">compose</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fromPosition</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">toPosition</span>, <span style="color:#a6e22e">t</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fromQuaternion</span>.<span style="color:#a6e22e">slerp</span>(<span style="color:#a6e22e">toQuaternion</span>, <span style="color:#a6e22e">t</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scale</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Now we can use this to interpolate between the <strong>left</strong> and <strong>right</strong>
matrix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">matrix</span>, <span style="color:#a6e22e">right</span>.<span style="color:#a6e22e">matrix</span>, <span style="color:#a6e22e">t</span>);
</span></span></code></pre></div><p>If the distance between the nodes is <code>0</code>, things are easy. We just
return a copy of the left node’s matrix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">return</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">matrix</span>.<span style="color:#a6e22e">clone</span>();
</span></span></code></pre></div><p>Putting everything together, the full function looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">transformationAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>: <span style="color:#66d9ef">Curve</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nodes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">findBoundingIndices</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">at</span>,
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">node</span>) <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">node</span>.<span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">nodes</span>) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>[<span style="color:#a6e22e">nodes</span>[<span style="color:#ae81ff">0</span>]];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>[<span style="color:#a6e22e">nodes</span>[<span style="color:#ae81ff">1</span>]];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">right</span>.<span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">arcLength</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> Number.<span style="color:#a6e22e">EPSILON</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">at</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">arcLength</span>) <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0.0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">1.0</span>,
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">transformation</span>, <span style="color:#a6e22e">right</span>.<span style="color:#a6e22e">transformation</span>, <span style="color:#a6e22e">t</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">transformation</span>.<span style="color:#a6e22e">clone</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h1 id="linear-track-with-more-segments">Linear track with more segments</h1>
<p>To actually see this in motion, we need a small helper that constructs
curve nodes from a list of points. This is only here to make the demo
work and will be improved later.</p>
<blockquote>
<p><strong>Note</strong>: Points are duplicated to create hard transitions between
segments. For linear track segments, smooth rotation transitions do
not really make sense physically. Duplicating points is an easy way
to fake the behavior we want.</p>
<p><strong>Important</strong>: This is temporary junk. It exists only to make the
demo work quickly and will be replaced by a proper implementation
with correct normals and roll handling.</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">fromPoints</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">points</span>: <span style="color:#66d9ef">Vector3</span>[]) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">curve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">emptyCurve</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">curve</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">let</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">points</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">left</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">right</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">points</span>[<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">prevNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>[<span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">prevNode</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">prevNode.transformation</span>
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">clone</span>()
</span></span><span style="display:flex;"><span>          .<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">left</span>),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>()
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">lookAt</span>(<span style="color:#a6e22e">right</span>, <span style="color:#a6e22e">left</span>, <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>        .<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">left</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arcLength</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">left</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">right</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastNode</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">last</span>(<span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>)<span style="color:#f92672">!</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lastPoint</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">last</span>(<span style="color:#a6e22e">points</span>)<span style="color:#f92672">!</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">nodes</span>.<span style="color:#a6e22e">push</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">lastNode.transformation</span>
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">clone</span>()
</span></span><span style="display:flex;"><span>      .<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">lastPoint</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">arcLength</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">segmentIndex</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">curve</span>.<span style="color:#a6e22e">segmentOffsets</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">arcLength</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">curve</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>This helper just turns points into curve nodes and keeps track of the
distance along the curve. It is very naive, but good enough to
demonstrate the idea.</p>
<h2 id="what-comes-next">What comes next?</h2>
<p>In the next chapter, we will build curve nodes from <strong>Bezier
splines</strong>. The nice part is that we will not have to touch the
simulation logic at all. Only the curve generation changes, which is
exactly what we were aiming for from the beginning.</p>
<h2 id="demo-with-linear-track-segments">Demo with linear track segments</h2>
      

<div class="embedded ">
  <iframe
    id="react-root-8758d23f8b3cecdf4f77da760512add8"
    width="100%"
    height="380px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 100%">
    Move the control points around to get a feeling for building a roller coaster track with physics motion.
  </div>
  

  <script>
    document.getElementById('react-root-8758d23f8b3cecdf4f77da760512add8').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/curve-nodes\/MotionEvaluationDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/curve-nodes/MotionEvaluationDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useMemo</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">CurveWireframe</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/CurveWireframe&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">TrainWithPhysics</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/TrainWithPhysics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">fromPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./curve&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">wireFrameParts</span> <span style="color:#f92672">=</span> [<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>), <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MotionEvaluationDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">11.5</span>, <span style="color:#ae81ff">2.5</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">0.75</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">7.5</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">0.5</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.5</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">curve</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useMemo</span>(() <span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">fromPoints</span>(<span style="color:#a6e22e">points</span>), [<span style="color:#a6e22e">points</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">axisLock</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">CurveWireframe</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rails</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">wireFrameParts</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">tie</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">wireFrameParts</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">TrainWithPhysics</span> <span style="color:#a6e22e">curve</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">curve</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Transformation Matrix</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/transformation-matrix/</link><pubDate>Sun, 21 Dec 2025 13:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/transformation-matrix/</guid><description>&lt;p&gt;Right now, when we want to know the &lt;strong&gt;position&lt;/strong&gt; and &lt;strong&gt;forward
direction&lt;/strong&gt; along a curve, we ask two separate functions. This works,
but having two separate functions for the same &lt;strong&gt;node&lt;/strong&gt; on the track
is odd and adds more complexity than we actually need.&lt;/p&gt;
&lt;p&gt;Earlier we mentioned that there is a better way to describe this kind
of information. That better way is a &lt;strong&gt;4x4 transformation matrix&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;A transformation matrix can hold &lt;strong&gt;position&lt;/strong&gt; and &lt;strong&gt;directions&lt;/strong&gt; at
the same time. This is exactly what we need to describe a &lt;strong&gt;node&lt;/strong&gt;
along the track. Once we switch to &lt;strong&gt;transformation matrices&lt;/strong&gt;, the
two existing functions &lt;code&gt;forwardDirectionAtArcLength&lt;/code&gt; and
&lt;code&gt;positionAtArcLength&lt;/code&gt; naturally collapse into one. Instead of asking
the track for separate pieces of data, we ask for a &lt;strong&gt;transformation
matrix&lt;/strong&gt; at a distance along the curve and extract whatever
information we need from it.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Right now, when we want to know the <strong>position</strong> and <strong>forward
direction</strong> along a curve, we ask two separate functions. This works,
but having two separate functions for the same <strong>node</strong> on the track
is odd and adds more complexity than we actually need.</p>
<p>Earlier we mentioned that there is a better way to describe this kind
of information. That better way is a <strong>4x4 transformation matrix</strong>.</p>
<p>A transformation matrix can hold <strong>position</strong> and <strong>directions</strong> at
the same time. This is exactly what we need to describe a <strong>node</strong>
along the track. Once we switch to <strong>transformation matrices</strong>, the
two existing functions <code>forwardDirectionAtArcLength</code> and
<code>positionAtArcLength</code> naturally collapse into one. Instead of asking
the track for separate pieces of data, we ask for a <strong>transformation
matrix</strong> at a distance along the curve and extract whatever
information we need from it.</p>
<p>For that reason, we make a small but important change. From now on, we
work with <strong>tranformation matrices</strong> and remove those two functions
entirely.</p>
<p>If it helps, it is worth rereading the chapter on <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/linear-track/">linear roller
coaster
tracks</a>,
where <code>forwardDirectionAtArcLength</code> and <code>positionAtArcLength</code> were
introduced. Both are now replaced by a single function called
<code>transformationAtArcLength</code>.</p>
<p>For a linear track segment, this is straightforward. We compute the
<strong>position</strong> exactly like before using linear interpolation. For
orientation, we let <strong>THREE.js</strong> build a matrix that <code>lookAt</code>s from
one control point to the other. This gives us a correct <strong>forward
direction</strong> without any extra work.</p>
<blockquote>
<p><strong>Note:</strong> At this stage, we only need a valid <strong>forward direction</strong>.
There is no need to complicate things with <strong>roll</strong>, so we ignore it
for now.</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">transformationAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">position</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">cp1</span>
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">clone</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">cp2</span>, <span style="color:#a6e22e">at</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">cp1</span>, <span style="color:#a6e22e">cp2</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Matrix4</span>()
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">lookAt</span>(<span style="color:#a6e22e">cp2</span>, <span style="color:#a6e22e">cp1</span>, <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>))
</span></span><span style="display:flex;"><span>    .<span style="color:#a6e22e">setPosition</span>(<span style="color:#a6e22e">position</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>With this change, we also need to adjust <code>evaluateMotion</code>. Instead of
receiving a <strong>forward direction</strong> vector, it now receives a
<strong>transformation matrix</strong>. We then extract the <strong>forward direction</strong>
from that transformation.</p>
<p>This is very straightforward. Here is a small helper to extract the
<strong>forward direction</strong> from a <strong>transformation matrix</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">toFrontDirection</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">m</span>: <span style="color:#66d9ef">Matrix4</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">elements</span>[<span style="color:#ae81ff">8</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">elements</span>[<span style="color:#ae81ff">9</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">elements</span>[<span style="color:#ae81ff">10</span>],
</span></span><span style="display:flex;"><span>  ).<span style="color:#a6e22e">normalize</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Now we use this helper to extract the <strong>forward direction</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">forwardDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toFrontDirection</span>(<span style="color:#a6e22e">transformation</span>);
</span></span></code></pre></div><p>With that in place, the full updated <code>evaluateMotion</code> function looks
like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">transformation</span>: <span style="color:#66d9ef">Matrix4</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">additionalAcceleration</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">friction</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">airResistance</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gravity</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">forwardDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">toFrontDirection</span>(<span style="color:#a6e22e">transformation</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">airResistance</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">friction</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gravity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">velocityDirection</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">energyLoss</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">additionalAcceleration</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">acceleration</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h2 id="what-comes-next">What comes next?</h2>
<p>These changes are mostly structural. Visually, nothing changes yet.
Under the hood, however, the simulation now works entirely with
<strong>transformation matrices</strong>, which will make later changes easier.</p>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/curve-nodes/">In the next
chapter</a>,
we move away from linear segments and introduce a more general way to
describe <strong>curves</strong>. That will require a new implementation of
<code>transformationAtArcLength</code>, but the rest of the simulation can stay
as it is.</p>
<p>This is the kind of refactor we want. We change how the track is
described without rewriting everything built on top of it.</p>
<h2 id="interactive-demo-and-code">Interactive demo and code</h2>
<p>There is no visible difference in the demo. The train behaves exactly
as before. The only change is that the simulation now uses
<code>transformationAtArcLength</code> internally.</p>
<p>For completeness, the full demo is shown below.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-2060dce35e30160396e2eb7464222b98"
    width="100%"
    height="480px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-2060dce35e30160396e2eb7464222b98').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/transformation-matrix\/TransformationMatrixDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/transformation-matrix/TransformationMatrixDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useEffect</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useFrame</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/fiber&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">MathUtils</span>, <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">totalArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">transformationAtArcLength</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/linear&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">evaluateMotion</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../helper/physics&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useSimulationStateControls</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useSimulationStateControls&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">PointWithMatrixArrows</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/PointWithMatrixArrows&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TransformationMatrixDemo</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// control points
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">11.5</span>, <span style="color:#ae81ff">3.2</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.8</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">simulationState</span>, <span style="color:#a6e22e">setSimulationState</span>] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">useSimulationStateControls</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useFrame</span>((<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">deltaTime</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">evaluateMotion</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">transformationAtArcLength</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">friction</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">airResistance</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">gravity</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deltaTime</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">simulationSpeed</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// reset simulation state if train overshoots track
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setSimulationState</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, [<span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setSimulationState</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">motionMatrix</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">transformationAtArcLength</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">axisLock</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">PointWithMatrixArrows</span> <span style="color:#a6e22e">matrix</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">motionMatrix</span>} /&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">TransformationMatrixDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">TransformationMatrixDemo</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Friction and Air Resistance</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/friction-and-air-resistance/</link><pubDate>Sat, 06 Dec 2025 12:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/friction-and-air-resistance/</guid><description>&lt;p&gt;This chapter will be quite short and introduces two small but
important parts of a more realistic roller coaster simulation:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;friction&lt;/li&gt;
&lt;li&gt;air resistance&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Until now, our coaster moved in a world without any energy loss. That
works for understanding the basics but real coasters slow down over
time. Wheels create friction, air pushes against the train, and both
effects reduce the acceleration the train can achieve.&lt;/p&gt;
&lt;p&gt;We will not create a complex physics model. Instead we introduce two
simple parameters, very similar to what you may know from &lt;strong&gt;NoLimits
Roller Coaster&lt;/strong&gt;.&lt;br&gt;
Our physics simulation should behave almost identically, apart from a
few edge cases.&lt;/p&gt;</description><content type="html"><![CDATA[<p>This chapter will be quite short and introduces two small but
important parts of a more realistic roller coaster simulation:</p>
<ul>
<li>friction</li>
<li>air resistance</li>
</ul>
<p>Until now, our coaster moved in a world without any energy loss. That
works for understanding the basics but real coasters slow down over
time. Wheels create friction, air pushes against the train, and both
effects reduce the acceleration the train can achieve.</p>
<p>We will not create a complex physics model. Instead we introduce two
simple parameters, very similar to what you may know from <strong>NoLimits
Roller Coaster</strong>.<br>
Our physics simulation should behave almost identically, apart from a
few edge cases.</p>
<p>Since both <strong>friction</strong> and <strong>air resistance</strong> represent energy loss,
we simply subtract them from the acceleration we calculated from
gravity. This is almost correct, but there is one detail to handle
when the train moves backward. More on that in the section <strong>When
riding backward, what happens?</strong>.</p>
<h2 id="friction">Friction</h2>
<p>Friction is the permanent resistance between the train and the track.
We apply it directly to the acceleration. The idea is very simple:
multiply the friction constant with gravity and subtract it from the
current acceleration.</p>
<p>A typical friction value in is about <strong>0.03 m/m</strong> (height loss per
meter).</p>
$$friction \cdot gravity$$<h2 id="air-resistance">Air Resistance</h2>
<p>Air resistance works differently. It <strong>increases</strong> with <strong>velocity</strong>.
The faster the train moves, the more the air pushes back against it.</p>
<p>A typical air resistance value is around <strong>0.00002 m/s²</strong>. We follow
the same idea and use this value as the base for our simplified model.
The <strong>resistance</strong> grows with <strong>velocity²</strong>, so we multiply it with
<strong>velocity²</strong> and the air resistance constant:</p>
$$airResistance \cdot velocity^2$$<p>This removes more energy when the train moves fast and almost none
when it moves slowly.</p>
<h1 id="when-riding-backward-what-happens">When riding backward, what happens?</h1>
<p>There is one small detail we have to handle. If the train moves
<strong>backward</strong>, the velocity becomes negative. This also means our
energy loss must flip direction. Otherwise we would accidentally add
energy instead of removing it.</p>
<p>To put it simply:</p>
<ul>
<li>when riding <strong>forward</strong>, friction and air resistance <strong>subtract</strong>
energy</li>
<li>when riding <strong>backward</strong>, they must still subtract energy, but from
the <strong>opposite</strong> direction</li>
</ul>
<p>So we need a small multiplier that tells us whether the train is
moving forward or backward:</p>
<ul>
<li>If the velocity is <strong>negative</strong>, the factor becomes <strong>-1</strong></li>
<li>If the velocity is <strong>positive</strong>, the factor is <strong>1</strong></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span></code></pre></div><p>We can now apply this factor to the total energy loss</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">airResistance</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">friction</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gravity</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">velocityDirection</span>;
</span></span></code></pre></div><p>This flips the resistance forces to the correct direction depending on
the current motion. That is the whole trick.</p>
<p>Now subtract energy loss from acceleration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(<span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">-</span> <span style="color:#a6e22e">energyLoss</span>;
</span></span></code></pre></div><h2 id="updated-evaluatemotion-function">Updated evaluateMotion function</h2>
<p>Putting everything together, the full motion evaluation now looks like
this.<br>
For the sake of the demo, the function is named
<code>evaluateMotionWithFrictionAndAirResistance</code> so we can compare
behavior with and without air resistance. You can still name it
<code>evaluateMotion</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotionWithFriction</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirection</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">friction</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">airResistance</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gravity</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocityDirection</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">1</span> : <span style="color:#66d9ef">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">airResistance</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">+=</span> <span style="color:#a6e22e">friction</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">gravity</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">energyLoss</span> <span style="color:#f92672">*=</span> <span style="color:#a6e22e">velocityDirection</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">-=</span> <span style="color:#a6e22e">energyLoss</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">acceleration</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>We still compute the gravity acceleration first. After that we
subtract the energy losses from friction and air resistance. Even
though this is a very simple model, the difference becomes immediately
visible. The train will no longer accelerate forever or keep moving at
impossible speeds.</p>
<h2 id="demo-with-friction-and-air-resistance">Demo with friction and air resistance</h2>
<p>Just like in the previous chapter, here is a small interactive demo.
This time it includes both friction and air resistance so you can see
how the coaster behaves when energy loss is part of the simulation.</p>
<ul>
<li>The <strong>orange</strong> dot represents a train with friction and air
resistance applied.</li>
<li>The <strong>white</strong> dot shows the same motion without any energy loss.</li>
</ul>
<p>Feel free to move the control points to experiment with the track
shape and see how both trains react differently.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-a6144fdd4e0d7b14572bff6cc09b0427"
    width="100%"
    height="460px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-a6144fdd4e0d7b14572bff6cc09b0427').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/friction-and-air-resistance\/FrictionAndAirResistanceDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/transformation-matrix/">In the next
chapter</a>
we will make a few changes to the track itself, preparing everything
for an agnostic evaluation of physics. No matter what the underlying
geometry is in the end, <strong>splines, imported tracks, FVD-based shapes
or anything else, the evaluation should always work the same</strong>. The
key step is replacing the two functions <code>positionAtArcLength</code> and
<code>forwardDirectionAtArcLength</code> with a single
<code>transformationAtArcLength</code> function. Working with <strong>matrices</strong> is
more convenient, because we can extract everything we need from them.
I will also introduce a <strong>curve node</strong> that stores a full matrix for a
given distance along the track. Any geometry system can “fill” these
<strong>curve nodes</strong>, whether that system is based on splines, imported CSV
data, FVD geometries or something entirely different. While writing
this, I realize it is probably best to introduce the concept first
with a simple linear track. Stay tuned.</p>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/friction-and-air-resistance/FrictionAndAirResistanceDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useEffect</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useFrame</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/fiber&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">MathUtils</span>, <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirectionAtArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">positionAtArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">totalArcLength</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/linear&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useSimulationStateControls</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useSimulationStateControls&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ControlPoint</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/ControlPoint&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">evaluateMotion</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">evaluateMotionWithFriction</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../linear-track/physics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">FrictionAndAirResistanceDemo</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">11.5</span>, <span style="color:#ae81ff">3.2</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.8</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">simulationState</span>, <span style="color:#a6e22e">setSimulationState</span>] <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">useSimulationStateControls</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">simulationStateWithoutFriction</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationStateWithoutFriction</span>,
</span></span><span style="display:flex;"><span>  ] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>(() <span style="color:#f92672">=&gt;</span> ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useFrame</span>((<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">deltaTime</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// with friction and air resistance
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">setSimulationState</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">evaluateMotionWithFriction</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">forwardDirectionAtArcLength</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">friction</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">airResistance</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">gravity</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deltaTime</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">simulationSpeed</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// without energy loss
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">setSimulationStateWithoutFriction</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">evaluateMotion</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationStateWithoutFriction</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">forwardDirectionAtArcLength</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">simulationStateWithoutFriction</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">gravity</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deltaTime</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">simulationSpeed</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// reset simulation state if train overshoots track
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setSimulationState</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setSimulationStateWithoutFriction</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, [
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationStateWithoutFriction</span>,
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">trainPosition</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positionAtArcLength</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">trainPositionWithoutFriction</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positionAtArcLength</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">clamp</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationStateWithoutFriction</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]),
</span></span><span style="display:flex;"><span>    ),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">axisLock</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">ControlPoint</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">trainPosition</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">ControlPoint</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">trainPositionWithoutFriction</span>} /&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">FrictionAndAirResistanceDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">FrictionAndAirResistanceDemo</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Linear Track</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/linear-track/</link><pubDate>Sat, 06 Dec 2025 11:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/linear-track/</guid><description>&lt;p&gt;To visualize motion properly, we need something for our little object
to move along. And that means we need a track.&lt;/p&gt;
&lt;p&gt;In this article, we focus on an extremely simplified roller coaster
track. And when I say extremely simplified, I really mean it: it&amp;rsquo;s
just a plane. A straight line. A first-order curve. Basically the
easiest form of track you can possibly build without accidentally
creating a real coaster.&lt;/p&gt;
&lt;p&gt;From the last chapter, we know how motion evaluation works. The
evaluation function receives an acceleration value and returns a new
simulation state containing the updated velocity and the total
distance traveled:&lt;/p&gt;</description><content type="html"><![CDATA[<p>To visualize motion properly, we need something for our little object
to move along. And that means we need a track.</p>
<p>In this article, we focus on an extremely simplified roller coaster
track. And when I say extremely simplified, I really mean it: it&rsquo;s
just a plane. A straight line. A first-order curve. Basically the
easiest form of track you can possibly build without accidentally
creating a real coaster.</p>
<p>From the last chapter, we know how motion evaluation works. The
evaluation function receives an acceleration value and returns a new
simulation state containing the updated velocity and the total
distance traveled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">acceleration</span>, <span style="color:#a6e22e">deltaTime</span>);
</span></span></code></pre></div><p>It returns something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;velocity&#34;</span>: <span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;distanceTraveled&#34;</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now that we introduce a track, things become a bit more interesting.
The old <code>evaluateMotion</code> function worked with a fixed slope and
gravity using this formula:</p>
$$acceleration = gravity \cdot \sin(slopeAngle)$$<p>But we want to move toward real coaster geometry later, where slopes
change every centimeter. So we replace the <code>acceleration</code> parameter
and introduce two new parameters:</p>
<ul>
<li><strong>forwardDirection</strong>, a vector pointing forward along the track at
the given distance</li>
<li><strong>gravity</strong>, the classic 9.81 m/s² thing</li>
</ul>
<p>We won&rsquo;t use <code>gravity * Math.sin(slopeAngle)</code> anymore, because once we
have a forward direction, there is a cleaner way.</p>
<blockquote>
<p>We simply define a gravity direction vector.</p></blockquote>
<p>Gravity always points downward to Earth, basically along the negative
y-axis:</p>
$$\vec{gravityDir} = \begin{bmatrix} 0 \\ -9.81 \\ 0 \end{bmatrix}$$<p>Now what do we do with <code>forwardDirection</code> and <code>gravityDirection</code>? We
take their dot product. That’s it. Really. That’s the whole trick:</p>
$$acceleration = \vec{forwardDir} \times \vec{gravityDir}$$<p>This one line replaces the entire downhill-slope acceleration formula
thing:</p>
$$acceleration = gravity * sin(slopeAngle)$$<p>In code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>Since we now calculate <strong>acceleration</strong> dynamically, we extend
<code>SimulationState</code> with a readonly <code>acceleration</code> property:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>And our updated <code>evaluateMotion</code> function becomes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirection</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">gravity</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">forwardDirection</span>.<span style="color:#a6e22e">dot</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#a6e22e">gravity</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">acceleration</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h2 id="answering-important-questions">Answering important questions</h2>
<p>Once the motion step gives us a <strong>distance traveled</strong>, we need to
convert this number into something the renderer can actually work
with.</p>
<p>Even the easiest possible track must answer <strong>two important
questions</strong> for physics and visualization:</p>
<blockquote>
<p>Where is the 3D position at a given distance along the curve?</p></blockquote>
<p>Whether the track is straight or twisting like a crazy pretzel, the
logic is the same.</p>
<ul>
<li>After traveling <strong>1 meter</strong>, we need the <strong>position at 1 meter</strong>.</li>
<li>After <strong>5 meters</strong>, we need the <strong>position at 5 meters</strong>.</li>
</ul>
<p>So we need a function that returns the position at any distance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">positionAtArcLength</span>(<span style="color:#a6e22e">at</span>);
</span></span></code></pre></div><p>We also need the forward direction at that distance, because the
evaluation function requires it as an input, as we introduced just a
few sentences above. So we must answer:</p>
<blockquote>
<p>What is the forward direction at a given distance along a curve?</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#a6e22e">forwardDirectionAtArcLength</span>(<span style="color:#a6e22e">at</span>);
</span></span></code></pre></div><p>Both functions work purely on the curve geometry.</p>
<h2 id="positionatarclength-on-linear-curves">positionAtArcLength on Linear “Curves”</h2>
<p>For linear curves, this is as easy as it gets. Later, we will switch
to proper splines for real coaster geometry.</p>
<p>A linear curve has two control points: <code>cp1</code> and <code>cp2</code>, both simple 3D
vectors. We use THREE.js for convenience.</p>
<h3 id="how-do-we-get-the-3d-position-at-a-distance">How do we get the 3D position at a distance?</h3>
<p>We linearly interpolate between the two points:</p>
$$ \vec{pos} = \vec{cp1} + (\vec{cp2} - \vec{cp1}) \cdot t $$<p>Where <strong>t</strong> is the fraction of the segment we’ve traveled:</p>
<ul>
<li>0 → cp1</li>
<li>1 → cp2</li>
<li>0.5 → halfway</li>
</ul>
<p><code>t</code> is computed by dividing the traveled distance by the segment
length:</p>
$$ t = \frac{distance}{length} $$<p>Distance between control points:</p>
$$ length = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2} $$<p>Putting it all together:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positionAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sqrt</span>(
</span></span><span style="display:flex;"><span>    (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">x</span>) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">y</span>) <span style="color:#f92672">**</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">at</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">length</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">x</span>: <span style="color:#66d9ef">cp1.x</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">x</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">x</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">y</span>: <span style="color:#66d9ef">cp1.y</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">y</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">y</span>) <span style="color:#f92672">*</span> <span style="color:#a6e22e">t</span>,
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>Or using <strong>THREE.js</strong> to save yourself some sanity and avoid
reinventing the wheel over and over again. I explained this part
without THREE.js as well, but you may just forget it, the articles get
way too big if I try to explain every concept of vectors and math in
detail. For now we simply know: THREE.js is our friend:</p>
<p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">totalArcLength</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>, <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">distanceTo</span>(<span style="color:#a6e22e">cp2</span>);
</span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positionAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cp1</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">lerp</span>(<span style="color:#a6e22e">cp2</span>, <span style="color:#a6e22e">at</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">cp1</span>, <span style="color:#a6e22e">cp2</span>));
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div></p>
<h2 id="how-to-calculate-forward-direction-along-the-curve">How to Calculate Forward Direction Along the Curve</h2>
<p>Since this is a linear curve, the forward direction is constant
everywhere. It doesn’t get easier than this.</p>
<p>Mathematically:</p>
$$ \vec{forwardDir} = \frac{\vec{cp2} - \vec{cp1}}{\lVert \vec{cp2} -
\vec{cp1} \rVert} $$<p>Translated into code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">forwardDirectionAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp1</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">cp2</span>: <span style="color:#66d9ef">Vector3</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">cp2</span>.<span style="color:#a6e22e">clone</span>().<span style="color:#a6e22e">sub</span>(<span style="color:#a6e22e">cp1</span>).<span style="color:#a6e22e">normalize</span>();
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h2 id="small-note">Small note</h2>
<p>Later the forward vector will be replaced by a <strong>4×4 matrix</strong>, which
includes position, forward, right and up vectors all at once. That
matrix will become our single source of truth, which makes it possible
to reduce everything to just one method called
<code>transformationAtArcLength</code>. I know, yet again a change, but that’s
future you’s problem. Ignore it for now.</p>
<p>Going forward, we will use <strong>9.81665 m/s²</strong> as the gravitational
acceleration, since this is also the value used by <strong>NoLimits Roller
Coaster</strong> and <strong>openFVD++</strong>.</p>
<h2 id="adding-everything-up">Adding Everything Up</h2>
<p>Time for a small demo. I built a basic setup: a visible line segment
with draggable control points so you can adjust the slope in real
time. On the side, a small panel displays the live simulation state.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-e40f7c9f846124747cb4339c310a804d"
    width="100%"
    height="360px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-e40f7c9f846124747cb4339c310a804d').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/linear-track\/LinearTrackDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>I’ve polished things a bit and moved the physics and linear
interpolation logic into their own files instead of keeping everything
as spaghetti code. The complete source code is available in my GitHub
repo, feel free to explore and play around with it.</p>
<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/friction-and-air-resistance/">In the next
chapter</a>
we will introduce friction and air resistance. You’ll be able to play
with the parameters in a demo and compare both physics evaluations,
with and without energy loss.</p>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/linear-track/LinearTrackDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useEffect</span>, <span style="color:#a6e22e">useState</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useFrame</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/fiber&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useControls</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;leva&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">forwardDirectionAtArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">positionAtArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">totalArcLength</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../maths/linear&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ControlPoint</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/ControlPoint&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Ground</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Ground&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">EditorScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/EditorScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">evaluateMotion</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./physics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">LinearTrackDemo</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// control points
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">11.5</span>, <span style="color:#ae81ff">3.2</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">2.8</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">simulationState</span>, <span style="color:#a6e22e">setSimulationState</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useControls</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;Simulation&#39;</span>,
</span></span><span style="display:flex;"><span>    () <span style="color:#f92672">=&gt;</span> ({
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">acceleration</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">gravity</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">9.81665</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    }),
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useFrame</span>((<span style="color:#a6e22e">state</span>, <span style="color:#a6e22e">deltaTime</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">evaluateMotion</span>(
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">forwardDirectionAtArcLength</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">gravity</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">deltaTime</span>,
</span></span><span style="display:flex;"><span>      ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// reset simulation state if train overshoots track
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">totalArcLength</span>(<span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>]) <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setSimulationState</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, [<span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>, <span style="color:#a6e22e">setSimulationState</span>, <span style="color:#a6e22e">points</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">trainPosition</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">positionAtArcLength</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">axisLock</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;z&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Ground</span> <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>]} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">ControlPoint</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">trainPosition</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">LinearTrackDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">LinearTrackDemo</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">EditorScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Evaluating Motion</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/evaluating-motion/</link><pubDate>Sat, 06 Dec 2025 10:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/evaluating-motion/</guid><description>&lt;p&gt;Before we implement the function, there&amp;rsquo;s one small simplification we
need to mention: In this chapter we will always evaluate the motion
every &lt;strong&gt;16 ms (0.016 seconds)&lt;/strong&gt;, which corresponds to roughly &lt;strong&gt;60
frames per second&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Using a fixed time step makes the formulas easier to understand for
this article.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: In real simulations or game engines, you usually don’t
assume a constant time value. Instead, you take the actual delta
time from the game loop, so that the motion stays consistent even if
the frame rate changes. &lt;strong&gt;More on that later&lt;/strong&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<p>Before we implement the function, there&rsquo;s one small simplification we
need to mention: In this chapter we will always evaluate the motion
every <strong>16 ms (0.016 seconds)</strong>, which corresponds to roughly <strong>60
frames per second</strong>.</p>
<p>Using a fixed time step makes the formulas easier to understand for
this article.</p>
<blockquote>
<p><strong>Note</strong>: In real simulations or game engines, you usually don’t
assume a constant time value. Instead, you take the actual delta
time from the game loop, so that the motion stays consistent even if
the frame rate changes. <strong>More on that later</strong>.</p></blockquote>
<p>But for the sake of clarity in this chapter: We assume that every
update happens exactly every <strong>16 ms</strong>. This keeps the examples simple
and lets us focus on the physics first.</p>
<p>Now that we know how acceleration works and how gravity affects the
coaster depending on the slope, we can finally build the first real
part of our simulation. The idea is simple. Every small time step we
calculate how much the coaster changes its speed and how much distance
it travels.</p>
<p>We start with a minimal simulation state.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">number</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">simulationState</span>: <span style="color:#66d9ef">SimulationState</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>In the beginning, the coaster does not move and has not traveled any
distance.</p>
<h2 id="the-evaluatemotion-function">The evaluateMotion function</h2>
<p>Our simulation works by creating a new state based on the previous
state. Think of it like this:</p>
<blockquote>
<p>initial state → evaluate → new state → evaluate → new state → &hellip;</p></blockquote>
<p>To calculate the acceleration along the slope, we now implement the
downhill-slope acceleration formula from <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/gravity/">Chapter
2</a>.
This formula tells us how much of gravity actually acts in the
direction of the slope:</p>
$$acceleration = gravity * sin(slopeAngle)$$<p>So we end up basically with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slopeAngle</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">/// ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span></code></pre></div><ul>
<li>slopeAngle controls how steep the slope is</li>
<li>deltaTime is how much time passed since the last calculation (we use
16 ms)</li>
</ul>
<h2 id="calculating-the-velocity">Calculating the velocity</h2>
<p>Acceleration is measured in <strong>m/s²</strong>. That means:</p>
<blockquote>
<p><strong>m/s²</strong> tells us how much the velocity changes in one <strong>full
second</strong>.</p></blockquote>
<p>So if acceleration is <strong>9.81 m/s²</strong>:</p>
<ul>
<li>after <strong>1 second</strong>, velocity increases by <strong>9.81 m/s</strong></li>
<li>so after <strong>0.016 seconds</strong>, velocity increases by \(9.81 *
0.016\) Just multiply it with <strong>0.016</strong> :) that does the trick</li>
</ul>
$$velocity = acceleration * deltaTime$$<p>We take the previous velocity and add the small increase for this
frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span></code></pre></div><h2 id="calculating-the-distance-traveled">Calculating the distance traveled</h2>
<p>Velocity is measured in <strong>m/s</strong>. This means:</p>
<blockquote>
<p>velocity tells us how much <strong>distance</strong> is to travel in <strong>one full
second</strong>.</p></blockquote>
<p>Again we only want the part that matches our <strong>0.016 seconds</strong>.</p>
$$distanceToTravel = velocity \cdot deltaTime$$<p>We take the previous distance traveled and add the small increase for
this frame.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span></code></pre></div><p>So we end up with something like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">evaluateMotion</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">state</span>: <span style="color:#66d9ef">SimulationState</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acceleration</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">deltaTime</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>)<span style="color:#f92672">:</span> <span style="color:#a6e22e">SimulationState</span> <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">velocity</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">state</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">velocity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">deltaTime</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> { <span style="color:#a6e22e">velocity</span>, <span style="color:#a6e22e">distanceTraveled</span> };
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>This is already a complete physics step without friction or air
resistance.</p>
<h2 id="interactive-demo">Interactive demo</h2>
<p>Just like in the last chapter, we again have an interactive demo. This
time, we’ve implemented a simple motion-evaluation method that applies
basic physics. In this demo you can play around with the slope and
already see a physical motion emerging.</p>
<blockquote>
<p><strong>Important note:</strong> Earlier in this article I said we would evaluate
everything every <strong>16 ms</strong>, right? Well… that was kind of a lie, at
least for this demo.<br>
Since we’re using <strong>THREE.js</strong>, we <em>can</em> make use of the <code>useFrame</code>
hook, which gives us the <strong>delta time of the previous frame</strong>, and
we benefit from using it. This is the proper way to handle updates,
instead of forcing a fixed 16 ms step, which I briefly covered in
the introduction of this chapter.</p></blockquote>
      

<div class="embedded ">
  <iframe
    id="react-root-2258e6e329b9e597c11aea6173475d0c"
    width="100%"
    height="360px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-2258e6e329b9e597c11aea6173475d0c').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/evaluating-motion\/MotionEvaluationDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/linear-track/">In the next
chapter</a>
we’ll add a basic roller coaster track, just a straight, linear
segment. This is a preparation for the real coaster curvatures we’ll
build later.</p>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/evaluating-motion/MotionEvaluationDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useEffect</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useFrame</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/fiber&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useControls</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;leva&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">MathUtils</span>, <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Arrow</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Arrow&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">ControlPoint</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/ControlPoint&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">OrthographicScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/OrthographicScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">evaluateMotion</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./physics&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MotionEvaluationDemo</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [
</span></span><span style="display:flex;"><span>    { <span style="color:#a6e22e">slope</span>, <span style="color:#a6e22e">gravity</span>, <span style="color:#a6e22e">sinSlope</span>, <span style="color:#a6e22e">trackLength</span>, ...<span style="color:#a6e22e">simulationState</span> },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>,
</span></span><span style="display:flex;"><span>  ] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useControls</span>(() <span style="color:#f92672">=&gt;</span> ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">slope</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">45</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">step</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">min</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">180</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">max</span>: <span style="color:#66d9ef">180</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trackLength</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">8</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">step</span>: <span style="color:#66d9ef">1</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">min</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">max</span>: <span style="color:#66d9ef">20</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gravity</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">9.81665</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sinSlope</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">disabled</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sin(slope)&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [, <span style="color:#a6e22e">setState</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useControls</span>(() <span style="color:#f92672">=&gt;</span> ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acceleration</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">disabled</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useFrame</span>((<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">deltaTime</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sinSlope</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">degToRad</span>(<span style="color:#a6e22e">slope</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">sinSlope</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">evaluateMotion</span>(<span style="color:#a6e22e">simulationState</span>, <span style="color:#a6e22e">acceleration</span>, <span style="color:#a6e22e">deltaTime</span>),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setState</span>({ <span style="color:#a6e22e">acceleration</span> });
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// reset simulation state if train overshoots track
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span> <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">trackLength</span>
</span></span><span style="display:flex;"><span>    ) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">setSimulationState</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">velocity</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">distanceTraveled</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, [
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">trackLength</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setSimulationState</span>,
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">group</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rotation</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">degToRad</span>(<span style="color:#a6e22e">slope</span>)]}
</span></span><span style="display:flex;"><span>      &gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Arrow</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#f92672">-</span><span style="color:#a6e22e">trackLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">rotation</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, Math.<span style="color:#a6e22e">PI</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">ControlPoint</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(
</span></span><span style="display:flex;"><span>              <span style="color:#a6e22e">trackLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">simulationState</span>.<span style="color:#a6e22e">distanceTraveled</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>              <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>          }
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Line</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{[
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">trackLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#a6e22e">trackLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>          ]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">group</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">MotionEvaluationDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">MotionEvaluationDemo</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Gravity</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/gravity/</link><pubDate>Sat, 06 Dec 2025 09:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/gravity/</guid><description>&lt;h2 id="how-do-we-determine-the-acceleration-of-the-coaster"&gt;How do we determine the acceleration of the coaster?&lt;/h2&gt;
&lt;p&gt;To simplify things, we ignore air resistance, rolling friction and any
other additional forces. We also assume Earth’s gravity is &lt;strong&gt;9.81
m/s²&lt;/strong&gt;. This allows us to focus entirely on the fundamental idea:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Gravity is the primary source of acceleration.&lt;/strong&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;On Earth, gravity provides a constant acceleration of roughly &lt;strong&gt;9.81
m/s²&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;What does this number actually mean?&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Every &lt;strong&gt;second&lt;/strong&gt;, an object&amp;rsquo;s speed increases by &lt;strong&gt;9.81 m/s&lt;/strong&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<h2 id="how-do-we-determine-the-acceleration-of-the-coaster">How do we determine the acceleration of the coaster?</h2>
<p>To simplify things, we ignore air resistance, rolling friction and any
other additional forces. We also assume Earth’s gravity is <strong>9.81
m/s²</strong>. This allows us to focus entirely on the fundamental idea:</p>
<blockquote>
<p><strong>Gravity is the primary source of acceleration.</strong></p></blockquote>
<p>On Earth, gravity provides a constant acceleration of roughly <strong>9.81
m/s²</strong>.</p>
<p>What does this number actually mean?</p>
<blockquote>
<p>Every <strong>second</strong>, an object&rsquo;s speed increases by <strong>9.81 m/s</strong>.</p></blockquote>
<p>Some quick examples:</p>
<ul>
<li>after <strong>1 second</strong> → 9.81 m/s</li>
<li>after <strong>2 seconds</strong> → 19.62 m/s</li>
<li>after <strong>3 seconds</strong> → 29.43 m/s</li>
</ul>
<p>In short: <strong>acceleration continuously increases an object&rsquo;s speed.</strong></p>
<hr>
<h2 id="acceleration-on-slopes">Acceleration on slopes</h2>
<p>Gravity is always pointing straight down.<br>
But on a slope, only a part of that force helps the coaster move along
the track.</p>
<p>To compute that portion, we use the <strong>downhill-slope acceleration</strong>:</p>
$$acceleration = gravity \cdot sin(angle)$$<p>Where:</p>
<ul>
<li><strong>gravity</strong>: Earth’s gravity (9.81 m/s²)</li>
<li><strong>angle</strong>: the tilt of the track</li>
<li><strong>sin(angle)</strong>: how much of gravity points <strong>along</strong> the track</li>
</ul>
<h3 id="but-why">But why?</h3>
<p>For simplification, we only look at <strong>downward slopes</strong> at this
point.<br>
Of course, in a real simulation we also have <strong>negative angles</strong> when
the coaster travels uphill, but we will get to that later.</p>
<p>For these downhill angles, the relevant sine values lie between <strong>0
and 1</strong>:</p>
<ul>
<li><strong>sin = 0</strong> → no gravity along the track</li>
<li><strong>sin = 1</strong> → full gravity along the track</li>
</ul>
<h3 id="examples">Examples</h3>
<h4 id="vertical-drop-90"><strong>Vertical drop (90°)</strong></h4>
<p>Full gravity acts along the track, essentially free fall.</p>
<ul>
<li>sin(90°) = 1 (100% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>9.81 m/s²</strong></li>
</ul>
<hr>
<h4 id="45-slope"><strong>45° slope</strong></h4>
<p>You probably expected to get <strong>half of gravity</strong> here, right? Nope,
it&rsquo;s not linear at all. It’s a sine function.</p>
<ul>
<li>sin(45°) ≈ 0.707 (≈ 70% of <strong>gravity</strong>)</li>
<li>acceleration ≈ <strong>6.93 m/s²</strong></li>
</ul>
<hr>
<h4 id="flat-track-0"><strong>Flat track (0°)</strong></h4>
<p>No slope → no downhill force.</p>
<ul>
<li>sin(0°) = 0 (0% of <strong>gravity</strong>)</li>
<li>acceleration = <strong>0 m/s²</strong></li>
</ul>
<hr>
<h2 id="why-this-matters-for-simulation">Why this matters for simulation</h2>
<p>As you can see, to simulate our coaster we only need to know:</p>
<blockquote>
<p><strong>the angle of the track at each point.</strong></p></blockquote>
<ul>
<li>0° → <strong>0 m/s²</strong>, no acceleration</li>
<li>45° → <strong>6.93 m/s²</strong>, about 70% of gravity</li>
<li>90° → <strong>9.81 m/s²</strong>, full gravity (free fall)</li>
</ul>
<p>And the crucial insight is:</p>
<blockquote>
<p><strong>This relationship is not linear, it&rsquo;s governed by sine.</strong></p></blockquote>
<p>This is why 45° does <em>not</em> give half of Earth&rsquo;s gravity, but roughly
<strong>70%</strong>.</p>
<h2 id="interactive-example">Interactive Example</h2>
<p>When it comes to calculating the acceleration component along the
slope, the formula ultimately reduces to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">slope</span>);
</span></span></code></pre></div><blockquote>
<p>Keep in mind that <code>Math.sin</code> accepts <strong>radians</strong>, not <strong>degrees</strong>.</p>
<p>A <strong>radian</strong> is simply another way of measuring angles, where angles
are expressed as multiples of <strong>π</strong>.</p>
<p>The range from <strong>−π to π</strong> corresponds to <strong>−180° to 180°</strong>.</p>
<p>In code, we almost always work with <strong>radians</strong>, because most math
functions expect them. Degrees are typically used only for user
input, since they are more intuitive.</p>
<p>When converting between the two, use:</p>
$$\text{radians} = \text{degrees} \cdot \frac{\pi}{180}$$$$\text{degrees} = \text{radians} \cdot \frac{180}{\pi}$$</blockquote>
<p>You can play around with <strong>different slopes</strong> and see how they affect
the percentage of <strong>gravity applied</strong> to the coaster. Having a visual
representation of written concepts really helps me reach that <strong>I got
it</strong> moment, so it might help you as well.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-05bf029536765c93252c0878508ca789"
    width="100%"
    height="300px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-05bf029536765c93252c0878508ca789').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/writing-a-roller-coaster-simulation\/gravity\/GravityDemoScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h2 id="what-comes-next">What comes next?</h2>
<p><a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/evaluating-motion/">In the next
chapter</a>,
we’ll add motion evaluation and move a simple object along a linear
plane.</p>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/writing-a-roller-coaster-simulation/gravity/GravityDemoScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useEffect</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useControls</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;leva&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">MathUtils</span>, <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Arrow</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/Arrow&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">OrthographicScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/OrthographicScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GravityDemo</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">lineLength</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [{ <span style="color:#a6e22e">slope</span>, <span style="color:#a6e22e">gravity</span> }, <span style="color:#a6e22e">setState</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">useControls</span>(() <span style="color:#f92672">=&gt;</span> ({
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">slope</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">45</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">step</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">min</span><span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">180</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">max</span>: <span style="color:#66d9ef">180</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">gravity</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">9.81665</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sinSlope</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">disabled</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">label</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;sin(slope)&#39;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acceleration</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">disabled</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">value</span>: <span style="color:#66d9ef">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">pad</span>: <span style="color:#66d9ef">5</span>,
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  }));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">useEffect</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">sinSlope</span> <span style="color:#f92672">=</span> Math.<span style="color:#a6e22e">sin</span>(<span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">degToRad</span>(<span style="color:#a6e22e">slope</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">acceleration</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">gravity</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">sinSlope</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">setState</span>({ <span style="color:#a6e22e">acceleration</span>, <span style="color:#a6e22e">sinSlope</span> });
</span></span><span style="display:flex;"><span>  }, [<span style="color:#a6e22e">slope</span>, <span style="color:#a6e22e">gravity</span>, <span style="color:#a6e22e">setState</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">group</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rotation</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">MathUtils</span>.<span style="color:#a6e22e">degToRad</span>(<span style="color:#a6e22e">slope</span>)]}
</span></span><span style="display:flex;"><span>      &gt;
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Arrow</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">position</span><span style="color:#f92672">=</span>{[<span style="color:#f92672">-</span><span style="color:#a6e22e">lineLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">rotation</span><span style="color:#f92672">=</span>{[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, Math.<span style="color:#a6e22e">PI</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        &lt;<span style="color:#f92672">Line</span>
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{[
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">lineLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#a6e22e">lineLength</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>          ]}
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>}
</span></span><span style="display:flex;"><span>        /&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">group</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">GravityDemoScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">GravityDemo</span> /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Introduction and Motion Dynamics</title><link>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/introduction-and-motion-dynamics/</link><pubDate>Sat, 06 Dec 2025 08:30:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/introduction-and-motion-dynamics/</guid><description>&lt;p&gt;You might have played around with JavaScript animations or small
physics experiments before, but in this series we are going to take
things a step further. We will build a simplified roller coaster
simulation directly in the browser.&lt;/p&gt;
&lt;p&gt;My goal here isn’t to build some engineering-grade physics engine. I
just want to recreate the kind of coaster &lt;strong&gt;physics&lt;/strong&gt; we all know from
things like &lt;strong&gt;NoLimits Roller Coaster or other coasters in games&lt;/strong&gt;.
Nothing overly scientific, just the kind of system that behaves the
way we intuitively expect. In the end, the physics model will end up
pretty close to what &lt;strong&gt;NoLimits Roller Coaster&lt;/strong&gt; does anyway, just
without all the heavy engineering baggage.&lt;/p&gt;</description><content type="html"><![CDATA[<p>You might have played around with JavaScript animations or small
physics experiments before, but in this series we are going to take
things a step further. We will build a simplified roller coaster
simulation directly in the browser.</p>
<p>My goal here isn’t to build some engineering-grade physics engine. I
just want to recreate the kind of coaster <strong>physics</strong> we all know from
things like <strong>NoLimits Roller Coaster or other coasters in games</strong>.
Nothing overly scientific, just the kind of system that behaves the
way we intuitively expect. In the end, the physics model will end up
pretty close to what <strong>NoLimits Roller Coaster</strong> does anyway, just
without all the heavy engineering baggage.</p>
<p>We will use technologies that are easy to access and quick to
experiment with. Throughout the series, we will rely on
<strong>TypeScript</strong>, <strong>React</strong> and <strong>THREE.js</strong>. This combination gives us
a clean developer experience and allows us to turn mathematical
concepts into visual, interactive 3D scenes with very little overhead.</p>
<p>The idea behind this series is simple. Instead of reading theory
first, we will learn by building something fun. Each chapter focuses
on a single concept. By the end, you will understand how a small
coaster car can move along a track, how the track itself is defined,
and how everything is drawn in the browser.</p>
<h2 id="setting-up-the-project">Setting up the project</h2>
<p>Before we start, I’ll assume you already have <strong>Node.js</strong> installed.
If not, go ahead and download it first.</p>
<p>Also, a quick heads-up: if some of the scripts or tools I’m covering
here don’t work on Windows, I’m sorry. There are ways to get a similar
environment on <strong>Windows</strong>, for example, using <strong>WSL</strong>, but I’m not a
<strong>Windows</strong> user, so I can’t really help there. I’m focusing on
<strong>Linux</strong> and <strong>macOS</strong>, where the toolchains are very similar.</p>
<p>We’ll keep things simple. You can set up your stack, however, you
like, but for this series I’ll just use <strong>Create React App</strong> with
<strong>TypeScript</strong> and won’t bother with any extra tooling. The goal here
is to explain the concepts, not to demonstrate how to engineer a
perfectly structured project. That’s a whole different topic.</p>
<p>If you want to overengineer it, go for it. But for now, something as
basic as this is completely fine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npx create-react-app roller-coaster-simulation --template typescript
</span></span></code></pre></div><p>Next, install a few useful dependencies. This is all we need for now.
If I end up using another package later in the series and forgot to
list it here, feel free to install it when you get to that part:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm i leva three lodash @react-three/drei @react-three/fiber @types/three @types/lodash
</span></span></code></pre></div><blockquote>
<p><strong>Important note:</strong> In every article, I show example code. These
code files live in the <strong>same repository</strong> that powers this
<strong>blog</strong>. The blog itself is a repository, and all chapters, demos,
and examples live there together.</p>
<p>The repository contains a <strong>shared</strong> collection of scripts used
across multiple articles, such as <strong>camera setup, wireframe helpers,
and scene utilities</strong>. Code that is specific to a chapter usually
lives <strong>close to that chapter</strong>, while common pieces are shared.</p>
<p>Because of this, you may occasionally see functionality being used
before it is explicitly introduced in the text. <strong>If something looks
unfamiliar, clone the repository, run the examples, and follow the
imports to see how things are implemented</strong>. Some parts of the
codebase intentionally exist a bit ahead of the articles to keep
later iterations simpler.</p></blockquote>
<h2 id="motion-dynamics">Motion Dynamics</h2>
<p>At the end of the day, simulating a roller coaster comes down to one
simple question:</p>
<p><strong>How much distance should the coaster travel in each simulation
step?</strong></p>
<p>To keep things simple, let’s assume our simulation updates roughly
every <strong>16 ms</strong>, which is what you would get at about 60 FPS. So the
question becomes:</p>
<p><strong>How far does the coaster need to travel within these 16 ms?</strong></p>
<p>To answer this, we follow a very straightforward chain of logic:</p>
<ul>
<li><strong>To know the distance to travel, we first need the velocity</strong></li>
<li><strong>To know the velocity, we first need the acceleration</strong></li>
</ul>
<p>So everything begins with acceleration. Acceleration changes the
velocity, <strong>velocity determines the distance to travel</strong>, and the
distance to travel tells us where the coaster ends up in the next 16
ms.</p>
<p>This gives us a simple structure:</p>
<blockquote>
<p>Acceleration → Velocity → Distance</p></blockquote>
<p>Once we understand the acceleration acting on the coaster, the rest
follows naturally.</p>
<p>In the next chapter, we will take the first real step of the
simulation and answer the core question: <a href="https://ercanakyuerek.de/posts/writing-a-roller-coaster-simulation/gravity/">How do we determine the
acceleration of the
coaster?</a></p>
]]></content></item><item><title>JavaScript module</title><link>https://ercanakyuerek.de/posts/wasi/javascript-module/</link><pubDate>Mon, 27 Feb 2023 17:45:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/javascript-module/</guid><description>&lt;p&gt;This is the point where we start writing the &lt;strong&gt;JavaScript&lt;/strong&gt; side of
the library that talks to our &lt;strong&gt;WebAssembly&lt;/strong&gt; module.&lt;/p&gt;
&lt;p&gt;At this stage, the WebAssembly part already exists and exposes a
couple of useful functions. What we need now is a small JavaScript
wrapper that loads the module, wires things together, and gives us a
nicer API to work with.&lt;/p&gt;
&lt;p&gt;I have created a very basic template for this. You may notice that we
define a number of imports for &lt;strong&gt;WASI&lt;/strong&gt;, but all of them are empty.
This looks suspicious at first, so let us talk about that.&lt;/p&gt;</description><content type="html"><![CDATA[<p>This is the point where we start writing the <strong>JavaScript</strong> side of
the library that talks to our <strong>WebAssembly</strong> module.</p>
<p>At this stage, the WebAssembly part already exists and exposes a
couple of useful functions. What we need now is a small JavaScript
wrapper that loads the module, wires things together, and gives us a
nicer API to work with.</p>
<p>I have created a very basic template for this. You may notice that we
define a number of imports for <strong>WASI</strong>, but all of them are empty.
This looks suspicious at first, so let us talk about that.</p>
<p><strong>WASI</strong> is an attempt to define a standard interface similar to
<strong>POSIX</strong>, but for WebAssembly. The idea is that the same WebAssembly
module can run in different environments, such as browsers or native
runtimes, while still having access to things like the file system or
environment variables.</p>
<p>In our case, we do not need any of that. Our library only performs
calculations. There is no file system access, no I/O, and no real
interaction with the outside world. Because of that, we can provide
empty implementations for all required WASI functions and move on.</p>
<p>Some people may argue that using <strong>Emscripten</strong> instead of the <strong>WASI
SDK</strong> would make things easier. That is probably true today. Still, I
believe that <strong>WASI</strong> is the direction things are moving toward. The
binaries are smaller, the setup is simpler, and there is less magic
involved.</p>
<p>There are ongoing efforts to make standard WASI runtimes work directly
in the browser. Unfortunately, at the time of writing, this still
requires instantiating the WebAssembly module inside a <strong>worker</strong>. If
this ever changes, I will update this article.</p>
<p>For reference, <a href="https://github.com/wasmerio/wasmer-js">this project</a>
is one such attempt to bring a WASI runtime to the browser. And if you
somehow manage to load a WASM file with full WASI support outside of a
worker, feel free to email me. I would genuinely like to see that.</p>
<h2 id="instantiate-a-module">Instantiate a module</h2>
<p>We start with a bit of boilerplate code in <code>index.ts</code> to load and
instantiate the WebAssembly module:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-typescript" data-lang="typescript"><span style="display:flex;"><span><span style="color:#75715e">// @ts-ignore
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">glue</span> <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;./glue.wasm&#39;</span>;
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">module</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">compileStreaming</span>(<span style="color:#a6e22e">fetch</span>(<span style="color:#a6e22e">glue</span>));
</span></span></code></pre></div>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">instance</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> <span style="color:#a6e22e">WebAssembly</span>.<span style="color:#a6e22e">instantiate</span>(<span style="color:#a6e22e">module</span>, {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">wasi_snapshot_preview1</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">environ_get</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">environ_sizes_get</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_close</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_fdstat_get</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_read</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_write</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">proc_exit</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_seek</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_fdstat_set_flags</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_prestat_get</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fd_prestat_dir_name</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">path_open</span><span style="color:#f92672">:</span> () <span style="color:#f92672">=&gt;</span> {},
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div>
<p>We will talk about memory later, especially linear memory. For now, we
can already start wrapping exported WebAssembly functions.</p>
<p>We begin with a basic one: <code>bezierTotalArcLength</code>. We grab the
function from <code>instance.exports</code> and call it with a pointer to a
Bézier curve. Since the function returns a single float, there is
nothing special to do here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezierTotalArcLength</span> <span style="color:#f92672">=</span> (<span style="color:#a6e22e">bezierPointer</span>: <span style="color:#66d9ef">number</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">bezierTotalArcLength</span>: <span style="color:#66d9ef">func</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">bezierPointer</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Next is a slightly more interesting function:
<code>bezierPositionAtArcLength</code>.</p>
<p>This function also lives in the exports and takes a Bezier pointer
plus a distance. The difference is that it returns a pointer to a <strong>3D
vector</strong> instead of a plain number.</p>
<p>A 3D vector here is just three <code>float</code> values laid out next to each
other in linear memory. Because these are <code>32-bit</code> floats, we use a
<code>Float32Array</code> to read them back. The pointer returned from
WebAssembly is simply an offset into the memory buffer.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezierPositionAtArcLength</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bezierPointer</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">at</span>: <span style="color:#66d9ef">number</span>,
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">bezierPositionAtArcLength</span>: <span style="color:#66d9ef">func</span>, <span style="color:#a6e22e">memory</span> } <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">positionPointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">bezierPointer</span>, <span style="color:#a6e22e">at</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">positionPointer</span>, <span style="color:#ae81ff">3</span>);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<p>Now we reach a more involved function: <code>bezierFromPoints</code>.</p>
<p>This function takes four control points, each represented as a 3D
vector. That means we need to pass <code>4 × 3</code> floats to WebAssembly. Each
float is <code>32-bit</code>, so we are dealing with <code>48 bytes</code> of memory in
total.</p>
<p>There are multiple ways to handle this. We could allocate one block of
<code>48 bytes</code>, or we could allocate memory for each point individually.
For now, we do the latter and call <code>malloc</code> four times with <code>12 bytes</code>
each.</p>
<p>This is not perfect. There are limitations and edge cases here. That
is fine for now. We will improve this later once things get more
serious.</p>
<p>On the JavaScript side, we allocate memory, write the coordinates into
linear memory, and then pass the pointers to the WebAssembly function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ts" data-lang="ts"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezierFromPoints</span> <span style="color:#f92672">=</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p0</span>: <span style="color:#66d9ef">number</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p1</span>: <span style="color:#66d9ef">number</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p2</span>: <span style="color:#66d9ef">number</span>[],
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">p3</span>: <span style="color:#66d9ef">number</span>[],
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">bezierFromPoints</span>: <span style="color:#66d9ef">func</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">malloc</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memory</span>,
</span></span><span style="display:flex;"><span>  } <span style="color:#f92672">=</span> <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">exports</span> <span style="color:#66d9ef">as</span> <span style="color:#66d9ef">any</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointers</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">p0</span>, <span style="color:#a6e22e">p1</span>, <span style="color:#a6e22e">p2</span>, <span style="color:#a6e22e">p3</span>].<span style="color:#a6e22e">map</span>((<span style="color:#a6e22e">point</span>) <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">pointer</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>); <span style="color:#75715e">// (x, y, z) * 4 bytes
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float32Array</span>(<span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">buffer</span>, <span style="color:#a6e22e">pointer</span>, <span style="color:#ae81ff">3</span>).<span style="color:#66d9ef">set</span>(<span style="color:#a6e22e">point</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">pointer</span>;
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">func</span>(<span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">0</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">1</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">2</span>], <span style="color:#a6e22e">pointers</span>[<span style="color:#ae81ff">3</span>]);
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>
<h1 id="demo">Demo</h1>
<p>To make this less abstract, there is an interactive demo where you can
drag control points around and see the Bezier calculations happen
inside the WebAssembly module.</p>
      

<div class="embedded ">
  <iframe
    id="react-root-bd1f9482a92ce7940f36d3c0bbab5e9d"
    width="100%"
    height="360px"
    class="frame"
  ></iframe>

  

  <script>
    document.getElementById('react-root-bd1f9482a92ce7940f36d3c0bbab5e9d').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/wasi\/javascript-module\/WasiLibraryExampleScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<h2 id="conclusion">Conclusion</h2>
<p>That is it for now.</p>
<p>We have not covered everything yet. Passing strings, logging, more
complex data structures, and proper memory management are all still
missing. But at this point, you should have a reasonable idea of how
JavaScript and WebAssembly talk to each other.</p>
<p>To be honest, writing glue code like this is not particularly fun. It
usually means writing code twice: once in C++ and once again in
JavaScript to serialize and deserialize arguments. There are tools
that try to automate this, but for small, performance-critical
libraries, doing it manually is still a very common approach.</p>
<p>In the next articles, we will dig deeper into memory, data types, and
better bindings.</p>
<h1 id="demo-code">Demo code</h1>
<p>
    If you want to run the code locally, clone this
    <a href="https://github.com/geforcefan/ercanakyuerek.de" target="_blank">repository</a>,
    run <code>npm install</code> and <code>npm run dev-scripts</code>,
    then open this
    <a href="http://localhost:3000/src/content/posts/wasi/javascript-module/WasiLibraryExampleScene.tsx" target="_blank">link</a>
    in your browser.
</p><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tsx" data-lang="tsx"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">React</span>, { <span style="color:#a6e22e">useMemo</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;react&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Line</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;@react-three/drei&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">Vector3</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;three&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">uniformSampleMap</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../helper/uniform-sample&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">useColors</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../hooks/useColors&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">DragControlPoints</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/curve/DragControlPoints&#39;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> { <span style="color:#a6e22e">OrthographicScene</span> } <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../components/scenes/OrthographicScene&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">import</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bezierFromPoints</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bezierPositionAtArcLength</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bezierTotalArcLength</span>,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">from</span> <span style="color:#e6db74">&#39;../../../../libs/calculation&#39;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">export</span> <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">WasiLibraryExampleScene</span> <span style="color:#f92672">=</span> () <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">colors</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useColors</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> [<span style="color:#a6e22e">points</span>, <span style="color:#a6e22e">setPoints</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">React</span>.<span style="color:#a6e22e">useState</span>([
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">3</span>, <span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>  ]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">nodes</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">useMemo</span>(() <span style="color:#f92672">=&gt;</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#a6e22e">bezier</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">bezierFromPoints</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">toArray</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">1</span>].<span style="color:#a6e22e">toArray</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">2</span>].<span style="color:#a6e22e">toArray</span>(),
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">points</span>[<span style="color:#ae81ff">3</span>].<span style="color:#a6e22e">toArray</span>(),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">uniformSampleMap</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">bezierTotalArcLength</span>(<span style="color:#a6e22e">bezier</span>),
</span></span><span style="display:flex;"><span>      <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>      (<span style="color:#a6e22e">at</span>) <span style="color:#f92672">=&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Vector3</span>().<span style="color:#a6e22e">fromArray</span>(
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">bezierPositionAtArcLength</span>(<span style="color:#a6e22e">bezier</span>, <span style="color:#a6e22e">at</span>),
</span></span><span style="display:flex;"><span>        ),
</span></span><span style="display:flex;"><span>    );
</span></span><span style="display:flex;"><span>  }, [<span style="color:#a6e22e">points</span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DragControlPoints</span> <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>} <span style="color:#a6e22e">setPoints</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">setPoints</span>} /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">highlight</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">points</span>}
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">segments</span><span style="color:#f92672">=</span>{<span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>      /&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Line</span> <span style="color:#a6e22e">color</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">colors</span>.<span style="color:#a6e22e">secondary</span>} <span style="color:#a6e22e">points</span><span style="color:#f92672">=</span>{<span style="color:#a6e22e">nodes</span>} /&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">OrthographicScene</span>&gt;
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div>

]]></content></item><item><title>Implementing library functions</title><link>https://ercanakyuerek.de/posts/wasi/implementing-library-functions/</link><pubDate>Fri, 24 Feb 2023 00:19:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/implementing-library-functions/</guid><description>&lt;div class="embedded float-right"&gt;
&lt;iframe
id="react-root-994ef715b541b5548f356319a499b717"
width="225px"
height="285px"
class="frame"
&gt;&lt;/iframe&gt;
&lt;div class="description" style="width: 225px"&gt;
Transition from parameter-based non-uniform to uniform node spacing. The control points are draggable.
&lt;/div&gt;
&lt;script&gt;
document.getElementById('react-root-994ef715b541b5548f356319a499b717').srcdoc = `
&lt;!DOCTYPE html&gt;
&lt;html lang="en" data-theme="dark"&gt;
&lt;head&gt;
&lt;base href="${location.origin}/"&gt;
&lt;/head&gt;
&lt;body class="content-component"&gt;
&lt;div id="root" class="full-screen"&gt;&lt;/div&gt;
\x3Cscript type="module"&gt;
import { renderContentComponentByPath } from '/scripts/render-content-component.js';
renderContentComponentByPath('root', '.\/posts\/wasi\/implementing-library-functions\/BezierNodesExampleScene.tsx');
&lt;\/script&gt;
&lt;/body&gt;
&lt;/html&gt;
`;
&lt;/script&gt;
&lt;/div&gt;
&lt;p&gt;In this article, we&amp;rsquo;ll be exploring a more interesting example where
we&amp;rsquo;ll construct a Bézier curve, evaluate nodes on it, and write a
function that gives any position on the curve by a length parameter.
To explain briefly, a Bézier curve is represented by a parameter &lt;code&gt;t&lt;/code&gt;,
which varies between 0 and 1 and determines the position of nodes on
the curve. However, this &lt;code&gt;t&lt;/code&gt; value doesn&amp;rsquo;t produce uniform spacing,
which is problematic when we want to evaluate a point on the curve
based on its distance. To solve this, we can evaluate some nodes along
the curve with known distances and then linearly interpolate new nodes
between them to find the point we&amp;rsquo;re looking for.&lt;/p&gt;</description><content type="html"><![CDATA[      

<div class="embedded float-right">
  <iframe
    id="react-root-994ef715b541b5548f356319a499b717"
    width="225px"
    height="285px"
    class="frame"
  ></iframe>

  
  <div class="description" style="width: 225px">
    Transition from parameter-based non-uniform to uniform node spacing. The control points are draggable.
  </div>
  

  <script>
    document.getElementById('react-root-994ef715b541b5548f356319a499b717').srcdoc = `
    <!DOCTYPE html>
    <html lang="en" data-theme="dark">
      <head>
          <base href="${location.origin}/">
      </head>
        <body class="content-component">
        <div id="root" class="full-screen"></div>
        \x3Cscript type="module">
          import { renderContentComponentByPath } from '/scripts/render-content-component.js';
          renderContentComponentByPath('root', '.\/posts\/wasi\/implementing-library-functions\/BezierNodesExampleScene.tsx');
        <\/script>
      </body>
    </html>
  `;
  </script>
</div>

<p>In this article, we&rsquo;ll be exploring a more interesting example where
we&rsquo;ll construct a Bézier curve, evaluate nodes on it, and write a
function that gives any position on the curve by a length parameter.
To explain briefly, a Bézier curve is represented by a parameter <code>t</code>,
which varies between 0 and 1 and determines the position of nodes on
the curve. However, this <code>t</code> value doesn&rsquo;t produce uniform spacing,
which is problematic when we want to evaluate a point on the curve
based on its distance. To solve this, we can evaluate some nodes along
the curve with known distances and then linearly interpolate new nodes
between them to find the point we&rsquo;re looking for.</p>
<p>While this is a specific example, it involves &ldquo;complex&rdquo; types such as
custom structs and 3D vectors that will need to be accessed from a web
browser. So it should serve as a useful case for testing our library
&#x1f604;</p>
<h2 id="adding-a-third-party-library">Adding a third party library</h2>
<p>I mentioned 3D vectors, so there is a well-known library called <code>glm</code>.
I know that this is an overkill library for our &ldquo;simple&rdquo; problem, but
it serves the purpose of showing how to add other libraries to our
project. Ideally, the 3rd party library also has a CMake ecosystem.
Otherwise, we need to be creative, fortunately. <code>glm</code> provides CMake
files. My approach is to add a git submodule into the root directory
by calling:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git submodule add https://github.com/g-truc/glm.git
</span></span></code></pre></div><p>We must include the glm directory as an include in our root
<code>CMakeList.txt</code>, as the glm library is a header-only library and does
not need to be linked against anything:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>include_directories(<span style="color:#e6db74">glm</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><h2 id="bezier-implementation">Bezier implementation</h2>
<p>In summary, I have developed a solution for the problem discussed
earlier, but I won&rsquo;t delve too deeply into the technical details. The
primary function of my implementation, <code>bezier_fast</code>, computes the
position on a bezier curve based on a given <code>t</code> parameter.
Additionally, <code>estimate_total_arc_length</code> is used to estimate the
curve&rsquo;s total arc length very quickly with a <strong>low step size</strong>. This
estimation is necessary to determine how many nodes we should
evaluate. With this method, we can create densely populated nodes
depending on the curve&rsquo;s total arc length. The evaluate function
executes the procedure I just described. Naturally, we can always
measure the distance between the evaluated position and the previous
one to obtain the curve&rsquo;s total arc length, which we simply pass
through the <code>total_arc_length</code> function. Lastly,
<code>position_at_arc_length</code> searches for the minimum node at a specified
distance and linearly interpolates the position to the next node. We
have successfully achieved the ability to evaluate uniformly spaced
points on the curve.</p>
<p><code>src/bezier.cc:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;bezier.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/geometric.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> bezier<span style="color:#f92672">::</span>evaluate() {
</span></span><span style="display:flex;"><span>    nodes.clear();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> numberOfNodes <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(estimate_total_arc_length() <span style="color:#f92672">*</span> <span style="color:#ae81ff">20.0f</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>numberOfNodes) <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> arcLength <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> numberOfNodes; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) i <span style="color:#f92672">/</span> (<span style="color:#66d9ef">float</span>) (numberOfNodes <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 position <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        arcLength <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(position, lastPos);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        nodes.push_back({
</span></span><span style="display:flex;"><span>            .position <span style="color:#f92672">=</span> position,
</span></span><span style="display:flex;"><span>            .arcLength <span style="color:#f92672">=</span> arcLength
</span></span><span style="display:flex;"><span>        });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> position;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 bezier<span style="color:#f92672">::</span>bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> t1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.0f</span><span style="color:#f92672">-</span>t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b0 <span style="color:#f92672">=</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> t1 <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> b3 <span style="color:#f92672">=</span> t <span style="color:#f92672">*</span> t <span style="color:#f92672">*</span> t;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> b0 <span style="color:#f92672">*</span> p0  <span style="color:#f92672">+</span> b1 <span style="color:#f92672">*</span> p1 <span style="color:#f92672">+</span> b2 <span style="color:#f92672">*</span> p2 <span style="color:#f92672">+</span> b3 <span style="color:#f92672">*</span> p3;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> bezier<span style="color:#f92672">::</span>estimate_total_arc_length() {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 lastPos <span style="color:#f92672">=</span> cp1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> totalArcLength <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">15</span>; i<span style="color:#f92672">+=</span> <span style="color:#ae81ff">2</span>) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">float</span> t <span style="color:#f92672">=</span> (<span style="color:#66d9ef">float</span>) (i) <span style="color:#f92672">/</span> <span style="color:#ae81ff">14.0f</span>;
</span></span><span style="display:flex;"><span>        glm<span style="color:#f92672">::</span>vec3 pos <span style="color:#f92672">=</span> bezier_fast(cp1, cp2, cp3, cp4, t);
</span></span><span style="display:flex;"><span>        totalArcLength <span style="color:#f92672">+=</span> glm<span style="color:#f92672">::</span>distance(pos, lastPos);
</span></span><span style="display:flex;"><span>        lastPos <span style="color:#f92672">=</span> pos;
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> totalArcLength;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 bezier<span style="color:#f92672">::</span>position_at_arc_length(<span style="color:#66d9ef">float</span> at) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nodes.size() <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>) <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>vec3(<span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> nextNode <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>lower_bound(nodes.begin(), nodes.end(), at, [](<span style="color:#66d9ef">auto</span> a, <span style="color:#66d9ef">double</span> value) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">bool</span> { <span style="color:#66d9ef">return</span> a.arcLength <span style="color:#f92672">&lt;</span> value; });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> currentNode <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isFirst <span style="color:#f92672">=</span> nextNode <span style="color:#f92672">==</span> nodes.begin();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> isLast <span style="color:#f92672">=</span> currentNode <span style="color:#f92672">==</span> nodes.end();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isFirst) <span style="color:#66d9ef">return</span> nodes[<span style="color:#ae81ff">0</span>].position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isLast) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].position;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> t <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (nextNode<span style="color:#f92672">-&gt;</span>arcLength <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>arcLength <span style="color:#f92672">&gt;</span> std<span style="color:#f92672">::</span>numeric_limits<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">double</span><span style="color:#f92672">&gt;::</span>epsilon()) {
</span></span><span style="display:flex;"><span>        t <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>max(std<span style="color:#f92672">::</span>min((at <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>arcLength) <span style="color:#f92672">/</span> (nextNode<span style="color:#f92672">-&gt;</span>arcLength <span style="color:#f92672">-</span> currentNode<span style="color:#f92672">-&gt;</span>arcLength), <span style="color:#ae81ff">1.0f</span>), <span style="color:#ae81ff">0.0f</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> glm<span style="color:#f92672">::</span>mix(currentNode<span style="color:#f92672">-&gt;</span>position, nextNode<span style="color:#f92672">-&gt;</span>position, t);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> bezier<span style="color:#f92672">::</span>total_arc_length() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>nodes.empty()) <span style="color:#66d9ef">return</span> nodes[nodes.size() <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>].arcLength;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>src/bezier.h:</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#75715e">#ifndef LIBCALCULATION_BEZIER_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LIBCALCULATION_BEZIER_H
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;glm/vec3.hpp&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;vector&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">node</span> {
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 position;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> arcLength;
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">bezier</span> {
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    bezier(<span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp1, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp2, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp3, <span style="color:#66d9ef">const</span> glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">&amp;</span>cp4) <span style="color:#f92672">:</span> cp1(cp1),
</span></span><span style="display:flex;"><span>                                                                                                     cp2(cp2),
</span></span><span style="display:flex;"><span>                                                                                                     cp3(cp3),
</span></span><span style="display:flex;"><span>                                                                                                     cp4(cp4) {
</span></span><span style="display:flex;"><span>        evaluate();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 position_at_arc_length(<span style="color:#66d9ef">float</span> distance);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">total_arc_length</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
</span></span><span style="display:flex;"><span>    glm<span style="color:#f92672">::</span>vec3 cp1, cp2, cp3, cp4;
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>vector<span style="color:#f92672">&lt;</span>node<span style="color:#f92672">&gt;</span> nodes;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> glm<span style="color:#f92672">::</span>vec3 bezier_fast(glm<span style="color:#f92672">::</span>vec3 p0, glm<span style="color:#f92672">::</span>vec3 p1, glm<span style="color:#f92672">::</span>vec3 p2, glm<span style="color:#f92672">::</span>vec3 p3, <span style="color:#66d9ef">float</span> t);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> <span style="color:#a6e22e">estimate_total_arc_length</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">evaluate</span>();
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">//LIBCALCULATION_BEZIER_H
</span></span></span></code></pre></div><h2 id="gluing-the-pieces-of-our-library">Gluing the Pieces of our library</h2>
<p>We still cannot use the functions yet, so we need to create glue code
to expose them to the outside world. Our goal is to use this bezier
library in our browser, for example, to draw a uniformly spaced Bezier
curve. We will expose three functions: <code>bezierFromPoints</code>,
<code>bezierPositionAtArcLength</code>, and <code>bezierTotalArcLength</code>. Some of these
functions return complex types, such as a <code>3D vector</code>, which we will
handle on the JavaScript side. There are many techniques to pass
complex data from and to our WebAssembly module, which we will discuss
in detail later. For now, let&rsquo;s focus on creating some glue code in
<code>glue/glue.cc</code>.</p>
<h3 id="data-types">Data types</h3>
<p>As mentioned several times before, passing complex data types in and
out can be challenging, but it can be managed. Passing 32 and 64 bit
integers and decimal numbers is natively supported, so there is no
need to worry about those. However, passing types such as a
<code>3D vector</code> is a different matter. We need to allocate memory on the
JavaScript side, assign the <code>3D vector</code> data (3x <code>floats</code>) to a free
memory space, and pass the location (pointer) to the function calls.
If we return complex data from the WebAssembly module, we will get a
pointer and access the data in memory and &ldquo;demangle&rdquo; it (for example,
using <code>Float64Array</code> with the pointer as offset and length of 3 to
access x, y, z data). We will delve deeper into this later.</p>
<h3 id="bezierfrompoints-function">bezierFromPoints function</h3>
<p>This is a straightforward process. We replicate the original
constructor and expose this new function using the
<code>attribute((export_name(&quot;bezierFromPoints&quot;)))</code> attribute to make it
available to the outside world. As shown, we return a pointer, which
will be a number on the JavaScript side and can be used to access
memory data later. To ensure that we can access the data of the 3d
vector in memory on the JavaScript side, it is crucial that the
parameters of the vector are also pointers. This is because we
allocate memory on the JavaScript side and assign our vector data to
that memory location.:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;bezierFromPoints&#34;</span>)))
</span></span><span style="display:flex;"><span>bezier <span style="color:#f92672">*</span>bezierFromPoints(glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp1, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp2, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp3, glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>cp4) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">bezier</span>(<span style="color:#f92672">*</span>cp1, <span style="color:#f92672">*</span>cp2, <span style="color:#f92672">*</span>cp3, <span style="color:#f92672">*</span>cp4);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="beziertotalarclength-function">bezierTotalArcLength function</h3>
<p>This function returns a <code>float</code>, so no need to handle any extra
complex data stuff on the JavaScript side:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;bezierTotalArcLength&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> bezierTotalArcLength(bezier <span style="color:#f92672">*</span>s) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> s<span style="color:#f92672">-&gt;</span>total_arc_length();
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="bezierpositionatarclength-function">bezierPositionAtArcLength function</h3>
<p>This function returns a pointer to a <code>3d vector</code>, which allows us to
access its data in memory on the <code>JavaScript</code> side. Therefore, we need
to allocate a new space for the returned <code>3d vector</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;bezierPositionAtArcLength&#34;</span>)))
</span></span><span style="display:flex;"><span>glm<span style="color:#f92672">::</span>vec3 <span style="color:#f92672">*</span>bezierPositionAtArcLength(bezier <span style="color:#f92672">*</span>s, <span style="color:#66d9ef">float</span> at) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> glm<span style="color:#f92672">::</span>vec3(s<span style="color:#f92672">-&gt;</span>position_at_arc_length(at));
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="malloc">malloc</h3>
<p>I understand that this may not be the most optimal approach for memory
allocation, but it is currently working for my purposes. I may
consider revising my implementation at a later time, but for now, we
can utilize the <code>malloc</code> function from the <code>JavaScript</code> side. This is
necessary for allocating memory to data that we want to pass to the
<code>WebAssembly</code> functions, such as <code>3D vectors</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>__attribute__((export_name(<span style="color:#e6db74">&#34;malloc&#34;</span>)))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>allocateMemory(size_t size) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">malloc</span>(size);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="build">Build</h2>
<p>At this point, you can run a build by executing <code>npm run build</code>. It
should compile without any errors. In the next section, we will create
a small <code>JavaScript</code> module that initializes the <code>WebAssembly</code> module,
wraps the exposed functions, and handles incoming and outgoing data
types. This <code>JavaScript</code> module can be used in your project just like
any other <code>ES6 module</code>.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/javascript-module/">Now, let&rsquo;s create a small JavaScript module that will be responsible
for creating a WebAssembly module, loading our Wasm file, defining
some imports for WASI (which will mostly be empty), and creating
functions for those that we exported in our C++ glue
code.</a></p>
]]></content></item><item><title>CMake and build scripts</title><link>https://ercanakyuerek.de/posts/wasi/cmake-and-build-scripts/</link><pubDate>Thu, 23 Feb 2023 23:15:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/cmake-and-build-scripts/</guid><description>&lt;p&gt;To simplify the building process, we can create a build script. We
have already defined some scripts in our &lt;code&gt;package.json&lt;/code&gt; file. At this
point, the &lt;code&gt;build-wasm.js&lt;/code&gt; file is still empty, so we can create a
basic script that first deletes an existing &lt;code&gt;build&lt;/code&gt; folder, creates a
new one, and runs &lt;code&gt;cmake ..&lt;/code&gt; inside it. We will be using a WASI-SDK
docker image from &lt;code&gt;ghcr.io/webassembly/wasi-sdk&lt;/code&gt; to run cmake and
eventually compile the project via &lt;code&gt;make&lt;/code&gt;.&lt;/p&gt;</description><content type="html"><![CDATA[<p>To simplify the building process, we can create a build script. We
have already defined some scripts in our <code>package.json</code> file. At this
point, the <code>build-wasm.js</code> file is still empty, so we can create a
basic script that first deletes an existing <code>build</code> folder, creates a
new one, and runs <code>cmake ..</code> inside it. We will be using a WASI-SDK
docker image from <code>ghcr.io/webassembly/wasi-sdk</code> to run cmake and
eventually compile the project via <code>make</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">rm</span>, <span style="color:#a6e22e">mkdir</span>, <span style="color:#a6e22e">exec</span>, <span style="color:#a6e22e">cp</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;shelljs&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">join</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;path&#39;</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> { <span style="color:#a6e22e">compileOnly</span>, <span style="color:#a6e22e">run</span> } <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#39;args-parser&#39;</span>)(<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">argv</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">paths</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">build</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#39;build&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueSource</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#39;build&#39;</span>, <span style="color:#e6db74">&#39;glue&#39;</span>, <span style="color:#e6db74">&#39;glue&#39;</span>),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">glueDestination</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">join</span>(<span style="color:#a6e22e">__dirname</span>, <span style="color:#e6db74">&#39;glue.wasm&#39;</span>),
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">compileOnly</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#39;-rf&#39;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">rm</span>(<span style="color:#e6db74">&#39;-rf&#39;</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mkdir</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">build</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk:wasi-sdk-19 cmake -DCMAKE_BUILD_TYPE=Release ..&#39;</span>,
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">exec</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#39;docker run -v `pwd`:/wasi -w /wasi/build ghcr.io/webassembly/wasi-sdk:wasi-sdk-19 make -j 10&#39;</span>,
</span></span><span style="display:flex;"><span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">cp</span>(<span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueSource</span>, <span style="color:#a6e22e">paths</span>.<span style="color:#a6e22e">glueDestination</span>);
</span></span></code></pre></div><p>We will provide CMake directives for automatically adding all <code>*.cc</code>
files in the <code>glue</code> and <code>src</code> directories. If you prefer using the
<code>.cpp</code> extension instead, feel free to modify the files accordingly.
We will also ensure that we build a static library by using the
<code>STATIC</code> keyword in the add_library function. Therefore, the content
of the <code>src/CMakeLists.txt</code> file is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#e6db74">STATIC</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_library(<span style="color:#e6db74">calculation::calculation</span> <span style="color:#e6db74">ALIAS</span> <span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>The <code>glue/CMakeLists.txt</code> file will slightly differ from the one in
<code>src</code>. As mentioned earlier, <code>glue</code> will serve as the final
WebAssembly &ldquo;application&rdquo; that statically links our <code>calculation</code>
library and exposes manually exported functions. We&rsquo;ll need to handle
complex data types such as <code>vectors</code> and <code>structs</code>, but we&rsquo;ll cover
that in the next chapters. For now, it&rsquo;s important to understand that
<code>glue</code> is essentially our end product that links to our <code>calculation</code>
library:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>project(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_SOURCES</span> <span style="color:#e6db74">*.cc</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>file(<span style="color:#e6db74">GLOB_RECURSE</span> <span style="color:#e6db74">SRC_HEADERS</span> <span style="color:#e6db74">*.h</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_executable(<span style="color:#f92672">${</span>PROJECT_NAME<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_SOURCES<span style="color:#f92672">}</span> <span style="color:#f92672">${</span>SRC_HEADERS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>target_link_libraries(<span style="color:#e6db74">glue</span> <span style="color:#e6db74">calculation::calculation</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Now we need to bring everything together in the <code>CMakeList.txt</code> file
in our root directory, which basically means adding the directories
<code>glue</code> and <code>src</code>, setting some optimization flags for release mode,
and disabling exceptions for WASI since exceptions are currently not
supported by WASI-SDK. Here&rsquo;s what the file should look like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cmake" data-lang="cmake"><span style="display:flex;"><span>cmake_minimum_required (<span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">3.9</span> <span style="color:#e6db74">FATAL_ERROR</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>project (<span style="color:#e6db74">CALCULATION</span> <span style="color:#e6db74">LANGUAGES</span> <span style="color:#e6db74">CXX</span> <span style="color:#e6db74">VERSION</span> <span style="color:#e6db74">0.1.0</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD</span> <span style="color:#e6db74">14</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#e6db74">ON</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>set(<span style="color:#e6db74">CMAKE_CXX_FLAGS_RELEASE</span> <span style="color:#e6db74">&#34;-O3&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Disable exceptions
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>if (<span style="color:#e6db74">CMAKE_SYSTEM_NAME</span> <span style="color:#e6db74">STREQUAL</span> <span style="color:#e6db74">&#34;WASI&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    string(<span style="color:#e6db74">REGEX</span> <span style="color:#e6db74">REPLACE</span> <span style="color:#e6db74">&#34;-fexceptions&#34;</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#f92672">${</span>CMAKE_CXX_FLAGS<span style="color:#f92672">}</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>    set(<span style="color:#e6db74">CMAKE_CXX_FLAGS</span> <span style="color:#e6db74">&#34;${CMAKE_CXX_FLAGS} -fno-exceptions&#34;</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>endif()<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>include_directories(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">src</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span>add_subdirectory(<span style="color:#e6db74">glue</span>)<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>To test our setup, we need to add a main function to the file
<code>glue/glue.cc</code>. The files <code>bezier.cc</code> and <code>bezier.h</code> can remain empty
for now as they are not necessary to test our setup:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {}
</span></span></code></pre></div><p>Finally, we can run our build script and see what happens &#x1f604;. To
run the build script, simply execute <code>npm run build</code>. After it
finishes executing, there should be a newly created file in the root
directory named <code>glue.wasm</code>, which confirms that our setup is correct.
However, this file does not have any functionality at the moment, <a href="https://ercanakyuerek.de/posts/wasi/implementing-library-functions/">but
that will change in the next
chapter.</a></p>
]]></content></item><item><title>Folder structure</title><link>https://ercanakyuerek.de/posts/wasi/folder-structure/</link><pubDate>Thu, 23 Feb 2023 22:00:00 +0100</pubDate><guid>https://ercanakyuerek.de/posts/wasi/folder-structure/</guid><description>&lt;p&gt;You may have already heard that it&amp;rsquo;s possible to write certain parts
of your web application using languages like C++ or Rust and compile
them into WebAssembly. WebAssembly is a binary format that allows code
to be executed on the web and is designed to be efficient, secure, and
portable. There are use cases where WebAssembly can be particularly
beneficial, such as performing complex and resource-intensive
computations for real-time applications or mathematical operations.&lt;/p&gt;</description><content type="html"><![CDATA[<p>You may have already heard that it&rsquo;s possible to write certain parts
of your web application using languages like C++ or Rust and compile
them into WebAssembly. WebAssembly is a binary format that allows code
to be executed on the web and is designed to be efficient, secure, and
portable. There are use cases where WebAssembly can be particularly
beneficial, such as performing complex and resource-intensive
computations for real-time applications or mathematical operations.</p>
<p>As of the time of writing this article in 2023, there are available
bindings for Rust programming language. However, when it comes to
<code>C++</code>, I was not able to find any mature solution except for the
<a href="https://emscripten.org/docs/porting/connecting_cpp_and_javascript/WebIDL-Binder.html">WebIDL Binder for Emscripten</a>.
Unfortunately, my experience with it did not produce satisfactory
results. Perhaps in the future, I will explore other binding solutions
and update this series of articles. For now, we will have to manually
glue our code. This involves creating bindings to enable the exchange
of complex data between WebAssembly modules and exposing functions.</p>
<h2 id="using-webassembly-as-a-regular-javascript-module">Using WebAssembly as a Regular JavaScript Module</h2>
<p>This is a crucial aspect that I wish to explore. I want to write parts
of my application in C++ and use them as regular modules in
JavaScript. As previously mentioned, there is no NPM infrastructure
available for compiling or generating bindings that can produce
JavaScript files that export modules with exposed C++ functions. In
this series, we will construct a minimalist infrastructure that
emulates familiar module structures.</p>
<h2 id="building-an-example-library-for-computing-bézier-curves">Building an Example Library for Computing Bézier curves</h2>
<p>For this article, we will create a very minimalistic library for
computing bezier curves. We will set up this project in a way that the
library can be used in a regular C++ application, as well as in a web
application.</p>
<h2 id="prerequisites">Prerequisites</h2>
<p>Please ensure that you have installed both <code>Node.js</code> and <code>Docker</code> on
your computer. We will utilize the WASI-SDK Docker image for
constructing the WebAssembly library.</p>
<h2 id="project-structure">Project structure</h2>
<p>First, let&rsquo;s create a folder named <code>libComputation</code> and run <code>npm init</code>
inside the folder, following the input instructions. After
initializing an npm project, replicate this folder structure and
create the following files:</p>
<pre tabindex="0"><code class="language-ls" data-lang="ls">libComputation
    glue
        CMakeLists.txt
        glue.cc
    src
        CMakeLists.txt
        bezier.cc
        bezier.h
    CMakeLists.txt
    build-wasm.js
    index.js
</code></pre><p>As you can see, this resembles a regular CMake project with
WebAssembly compilation additions. We will use <code>build-wasm.js</code> for
compilation purposes, and for that, we need to install some npm
modules for creating directories and parsing arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>npm install shelljs args-parser --save-dev
</span></span></code></pre></div><p>Now, add the following build scripts in the <code>package.json</code> file, which
we will use for different use cases:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;scripts&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;build&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;compile&#34;</span>: <span style="color:#e6db74">&#34;node build-wasm.js --compileOnly&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As you can see, there is a folder named <code>glue</code>. In this subdirectory,
we will define all exports and bindings to the WebAssembly Module, so
that all files inside the <code>src</code> folder will be free from WASI
artifacts. We have intentionally split both directories because our
goal is to use the libraries in regular desktop applications as well,
where <code>WASI SDK</code> is not used to build the library. This approach
ensures high flexibility when using the library in both the browser
and desktop environments.</p>
<p><a href="https://ercanakyuerek.de/posts/wasi/cmake-and-build-scripts/">In the next part, we will create the build script and set up the
CMake files.</a></p>
]]></content></item></channel></rss>